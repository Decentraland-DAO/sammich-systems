import { checkBoxesContact, getAbsoluteCollisionBoxFromSprite } from "./math-util";
export const createSpriteEntityFactory = ({ screen, serverRoom, clientRoom, isClientPlayer, playerIndex }) => {
    let IDCount = 1;
    const spriteEntityKlasses = new Map();
    const spriteEntities = [];
    const collisionListeners = new Map();
    let spritesStateInitialized = false;
    if (clientRoom && !isClientPlayer) {
        clientRoom.onStateChange((...args) => {
            if (!spritesStateInitialized && clientRoom.state.players[playerIndex].spriteEntities) {
                clientRoom.state.players[playerIndex].spriteEntities.onAdd((spriteState, index) => {
                    const klass = spriteState.klass;
                    const SpriteKlass = spriteEntityKlasses.get(klass);
                    const localSprite = spriteEntities.find(i => i.ID === spriteState.ID);
                    if (!localSprite) {
                        const { ID, layer, frame } = spriteState;
                        SpriteKlass?.create({
                            ID,
                            pixelPosition: [spriteState.x, spriteState.y],
                            layer,
                            network: true,
                            frame
                        });
                    }
                    spriteState.onChange((changes) => {
                        const spriteStateJSON = spriteState.toJSON();
                        const localSprite = spriteEntities.find(i => i.ID === spriteStateJSON.ID);
                        if (localSprite?.sprite && localSprite.sprite.getPixelPosition()[0] !== spriteStateJSON.x || localSprite.sprite.getPixelPosition()[1] !== spriteStateJSON.y) {
                            localSprite.setPixelPosition(spriteStateJSON.x, spriteStateJSON.y);
                        }
                        if (localSprite?.sprite && localSprite.sprite.getFrame() !== spriteStateJSON.frame) {
                            localSprite.applyFrame(spriteStateJSON.frame);
                        }
                    });
                });
                clientRoom.state.players[playerIndex].spriteEntities.onRemove((spriteState) => {
                    const localSprite = spriteEntities.find(i => i.ID === spriteState.ID);
                    localSprite?.destroy();
                });
                spritesStateInitialized = true;
            }
        });
    }
    return {
        registerSpriteEntity,
        checkColliders,
        getSpriteEntities: () => spriteEntities,
        cleanSpriteEntities: () => {
            while (spriteEntities.length)
                spriteEntities[0].destroy();
        },
        getCollisionListeners: () => collisionListeners,
        getSpriteEntityKlasses: () => spriteEntityKlasses,
        destroy: () => {
            while (spriteEntities?.length)
                spriteEntities[0].destroy();
        }
    };
    function checkColliders() {
        const colliders = spriteEntities.filter((i) => i.detectCollisions);
        colliders.forEach((colliderSpriteEntity, index) => {
            const otherColliders = colliders.filter((c) => c !== colliderSpriteEntity);
            let foundColliders = 0;
            otherColliders.forEach((otherSprite) => {
                const collisionListener = collisionListeners.get(colliderSpriteEntity);
                if (collisionListener && checkBoxesContact(getAbsoluteCollisionBoxFromSprite(colliderSpriteEntity), getAbsoluteCollisionBoxFromSprite(otherSprite))) {
                    foundColliders++;
                    if (!colliderSpriteEntity.colliding)
                        collisionListener({ otherSprite });
                    colliderSpriteEntity.colliding = true;
                }
            });
            colliderSpriteEntity.colliding = !!foundColliders;
            return foundColliders;
        });
    }
    function registerSpriteEntity({ klass, spriteDefinition, collisionBox }) {
        const spriteEntityKlass = {
            create: ({ pixelPosition, layer, network, ID, frame, zoom }) => {
                const _ID = ID || IDCount++;
                const sprite = screen.addSprite({
                    ID: _ID,
                    spriteDefinition,
                    pixelPosition,
                    layer,
                    network,
                    klass,
                    zoom
                });
                if (frame !== undefined) {
                    sprite.applyFrame(frame);
                }
                const _createParams = {
                    pixelPosition,
                    layer,
                    network
                };
                const spriteEntity = {
                    ID: _ID,
                    setNetwork: (value) => sprite.setNetwork(value),
                    getNetwork: () => sprite.getNetwork(),
                    network,
                    sprite,
                    getPixelPosition: () => sprite.getPixelPosition(),
                    setPixelPosition: (px, py) => sprite.setPixelPosition(px, py),
                    applyFrame: (n) => sprite.applyFrame(n),
                    hide: (n) => sprite.hide(n),
                    show: (n) => sprite.show(n),
                    setZoom: (zoom) => sprite.setZoom(zoom),
                    klassParams: {
                        klass,
                        spriteDefinition,
                        collisionBox
                    },
                    spriteEntityKlass,
                    createParams: _createParams,
                    onCollide: (fn) => collisionListeners.set(spriteEntity, fn),
                    detectCollisions: !!collisionBox,
                    colliding: false,
                    isKlass: (klass) => spriteEntityKlass === klass,
                    destroy: () => {
                        sprite.destroy();
                        delete spriteEntity.spriteEntityKlass;
                        delete spriteEntity.onCollide;
                        collisionListeners.delete(spriteEntity);
                        const spriteIndex = spriteEntities.indexOf(spriteEntity);
                        spriteEntities.splice(spriteIndex, 1);
                    },
                    toJSON: () => {
                        return {
                            position: sprite.getPixelPosition(),
                            layer: sprite.getLayer(),
                            ID: sprite.ID,
                            network,
                            frame: sprite.getFrame(),
                            klass,
                            createParams: _createParams
                        };
                    }
                };
                spriteEntities.push(spriteEntity);
                return spriteEntity;
            },
            klass,
            spriteDefinition,
            collisionBox
        };
        spriteEntityKlasses.set(klass, spriteEntityKlass);
        return spriteEntityKlass;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ByaXRlLWVudGl0eS1mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3ByaXRlLWVudGl0eS1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBQyxpQkFBaUIsRUFBRSxpQ0FBaUMsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUlqRixNQUFNLENBQUMsTUFBTSx5QkFBeUIsR0FBRyxDQUFDLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUMsY0FBYyxFQUFDLFdBQVcsRUFBSyxFQUFNLEVBQUU7SUFDN0csSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLE1BQU0sbUJBQW1CLEdBQWdDLElBQUksR0FBRyxFQUFFLENBQUM7SUFDbkUsTUFBTSxjQUFjLEdBQWtCLEVBQUUsQ0FBQztJQUN6QyxNQUFNLGtCQUFrQixHQUErQixJQUFJLEdBQUcsRUFBRSxDQUFBO0lBRWhFLElBQUksdUJBQXVCLEdBQUcsS0FBSyxDQUFDO0lBRXBDLElBQUcsVUFBVSxJQUFJLENBQUMsY0FBYyxFQUFDLENBQUM7UUFDOUIsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsSUFBVSxFQUFFLEVBQUU7WUFDeEMsSUFBRyxDQUFDLHVCQUF1QixJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsRUFBQyxDQUFDO2dCQUNqRixVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBdUIsRUFBRSxLQUFZLEVBQUMsRUFBRTtvQkFDaEcsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQztvQkFDaEMsTUFBTSxXQUFXLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNuRCxNQUFNLFdBQVcsR0FBZ0IsY0FBYyxDQUFDLElBQUksQ0FB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WUFBWSxDQUFDLENBQUM7Z0JBQ2xDLE9BQU8sWUFBWSxDQUFDO1lBQ3hCLENBQUM7WUFDRCxLQUFLO1lBQ0wsZ0JBQWdCO1lBQ2hCLFlBQVk7U0FDZixDQUFDO1FBQ0YsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2xELE9BQU8saUJBQWlCLENBQUM7SUFDN0IsQ0FBQztBQUNMLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U3ByaXRlRW50aXR5LCBTcHJpdGVFbnRpdHlDcmVhdGlvblBhcmFtcywgU3ByaXRlS2xhc3MsIFNwcml0ZUtsYXNzUGFyYW1zfSBmcm9tIFwiLi9nYW1lLWVudGl0aWVzXCI7XG5pbXBvcnQge1Nwcml0ZX0gZnJvbSBcIi4vc2FtbWljaC1tYWNoaW5lL3NyYy9kY2wtc3ByaXRlLXNjcmVlbi9zcHJpdGUtdXRpbFwiO1xuaW1wb3J0IHtjaGVja0JveGVzQ29udGFjdCwgZ2V0QWJzb2x1dGVDb2xsaXNpb25Cb3hGcm9tU3ByaXRlfSBmcm9tIFwiLi9tYXRoLXV0aWxcIjtcbmltcG9ydCB7U3ByaXRlU3RhdGV9IGZyb20gXCIuLi9zZXJ2ZXIvc3JjL3Jvb21zL0dhbWVTdGF0ZVwiO1xudHlwZSBLbGFzc0FsaWFzID0gc3RyaW5nO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlU3ByaXRlRW50aXR5RmFjdG9yeSA9ICh7c2NyZWVuLCBzZXJ2ZXJSb29tLCBjbGllbnRSb29tLGlzQ2xpZW50UGxheWVyLHBsYXllckluZGV4fTphbnkpOmFueSA9PiB7XG4gICAgbGV0IElEQ291bnQgPSAxO1xuICAgIGNvbnN0IHNwcml0ZUVudGl0eUtsYXNzZXM6TWFwPEtsYXNzQWxpYXMsIFNwcml0ZUtsYXNzPiA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBzcHJpdGVFbnRpdGllczpTcHJpdGVFbnRpdHlbXSA9IFtdO1xuICAgIGNvbnN0IGNvbGxpc2lvbkxpc3RlbmVyczpNYXA8U3ByaXRlRW50aXR5LCBGdW5jdGlvbj4gPSBuZXcgTWFwKClcblxuICAgIGxldCBzcHJpdGVzU3RhdGVJbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gICAgaWYoY2xpZW50Um9vbSAmJiAhaXNDbGllbnRQbGF5ZXIpey8vVE9ETyBSRVZJRVcgUkVGQUNUT1IgSUYgVEhJUyBTSE9VTEQgQkUgT1VULCBUSEUgUkVTUE9OU0lCSUxJVFkgU0hPVUxEIE5PVCBCRSBIRVJFXG4gICAgICAgIGNsaWVudFJvb20ub25TdGF0ZUNoYW5nZSgoLi4uYXJnczphbnlbXSkgPT4ge1xuICAgICAgICAgICBpZighc3ByaXRlc1N0YXRlSW5pdGlhbGl6ZWQgJiYgY2xpZW50Um9vbS5zdGF0ZS5wbGF5ZXJzW3BsYXllckluZGV4XS5zcHJpdGVFbnRpdGllcyl7XG4gICAgICAgICAgICAgICBjbGllbnRSb29tLnN0YXRlLnBsYXllcnNbcGxheWVySW5kZXhdLnNwcml0ZUVudGl0aWVzLm9uQWRkKChzcHJpdGVTdGF0ZTpTcHJpdGVTdGF0ZSwgaW5kZXg6bnVtYmVyKT0+e1xuICAgICAgICAgICAgICAgICAgIGNvbnN0IGtsYXNzID0gc3ByaXRlU3RhdGUua2xhc3M7XG4gICAgICAgICAgICAgICAgICAgY29uc3QgU3ByaXRlS2xhc3MgPSBzcHJpdGVFbnRpdHlLbGFzc2VzLmdldChrbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYWxTcHJpdGU6U3ByaXRlRW50aXR5ID0gc3ByaXRlRW50aXRpZXMuZmluZChpPT5pLklEID09PSBzcHJpdGVTdGF0ZS5JRCkgYXMgU3ByaXRlRW50aXR5O1xuICAgICAgICAgICAgICAgICAgIGlmKCFsb2NhbFNwcml0ZSl7XG4gICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHtJRCwgbGF5ZXIsIGZyYW1lfSA9IHNwcml0ZVN0YXRlO1xuICAgICAgICAgICAgICAgICAgICAgICBTcHJpdGVLbGFzcz8uY3JlYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIElELFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbjpbc3ByaXRlU3RhdGUueCwgc3ByaXRlU3RhdGUueV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBsYXllcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcms6dHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lXG4gICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgc3ByaXRlU3RhdGUub25DaGFuZ2UoKGNoYW5nZXMpPT57XG4gICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZVN0YXRlSlNPTjpTcHJpdGVTdGF0ZSA9IHNwcml0ZVN0YXRlLnRvSlNPTigpIGFzIFNwcml0ZVN0YXRlO1xuICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2NhbFNwcml0ZTpTcHJpdGVFbnRpdHkgPSBzcHJpdGVFbnRpdGllcy5maW5kKGk9PmkuSUQgPT09IHNwcml0ZVN0YXRlSlNPTi5JRCkgYXMgU3ByaXRlRW50aXR5O1xuICAgICAgICAgICAgICAgICAgICAgICBpZihsb2NhbFNwcml0ZT8uc3ByaXRlICYmIGxvY2FsU3ByaXRlLnNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKClbMF0gIT09IHNwcml0ZVN0YXRlSlNPTi54IHx8IGxvY2FsU3ByaXRlLnNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKClbMV0gIT09IHNwcml0ZVN0YXRlSlNPTi55KXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3ByaXRlLnNldFBpeGVsUG9zaXRpb24oc3ByaXRlU3RhdGVKU09OLngsc3ByaXRlU3RhdGVKU09OLnkpO1xuICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgIGlmKGxvY2FsU3ByaXRlPy5zcHJpdGUgJiYgbG9jYWxTcHJpdGUuc3ByaXRlLmdldEZyYW1lKCkgIT09IHNwcml0ZVN0YXRlSlNPTi5mcmFtZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFNwcml0ZS5hcHBseUZyYW1lKHNwcml0ZVN0YXRlSlNPTi5mcmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgIGNsaWVudFJvb20uc3RhdGUucGxheWVyc1twbGF5ZXJJbmRleF0uc3ByaXRlRW50aXRpZXMub25SZW1vdmUoKHNwcml0ZVN0YXRlOlNwcml0ZVN0YXRlKT0+e1xuICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsU3ByaXRlOlNwcml0ZUVudGl0eSA9IHNwcml0ZUVudGl0aWVzLmZpbmQoaT0+aS5JRCA9PT0gc3ByaXRlU3RhdGUuSUQpIGFzIFNwcml0ZUVudGl0eTtcbiAgICAgICAgICAgICAgICAgICBsb2NhbFNwcml0ZT8uZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgIHNwcml0ZXNTdGF0ZUluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICByZWdpc3RlclNwcml0ZUVudGl0eSxcbiAgICAgICAgY2hlY2tDb2xsaWRlcnMsXG4gICAgICAgIGdldFNwcml0ZUVudGl0aWVzOigpPT5zcHJpdGVFbnRpdGllcyxcbiAgICAgICAgY2xlYW5TcHJpdGVFbnRpdGllczogKCkgPT4ge1xuICAgICAgICAgICAgd2hpbGUoc3ByaXRlRW50aXRpZXMubGVuZ3RoKSBzcHJpdGVFbnRpdGllc1swXS5kZXN0cm95KCk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldENvbGxpc2lvbkxpc3RlbmVyczooKT0+Y29sbGlzaW9uTGlzdGVuZXJzLFxuICAgICAgICBnZXRTcHJpdGVFbnRpdHlLbGFzc2VzOigpPT5zcHJpdGVFbnRpdHlLbGFzc2VzLFxuICAgICAgICBkZXN0cm95OigpPT57XG4gICAgICAgICAgICB3aGlsZShzcHJpdGVFbnRpdGllcz8ubGVuZ3RoKSBzcHJpdGVFbnRpdGllc1swXS5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgZnVuY3Rpb24gY2hlY2tDb2xsaWRlcnMoKXtcbiAgICAgICAgY29uc3QgY29sbGlkZXJzID0gc3ByaXRlRW50aXRpZXMuZmlsdGVyKChpOlNwcml0ZUVudGl0eSk9PmkuZGV0ZWN0Q29sbGlzaW9ucyk7XG4gICAgICAgIGNvbGxpZGVycy5mb3JFYWNoKChjb2xsaWRlclNwcml0ZUVudGl0eTpTcHJpdGVFbnRpdHksIGluZGV4Om51bWJlcik9PntcbiAgICAgICAgICAgIGNvbnN0IG90aGVyQ29sbGlkZXJzID0gY29sbGlkZXJzLmZpbHRlcigoYzphbnkpPT5jIT09Y29sbGlkZXJTcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGZvdW5kQ29sbGlkZXJzID0gMDtcbiAgICAgICAgICAgIG90aGVyQ29sbGlkZXJzLmZvckVhY2goKG90aGVyU3ByaXRlOmFueSk9PntcbiAgICAgICAgICAgICAgICBjb25zdCBjb2xsaXNpb25MaXN0ZW5lciA9IGNvbGxpc2lvbkxpc3RlbmVycy5nZXQoY29sbGlkZXJTcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgIGlmKGNvbGxpc2lvbkxpc3RlbmVyICYmIGNoZWNrQm94ZXNDb250YWN0KFxuICAgICAgICAgICAgICAgICAgICBnZXRBYnNvbHV0ZUNvbGxpc2lvbkJveEZyb21TcHJpdGUoY29sbGlkZXJTcHJpdGVFbnRpdHkpLFxuICAgICAgICAgICAgICAgICAgICBnZXRBYnNvbHV0ZUNvbGxpc2lvbkJveEZyb21TcHJpdGUob3RoZXJTcHJpdGUpXG4gICAgICAgICAgICAgICAgKSl7XG4gICAgICAgICAgICAgICAgICAgIGZvdW5kQ29sbGlkZXJzKys7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoIWNvbGxpZGVyU3ByaXRlRW50aXR5LmNvbGxpZGluZykgY29sbGlzaW9uTGlzdGVuZXIoe290aGVyU3ByaXRlfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29sbGlkZXJTcHJpdGVFbnRpdHkuY29sbGlkaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbGxpZGVyU3ByaXRlRW50aXR5LmNvbGxpZGluZyA9ICEhZm91bmRDb2xsaWRlcnM7XG4gICAgICAgICAgICByZXR1cm4gZm91bmRDb2xsaWRlcnM7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiByZWdpc3RlclNwcml0ZUVudGl0eSh7a2xhc3MsIHNwcml0ZURlZmluaXRpb24sIGNvbGxpc2lvbkJveH06U3ByaXRlS2xhc3NQYXJhbXMpOlNwcml0ZUtsYXNze1xuICAgICAgICBjb25zdCBzcHJpdGVFbnRpdHlLbGFzczpTcHJpdGVLbGFzcyA9IHtcbiAgICAgICAgICAgIGNyZWF0ZTooe3BpeGVsUG9zaXRpb24sIGxheWVyLCBuZXR3b3JrLCBJRCwgZnJhbWUsIHpvb219OlNwcml0ZUVudGl0eUNyZWF0aW9uUGFyYW1zKTpTcHJpdGVFbnRpdHkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IF9JRCA9IElEIHx8IElEQ291bnQrKztcbiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGU6U3ByaXRlID0gc2NyZWVuLmFkZFNwcml0ZSh7XG4gICAgICAgICAgICAgICAgICAgIElEOl9JRCxcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbixcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICAgICAgICAgIG5ldHdvcmssXG4gICAgICAgICAgICAgICAgICAgIGtsYXNzLFxuICAgICAgICAgICAgICAgICAgICB6b29tXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYoZnJhbWUhPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICAgICBzcHJpdGUuYXBwbHlGcmFtZShmcmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgX2NyZWF0ZVBhcmFtcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbixcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICAgICAgICAgIG5ldHdvcmtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3Qgc3ByaXRlRW50aXR5OlNwcml0ZUVudGl0eSA9IHtcbiAgICAgICAgICAgICAgICAgICAgSUQ6X0lELFxuICAgICAgICAgICAgICAgICAgICBzZXROZXR3b3JrOih2YWx1ZTpib29sZWFuKT0+c3ByaXRlLnNldE5ldHdvcmsodmFsdWUpLFxuICAgICAgICAgICAgICAgICAgICBnZXROZXR3b3JrOigpPT5zcHJpdGUuZ2V0TmV0d29yaygpLFxuICAgICAgICAgICAgICAgICAgICBuZXR3b3JrLFxuICAgICAgICAgICAgICAgICAgICBzcHJpdGUsXG4gICAgICAgICAgICAgICAgICAgIGdldFBpeGVsUG9zaXRpb246KCk9PnNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgIHNldFBpeGVsUG9zaXRpb246IChweDpudW1iZXIscHk6bnVtYmVyKSA9PiBzcHJpdGUuc2V0UGl4ZWxQb3NpdGlvbihweCxweSksXG4gICAgICAgICAgICAgICAgICAgIGFwcGx5RnJhbWU6KG46bnVtYmVyKT0+c3ByaXRlLmFwcGx5RnJhbWUobiksXG4gICAgICAgICAgICAgICAgICAgIGhpZGU6KG46bnVtYmVyKT0+c3ByaXRlLmhpZGUobiksXG4gICAgICAgICAgICAgICAgICAgIHNob3c6KG46bnVtYmVyKT0+c3ByaXRlLnNob3cobiksXG4gICAgICAgICAgICAgICAgICAgIHNldFpvb206KHpvb206bnVtYmVyW10pID0+IHNwcml0ZS5zZXRab29tKHpvb20pLFxuICAgICAgICAgICAgICAgICAgICBrbGFzc1BhcmFtczp7XG4gICAgICAgICAgICAgICAgICAgICAgICBrbGFzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwcml0ZURlZmluaXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsaXNpb25Cb3hcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlRW50aXR5S2xhc3MsXG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZVBhcmFtczpfY3JlYXRlUGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICBvbkNvbGxpZGU6KGZuOkZ1bmN0aW9uKT0+IGNvbGxpc2lvbkxpc3RlbmVycy5zZXQoc3ByaXRlRW50aXR5LCBmbiksXG4gICAgICAgICAgICAgICAgICAgIGRldGVjdENvbGxpc2lvbnM6ISFjb2xsaXNpb25Cb3gsXG4gICAgICAgICAgICAgICAgICAgIGNvbGxpZGluZzpmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgaXNLbGFzczooa2xhc3M6U3ByaXRlS2xhc3MpPT5zcHJpdGVFbnRpdHlLbGFzcyA9PT0ga2xhc3MsXG4gICAgICAgICAgICAgICAgICAgIGRlc3Ryb3k6KCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwcml0ZS5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmUgLy9UT0RPIFJFVklFV1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHNwcml0ZUVudGl0eS5zcHJpdGVFbnRpdHlLbGFzcztcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZSAvL1RPRE8gUkVWSUVXXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgc3ByaXRlRW50aXR5Lm9uQ29sbGlkZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpc2lvbkxpc3RlbmVycy5kZWxldGUoc3ByaXRlRW50aXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZUluZGV4ID0gc3ByaXRlRW50aXRpZXMuaW5kZXhPZihzcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlRW50aXRpZXMuc3BsaWNlKHNwcml0ZUluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgdG9KU09OOigpPT57XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOnNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF5ZXI6c3ByaXRlLmdldExheWVyKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSUQ6c3ByaXRlLklELFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmssXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWU6c3ByaXRlLmdldEZyYW1lKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2xhc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUGFyYW1zOl9jcmVhdGVQYXJhbXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgc3ByaXRlRW50aXRpZXMucHVzaChzcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzcHJpdGVFbnRpdHk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAga2xhc3MsXG4gICAgICAgICAgICBzcHJpdGVEZWZpbml0aW9uLFxuICAgICAgICAgICAgY29sbGlzaW9uQm94XG4gICAgICAgIH07XG4gICAgICAgIHNwcml0ZUVudGl0eUtsYXNzZXMuc2V0KGtsYXNzLCBzcHJpdGVFbnRpdHlLbGFzcyk7XG4gICAgICAgIHJldHVybiBzcHJpdGVFbnRpdHlLbGFzcztcbiAgICB9XG59XG5cbiJdfQ==
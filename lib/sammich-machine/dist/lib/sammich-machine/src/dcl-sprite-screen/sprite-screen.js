import { engine, Material, MeshCollider, MeshRenderer, PointerEvents, pointerEventsSystem, TextShape, Transform } from "@dcl/sdk/ecs";
import { Color4, Vector3 } from "@dcl/sdk/math";
import { createSpriteAnimationUVSGetter, getUvsFromSprite, UVS_BACK } from "./sprite-util";
export function createSpriteScreen({ transform, spriteMaterial, spriteDefinition }) {
    console.log("createSpriteScreen__1");
    const screenEntity = createSpritePlane({ spriteMaterial, spriteDefinition, transform });
    const state = {
        spriteDefinition
    };
    MeshCollider.setPlane(screenEntity);
    const screenSpriteDefinition = spriteDefinition;
    const SPRITE_BUTTON_POINTER_OPTIONS = { pointerEvents: [{
                eventType: 1,
                eventInfo: {
                    button: 0,
                    showFeedback: true
                }
            }] };
    const transformBackup = (JSON.parse(JSON.stringify(transform)));
    return {
        setBackgroundSprite: ({ spriteDefinition }) => {
            const mutablePlane = MeshRenderer.getMutable(screenEntity);
            state.spriteDefinition = spriteDefinition;
            if (mutablePlane.mesh)
                mutablePlane.mesh[mutablePlane.mesh.$case].uvs = getUvsFromSprite({ spriteDefinition, back: UVS_BACK.MIRROR });
        },
        getSize: () => [state.spriteDefinition.w, state.spriteDefinition.h],
        addSprite: ({ ID, spriteDefinition, onClick, pixelPosition, layer, network, hoverText, zoom = [1, 1] }) => {
            const normalizedPixelPosition = normalizePixelPosition(pixelPosition[0], pixelPosition[1], layer);
            const state = {
                pixelPosition,
                network,
                layer,
                frame: 0,
                destroyed: false
            };
            const spriteEntity = createSpritePlane({
                spriteDefinition,
                transform: {
                    parent: screenEntity,
                    scale: Vector3.create((spriteDefinition.w / screenSpriteDefinition.w) * zoom[0], (spriteDefinition.h / screenSpriteDefinition.h) * zoom[1], 1),
                    position: Vector3.create(...normalizedPixelPosition)
                },
                spriteMaterial
            });
            let spriteAnimationUVS;
            if (spriteDefinition.columns) {
                spriteAnimationUVS = createSpriteAnimationUVSGetter({
                    spriteDefinition,
                    back: UVS_BACK.MIRROR
                });
            }
            if (onClick) {
                console.log("0mClick", spriteEntity);
                MeshCollider.setPlane(spriteEntity, [1]);
                PointerEvents.create(spriteEntity, SPRITE_BUTTON_POINTER_OPTIONS);
                pointerEventsSystem.onPointerDown({ entity: spriteEntity, opts: { hoverText, showFeedback: true, button: 0 } }, (event) => onClick(event));
            }
            else {
                MeshCollider.setPlane(spriteEntity, [0]);
            }
            return {
                ID,
                destroy: () => {
                    engine.removeEntity(spriteEntity);
                    state.destroyed = true;
                },
                applyFrame: (n) => {
                    if (!spriteAnimationUVS)
                        return;
                    state.frame = n;
                    if (state.destroyed)
                        return;
                    const mutablePlane = MeshRenderer.getMutable(spriteEntity);
                    if (mutablePlane.mesh)
                        mutablePlane.mesh[mutablePlane.mesh.$case].uvs = spriteAnimationUVS(n);
                },
                getFrame: () => state.frame,
                getLayer: () => state.layer,
                hide: () => {
                    Transform.getMutable(spriteEntity).position.y = Number.MIN_SAFE_INTEGER;
                },
                show: () => {
                    Transform.getMutable(spriteEntity).position.y = normalizedPixelPosition[1];
                },
                getPixelPosition: () => state.pixelPosition,
                setPixelPosition: (px, py) => {
                    if (state.destroyed)
                        return;
                    state.pixelPosition = [px, py];
                    const mutablePosition = Transform.getMutable(spriteEntity).position;
                    const normalizedPixelPosition = normalizePixelPosition(px, py, layer);
                    mutablePosition.x = normalizedPixelPosition[0];
                    mutablePosition.y = normalizedPixelPosition[1];
                },
                getNetwork: () => state.network,
                setNetwork: (value) => state.network = value,
                setZoom: (zoom) => {
                    Transform.getMutable(spriteEntity).scale.x = (spriteDefinition.w / screenSpriteDefinition.w) * zoom[0];
                    Transform.getMutable(spriteEntity).scale.y = (spriteDefinition.h / screenSpriteDefinition.h) * zoom[1];
                }
            };
            function normalizePixelPosition(xPixels, yPixels, layer) {
                const offsetX = (spriteDefinition.w / screenSpriteDefinition.w) / 2 - 0.5;
                const offsetY = 0.5 - (spriteDefinition.h / screenSpriteDefinition.h) / 2;
                return [
                    offsetX + (xPixels / screenSpriteDefinition.w),
                    offsetY - (yPixels / screenSpriteDefinition.h),
                    -layer * 0.001
                ];
            }
        },
        addText: ({ pixelPosition = [0, 0], textAlign = 0, text = "FOO", textColor = [0, 0, 0, 1], fontSize = 0.5, layer = 10 }) => {
            const normalizedPosition = normalizePixelPositionForText(pixelPosition[0], pixelPosition[1], layer);
            const textEntity = engine.addEntity();
            TextShape.create(textEntity, {
                text,
                textAlign,
                textColor: Color4.create(...textColor),
                fontSize,
                font: 2
            });
            Transform.create(textEntity, {
                parent: screenEntity,
                position: Vector3.create(...normalizedPosition)
            });
            return {
                destroy: () => {
                    engine.removeEntity(textEntity);
                },
                setText: (value) => TextShape.getMutable(textEntity).text = value.toString(),
                setPixelPosition: (px, py) => {
                    const normalizedPosition = normalizePixelPositionForText(px, py, layer);
                    console.log("text normalizedPosition", px, py, normalizedPosition);
                    const mutablePosition = Transform.getMutable(textEntity).position;
                    mutablePosition.x = normalizedPosition[0];
                    mutablePosition.y = normalizedPosition[1];
                },
                hide: () => Transform.getMutable(textEntity).position.y = -10000,
                show: () => Transform.getMutable(textEntity).position.y = normalizedPosition[1]
            };
            function normalizePixelPositionForText(xPixels, yPixels, layer) {
                return [
                    (xPixels - (screenSpriteDefinition.w / 2)) * (1 / screenSpriteDefinition.w),
                    -(yPixels + (screenSpriteDefinition.h / 2)) * (1 / screenSpriteDefinition.h) + 1,
                    -layer * 0.001
                ];
            }
        },
        getEntity: () => screenEntity,
        hide: () => {
            Transform.getMutable(screenEntity).position.y = Number.MIN_SAFE_INTEGER;
        },
        show: () => {
            console.log("show lobby screen", transformBackup.position?.y);
            Transform.getMutable(screenEntity).position.y = (transformBackup.position?.y || 0);
        },
        destroy: () => {
            engine.removeEntity(screenEntity);
        }
    };
}
export function createSpritePlane({ spriteDefinition, transform, spriteMaterial }) {
    const planeEntity = engine.addEntity();
    MeshRenderer.setPlane(planeEntity, getUvsFromSprite({
        spriteDefinition, back: UVS_BACK.MIRROR
    }));
    Transform.create(planeEntity, transform);
    Material.setPbrMaterial(planeEntity, spriteMaterial);
    return planeEntity;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ByaXRlLXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9kY2wtc3ByaXRlLXNjcmVlbi9zcHJpdGUtc2NyZWVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFFSCxNQUFNLEVBR04sUUFBUSxFQUNSLFlBQVksRUFDWixZQUFZLEVBRVosYUFBYSxFQUNiLG1CQUFtQixFQUduQixTQUFTLEVBQ1QsU0FBUyxFQUNaLE1BQU0sY0FBYyxDQUFDO0FBQ3RCLE9BQU8sRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRTlDLE9BQU8sRUFDSCw4QkFBOEIsRUFDOUIsZ0JBQWdCLEVBR2hCLFFBQVEsRUFDWCxNQUFNLGVBQWUsQ0FBQztBQVF2QixNQUFNLFVBQVUsa0JBQWtCLENBQUMsRUFDSSxTQUFTLEVBQ1QsY0FBYyxFQUNkLGdCQUFnQixFQUNFO0lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUNyQyxNQUFNLFlBQVksR0FBRyxpQkFBaUIsQ0FBQyxFQUFDLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFBO0lBQ3JGLE1BQU0sS0FBSyxHQUF1QztRQUM5QyxnQkFBZ0I7S0FDbkIsQ0FBQztJQUNGLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFcEMsTUFBTSxzQkFBc0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUNoRCxNQUFNLDZCQUE2QixHQUFHLEVBQUMsYUFBYSxFQUFDLENBQUM7Z0JBQzlDLFNBQVMsR0FBMkI7Z0JBQ3BDLFNBQVMsRUFBRTtvQkFDUCxNQUFNLEdBQXdCO29CQUM5QixZQUFZLEVBQUUsSUFBSTtpQkFDckI7YUFDSixDQUFDLEVBQUMsQ0FBQTtJQUNQLE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMs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LFlBQVksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLGdCQUFnQixDQUFDO1FBQ2hELGdCQUFnQixFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsTUFBTTtLQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNKLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3pDLFFBQVEsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRXJELE9BQU8sV0FBVyxDQUFDO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1RyYW5zZm9ybVR5cGVXaXRoT3B0aW9uYWxzfSBmcm9tIFwiQGRjbC9lY3MvZGlzdC9jb21wb25lbnRzL21hbnVhbC9UcmFuc2Zvcm1cIjtcbmltcG9ydCB7XG4gICAgQ29sbGlkZXJMYXllcixcbiAgICBlbmdpbmUsXG4gICAgRm9udCxcbiAgICBJbnB1dEFjdGlvbixcbiAgICBNYXRlcmlhbCxcbiAgICBNZXNoQ29sbGlkZXIsXG4gICAgTWVzaFJlbmRlcmVyLFxuICAgIFBCTWF0ZXJpYWxfUGJyTWF0ZXJpYWwsXG4gICAgUG9pbnRlckV2ZW50cyxcbiAgICBwb2ludGVyRXZlbnRzU3lzdGVtLFxuICAgIFBvaW50ZXJFdmVudFR5cGUsXG4gICAgVGV4dEFsaWduTW9kZSxcbiAgICBUZXh0U2hhcGUsXG4gICAgVHJhbnNmb3JtXG59IGZyb20gXCJAZGNsL3Nkay9lY3NcIjtcbmltcG9ydCB7Q29sb3I0LCBWZWN0b3IzfSBmcm9tIFwiQGRjbC9zZGsvbWF0aFwiO1xuXG5pbXBvcnQge1xuICAgIGNyZWF0ZVNwcml0ZUFuaW1hdGlvblVWU0dldHRlcixcbiAgICBnZXRVdnNGcm9tU3ByaXRlLFxuICAgIFNwcml0ZSxcbiAgICBTcHJpdGVEZWZpbml0aW9uLFxuICAgIFVWU19CQUNLXG59IGZyb20gXCIuL3Nwcml0ZS11dGlsXCI7XG5cbmV4cG9ydCB0eXBlIFNwcml0ZVNjcmVlbk9wdGlvbnMgPSB7XG4gICAgdHJhbnNmb3JtOiBUcmFuc2Zvcm1UeXBlV2l0aE9wdGlvbmFscyxcbiAgICBzcHJpdGVNYXRlcmlhbDogUEJNYXRlcmlhbF9QYnJNYXRlcmlhbCxcbiAgICBzcHJpdGVEZWZpbml0aW9uOiBTcHJpdGVEZWZpbml0aW9uXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3ByaXRlU2NyZWVuKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwcml0ZU1hdGVyaWFsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlRGVmaW5pdGlvbi8vd2lsbCBhbHNvIGRlZmluZSBzY3JlZW4gcmVzb2x1dGlvbiwgd2hpY2ggd2lsbCBhZmZlY3Qgem9vbSBhbmQgY2xpY2sgZXZlbnQgaW5mbyB3aXRoIGNvb3Jkc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OiBTcHJpdGVTY3JlZW5PcHRpb25zKSB7XG4gICAgY29uc29sZS5sb2coXCJjcmVhdGVTcHJpdGVTY3JlZW5fXzFcIik7XG4gICAgY29uc3Qgc2NyZWVuRW50aXR5ID0gY3JlYXRlU3ByaXRlUGxhbmUoe3Nwcml0ZU1hdGVyaWFsLCBzcHJpdGVEZWZpbml0aW9uLCB0cmFuc2Zvcm19KVxuICAgIGNvbnN0IHN0YXRlOntzcHJpdGVEZWZpbml0aW9uOlNwcml0ZURlZmluaXRpb259ID0ge1xuICAgICAgICBzcHJpdGVEZWZpbml0aW9uXG4gICAgfTtcbiAgICBNZXNoQ29sbGlkZXIuc2V0UGxhbmUoc2NyZWVuRW50aXR5KTtcblxuICAgIGNvbnN0IHNjcmVlblNwcml0ZURlZmluaXRpb24gPSBzcHJpdGVEZWZpbml0aW9uO1xuICAgIGNvbnN0IFNQUklURV9CVVRUT05fUE9JTlRFUl9PUFRJT05TID0ge3BvaW50ZXJFdmVudHM6W3tcbiAgICAgICAgICAgIGV2ZW50VHlwZTogUG9pbnRlckV2ZW50VHlwZS5QRVRfRE9XTixcbiAgICAgICAgICAgIGV2ZW50SW5mbzoge1xuICAgICAgICAgICAgICAgIGJ1dHRvbjogSW5wdXRBY3Rpb24uSUFfUE9JTlRFUixcbiAgICAgICAgICAgICAgICBzaG93RmVlZGJhY2s6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfV19XG4gICAgY29uc3QgdHJhbnNmb3JtQmFja3VwID0gKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodHJhbnNmb3JtKSkpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNldEJhY2tncm91bmRTcHJpdGU6KHtzcHJpdGVEZWZpbml0aW9ufTp7c3ByaXRlRGVmaW5pdGlvbjpTcHJpdGVEZWZpbml0aW9ufSk9PntcbiAgICAgICAgICAgIGNvbnN0IG11dGFibGVQbGFuZTphbnkgPSBNZXNoUmVuZGVyZXIuZ2V0TXV0YWJsZShzY3JlZW5FbnRpdHkpO1xuICAgICAgICAgICAgc3RhdGUuc3ByaXRlRGVmaW5pdGlvbiA9IHNwcml0ZURlZmluaXRpb247XG4gICAgICAgICAgICBpZihtdXRhYmxlUGxhbmUubWVzaCkgbXV0YWJsZVBsYW5lLm1lc2hbbXV0YWJsZVBsYW5lLm1lc2guJGNhc2VdLnV2cyA9IGdldFV2c0Zyb21TcHJpdGUoe3Nwcml0ZURlZmluaXRpb24sIGJhY2s6VVZTX0JBQ0suTUlSUk9SfSk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldFNpemU6KCk9PltzdGF0ZS5zcHJpdGVEZWZpbml0aW9uLncsIHN0YXRlLnNwcml0ZURlZmluaXRpb24uaF0sXG4gICAgICAgIGFkZFNwcml0ZTogKHtJRCwgc3ByaXRlRGVmaW5pdGlvbiwgb25DbGljaywgcGl4ZWxQb3NpdGlvbiwgbGF5ZXIsIG5ldHdvcmssIGhvdmVyVGV4dCwgem9vbT1bMSwxXX06IGFueSk6U3ByaXRlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRQaXhlbFBvc2l0aW9uID0gbm9ybWFsaXplUGl4ZWxQb3NpdGlvbihwaXhlbFBvc2l0aW9uWzBdLCBwaXhlbFBvc2l0aW9uWzFdLCBsYXllcik7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgICAgICAgICAgICBwaXhlbFBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIG5ldHdvcmssXG4gICAgICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICAgICAgZnJhbWU6MCxcbiAgICAgICAgICAgICAgICBkZXN0cm95ZWQ6ZmFsc2VcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBzcHJpdGVFbnRpdHkgPSBjcmVhdGVTcHJpdGVQbGFuZSh7XG4gICAgICAgICAgICAgICAgc3ByaXRlRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHtcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50OiBzY3JlZW5FbnRpdHksXG4gICAgICAgICAgICAgICAgICAgIHNjYWxlOiBWZWN0b3IzLmNyZWF0ZShcbiAgICAgICAgICAgICAgICAgICAgICAgIChzcHJpdGVEZWZpbml0aW9uLncgLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLncpICogem9vbVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIChzcHJpdGVEZWZpbml0aW9uLmggLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLmgpICogem9vbVsxXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIDEpLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5ub3JtYWxpemVkUGl4ZWxQb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzcHJpdGVNYXRlcmlhbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgc3ByaXRlQW5pbWF0aW9uVVZTOmFueTtcbiAgICAgICAgICAgIGlmKHNwcml0ZURlZmluaXRpb24uY29sdW1ucyl7XG4gICAgICAgICAgICAgICAgc3ByaXRlQW5pbWF0aW9uVVZTID0gY3JlYXRlU3ByaXRlQW5pbWF0aW9uVVZTR2V0dGVyKHtcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgYmFjazpVVlNfQkFDSy5NSVJST1JcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICBpZiAob25DbGljaykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiMG1DbGlja1wiLCBzcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgIE1lc2hDb2xsaWRlci5zZXRQbGFuZShzcHJpdGVFbnRpdHksIFtDb2xsaWRlckxheWVyLkNMX1BPSU5URVJdKTtcbiAgICAgICAgICAgICAgICBQb2ludGVyRXZlbnRzLmNyZWF0ZShzcHJpdGVFbnRpdHksIFNQUklURV9CVVRUT05fUE9JTlRFUl9PUFRJT05TKVxuICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHNTeXN0ZW0ub25Qb2ludGVyRG93bih7IGVudGl0eTogc3ByaXRlRW50aXR5LCBvcHRzOntob3ZlclRleHQsIHNob3dGZWVkYmFjazp0cnVlLCBidXR0b246SW5wdXRBY3Rpb24uSUFfUE9JTlRFUn0gfSwoZXZlbnQpID0+IG9uQ2xpY2soZXZlbnQpKTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIE1lc2hDb2xsaWRlci5zZXRQbGFuZShzcHJpdGVFbnRpdHksIFtDb2xsaWRlckxheWVyLkNMX05PTkVdKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIElELFxuICAgICAgICAgICAgICAgIGRlc3Ryb3k6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZW5naW5lLnJlbW92ZUVudGl0eShzcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kZXN0cm95ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAvL1RPRE8gUkVWSUVXIFBPU1NJQkxFIE1FTU9SWSBMRUFLU1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgYXBwbHlGcmFtZToobjpudW1iZXIpPT57XG4gICAgICAgICAgICAgICAgICAgIGlmKCFzcHJpdGVBbmltYXRpb25VVlMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZnJhbWUgPSBuO1xuICAgICAgICAgICAgICAgICAgICBpZihzdGF0ZS5kZXN0cm95ZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXV0YWJsZVBsYW5lOmFueSA9IE1lc2hSZW5kZXJlci5nZXRNdXRhYmxlKHNwcml0ZUVudGl0eSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKG11dGFibGVQbGFuZS5tZXNoKSBtdXRhYmxlUGxhbmUubWVzaFttdXRhYmxlUGxhbmUubWVzaC4kY2FzZV0udXZzID0gc3ByaXRlQW5pbWF0aW9uVVZTKG4pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0RnJhbWU6KCk9PnN0YXRlLmZyYW1lLFxuICAgICAgICAgICAgICAgIGdldExheWVyOigpPT5zdGF0ZS5sYXllcixcbiAgICAgICAgICAgICAgICBoaWRlOigpPT57XG4gICAgICAgICAgICAgICAgICAgIC8vcG9pbnRlckV2ZW50c1N5c3RlbS5yZW1vdmVPblBvaW50ZXJVcChzcHJpdGVFbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShzcHJpdGVFbnRpdHkpLnBvc2l0aW9uLnkgPSBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUjtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNob3c6KCk9PntcbiAgICAgICAgICAgICAgICAgICAgLy9wb2ludGVyRXZlbnRzU3lzdGVtLm9uUG9pbnRlclVwKHsgZW50aXR5OiBzcHJpdGVFbnRpdHkgfSwoZXZlbnQpID0+IG9uQ2xpY2soZXZlbnQpKTtcbiAgICAgICAgICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUoc3ByaXRlRW50aXR5KS5wb3NpdGlvbi55ID0gbm9ybWFsaXplZFBpeGVsUG9zaXRpb25bMV07XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXRQaXhlbFBvc2l0aW9uOigpPT5zdGF0ZS5waXhlbFBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIHNldFBpeGVsUG9zaXRpb246KHB4Om51bWJlcixweTpudW1iZXIpPT57XG4gICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLmRlc3Ryb3llZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5waXhlbFBvc2l0aW9uID0gWyBweCwgcHkgXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXV0YWJsZVBvc2l0aW9uID0gVHJhbnNmb3JtLmdldE11dGFibGUoc3ByaXRlRW50aXR5KS5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFBpeGVsUG9zaXRpb24gPSBub3JtYWxpemVQaXhlbFBvc2l0aW9uKHB4LHB5LCBsYXllcik7XG4gICAgICAgICAgICAgICAgICAgIG11dGFibGVQb3NpdGlvbi54ID0gbm9ybWFsaXplZFBpeGVsUG9zaXRpb25bMF07XG4gICAgICAgICAgICAgICAgICAgIG11dGFibGVQb3NpdGlvbi55ID0gbm9ybWFsaXplZFBpeGVsUG9zaXRpb25bMV07XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXROZXR3b3JrOigpPT5zdGF0ZS5uZXR3b3JrLFxuICAgICAgICAgICAgICAgIHNldE5ldHdvcms6KHZhbHVlOmJvb2xlYW4pPT5zdGF0ZS5uZXR3b3JrID0gdmFsdWUsXG4gICAgICAgICAgICAgICAgc2V0Wm9vbTogKHpvb206bnVtYmVyW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUoc3ByaXRlRW50aXR5KS5zY2FsZS54ID0gKHNwcml0ZURlZmluaXRpb24udyAvIHNjcmVlblNwcml0ZURlZmluaXRpb24udykgKiB6b29tWzBdO1xuICAgICAgICAgICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShzcHJpdGVFbnRpdHkpLnNjYWxlLnkgPSAoc3ByaXRlRGVmaW5pdGlvbi5oIC8gc2NyZWVuU3ByaXRlRGVmaW5pdGlvbi5oKSAqIHpvb21bMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVQaXhlbFBvc2l0aW9uKHhQaXhlbHM6IG51bWJlciwgeVBpeGVsczogbnVtYmVyLCBsYXllcjogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0WCA9IChzcHJpdGVEZWZpbml0aW9uLncgLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLncpIC8gMiAtIDAuNTtcbiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXRZID0gMC41IC0gKHNwcml0ZURlZmluaXRpb24uaCAvIHNjcmVlblNwcml0ZURlZmluaXRpb24uaCkgLyAyXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgICAgICBvZmZzZXRYICsgKHhQaXhlbHMgLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLncpLFxuICAgICAgICAgICAgICAgICAgICBvZmZzZXRZIC0gKHlQaXhlbHMgLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLmgpLFxuICAgICAgICAgICAgICAgICAgICAtbGF5ZXIgKiAwLjAwMVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSxcbiAgICAgICAgYWRkVGV4dDogKHtwaXhlbFBvc2l0aW9uID0gWzAsMF0sIHRleHRBbGlnbiA9IFRleHRBbGlnbk1vZGUuVEFNX1RPUF9MRUZULCB0ZXh0ID0gXCJGT09cIiwgdGV4dENvbG9yID0gWzAsMCwwLDFdLCBmb250U2l6ZSA9IDAuNSwgbGF5ZXIgPSAxMH06YW55KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3JtYWxpemVkUG9zaXRpb24gPSBub3JtYWxpemVQaXhlbFBvc2l0aW9uRm9yVGV4dChwaXhlbFBvc2l0aW9uWzBdLCBwaXhlbFBvc2l0aW9uWzFdLCBsYXllcilcbiAgICAgICAgICAgIGNvbnN0IHRleHRFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KCk7XG4gICAgICAgICAgICBUZXh0U2hhcGUuY3JlYXRlKHRleHRFbnRpdHksIHtcbiAgICAgICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgICAgIHRleHRBbGlnbixcbiAgICAgICAgICAgICAgICB0ZXh0Q29sb3I6Q29sb3I0LmNyZWF0ZSguLi50ZXh0Q29sb3IpLFxuICAgICAgICAgICAgICAgIGZvbnRTaXplLFxuICAgICAgICAgICAgICAgIGZvbnQ6Rm9udC5GX01PTk9TUEFDRVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBUcmFuc2Zvcm0uY3JlYXRlKHRleHRFbnRpdHksIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQ6c2NyZWVuRW50aXR5LFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uOlZlY3RvcjMuY3JlYXRlKC4uLm5vcm1hbGl6ZWRQb3NpdGlvbilcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBkZXN0cm95OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGVuZ2luZS5yZW1vdmVFbnRpdHkodGV4dEVudGl0eSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldFRleHQ6ICh2YWx1ZTpzdHJpbmcpID0+IFRleHRTaGFwZS5nZXRNdXRhYmxlKHRleHRFbnRpdHkpLnRleHQgPSB2YWx1ZS50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIHNldFBpeGVsUG9zaXRpb246KHB4Om51bWJlcixweTpudW1iZXIpPT57XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRQb3NpdGlvbiA9IG5vcm1hbGl6ZVBpeGVsUG9zaXRpb25Gb3JUZXh0KHB4LHB5LCBsYXllcik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGV4dCBub3JtYWxpemVkUG9zaXRpb25cIixweCxweSxub3JtYWxpemVkUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtdXRhYmxlUG9zaXRpb24gPSBUcmFuc2Zvcm0uZ2V0TXV0YWJsZSh0ZXh0RW50aXR5KS5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgbXV0YWJsZVBvc2l0aW9uLnggPSBub3JtYWxpemVkUG9zaXRpb25bMF07XG4gICAgICAgICAgICAgICAgICAgIG11dGFibGVQb3NpdGlvbi55ID0gbm9ybWFsaXplZFBvc2l0aW9uWzFdO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaGlkZTogKCkgPT4gVHJhbnNmb3JtLmdldE11dGFibGUodGV4dEVudGl0eSkucG9zaXRpb24ueSA9IC0xMDAwMCxcbiAgICAgICAgICAgICAgICBzaG93OiAoKSA9PiBUcmFuc2Zvcm0uZ2V0TXV0YWJsZSh0ZXh0RW50aXR5KS5wb3NpdGlvbi55ID0gbm9ybWFsaXplZFBvc2l0aW9uWzFdXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVBpeGVsUG9zaXRpb25Gb3JUZXh0KHhQaXhlbHM6IG51bWJlciwgeVBpeGVsczogbnVtYmVyLCBsYXllcjogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICAgICAgKHhQaXhlbHMgLSAoc2NyZWVuU3ByaXRlRGVmaW5pdGlvbi53LzIpKSAqICgxIC8gc2NyZWVuU3ByaXRlRGVmaW5pdGlvbi53KSAsXG4gICAgICAgICAgICAgICAgICAgIC0oeVBpeGVscyArIChzY3JlZW5TcHJpdGVEZWZpbml0aW9uLmgvMikpICogKDEgLyBzY3JlZW5TcHJpdGVEZWZpbml0aW9uLmgpICsgMSxcbiAgICAgICAgICAgICAgICAgICAgLWxheWVyICogMC4wMDFcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBnZXRFbnRpdHk6ICgpID0+IHNjcmVlbkVudGl0eSxcbiAgICAgICAgaGlkZTooKT0+e1xuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUoc2NyZWVuRW50aXR5KS5wb3NpdGlvbi55ID0gTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVI7XG4gICAgICAgIH0sXG4gICAgICAgIHNob3c6KCk9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2hvdyBsb2JieSBzY3JlZW5cIiwgdHJhbnNmb3JtQmFja3VwLnBvc2l0aW9uPy55KVxuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUoc2NyZWVuRW50aXR5KS5wb3NpdGlvbi55ID0gKHRyYW5zZm9ybUJhY2t1cC5wb3NpdGlvbj8ueSB8fCAwKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVzdHJveTooKT0+e1xuICAgICAgICAgICAgZW5naW5lLnJlbW92ZUVudGl0eShzY3JlZW5FbnRpdHkpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTcHJpdGVQbGFuZSh7c3ByaXRlRGVmaW5pdGlvbiwgdHJhbnNmb3JtLCBzcHJpdGVNYXRlcmlhbH06IGFueSkge1xuICAgIGNvbnN0IHBsYW5lRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpO1xuXG4gICAgTWVzaFJlbmRlcmVyLnNldFBsYW5lKHBsYW5lRW50aXR5LCBnZXRVdnNGcm9tU3ByaXRlKHtcbiAgICAgICAgc3ByaXRlRGVmaW5pdGlvbiwgYmFjazogVVZTX0JBQ0suTUlSUk9SXG4gICAgfSkpO1xuICAgIFRyYW5zZm9ybS5jcmVhdGUocGxhbmVFbnRpdHksIHRyYW5zZm9ybSk7XG4gICAgTWF0ZXJpYWwuc2V0UGJyTWF0ZXJpYWwocGxhbmVFbnRpdHksIHNwcml0ZU1hdGVyaWFsKTtcblxuICAgIHJldHVybiBwbGFuZUVudGl0eTtcbn1cbiJdfQ==
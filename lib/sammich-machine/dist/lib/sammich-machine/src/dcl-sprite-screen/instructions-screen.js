import { engine, Material, MeshRenderer, TextShape, Transform, VideoPlayer } from "@dcl/sdk/ecs";
import { Vector3, Color3 } from "@dcl/sdk/math";
import { timers } from "@dcl-sdk/utils";
export const createInstructionScreen = ({ transform, gameAlias, gameInstructions, playerIndex }) => {
    console.log("createInstructionScreen", gameAlias);
    const state = {
        timeoutStartedTime: 0,
        waitingOther: false,
        timeout: 0
    };
    const { parent, position, rotation, scale } = transform;
    let screenEntity = engine.addEntity();
    const WAITING_BOTH_PLAYERS_TEXT = `<b>INSTRUCTIONS</b>:\n${gameInstructions}\n\n\n\nPress any key when you are ready to play`;
    const WAITING_ONE_PLAYER_TEXT = `<b>INSTRUCTIONS</b>:\n${gameInstructions}\n\n\n\nWaiting other player...`;
    const WAITING_FROM_NON_PLAYER = `<b>INSTRUCTIONS</b>:\n${gameInstructions}\n\n\n\nWaiting players ...`;
    MeshRenderer.setPlane(screenEntity);
    Transform.create(screenEntity, { parent, position, rotation, scale });
    VideoPlayer.create(screenEntity, {
        src: `instruction-videos/${gameAlias}.mp4`,
        playing: true,
    });
    const videoTexture = Material.Texture.Video({ videoPlayerEntity: screenEntity });
    Material.setPbrMaterial(screenEntity, {
        texture: videoTexture,
        roughness: 1.0,
        specularIntensity: 0,
        metallic: 0,
    });
    const instructionsTextEntity = engine.addEntity();
    TextShape.create(instructionsTextEntity, {
        text: ~playerIndex ? WAITING_BOTH_PLAYERS_TEXT : WAITING_FROM_NON_PLAYER,
        fontSize: 0.4,
        textAlign: 1,
        shadowColor: Color3.Black(),
        shadowOffsetY: 0.1,
        shadowOffsetX: 0.1,
        shadowBlur: 10
    });
    Transform.create(instructionsTextEntity, { parent: screenEntity, position: Vector3.create(0, 0.45, -0.001) });
    let countdownInterval = 0;
    const setTimeout = (timeout) => {
        console.log("countdown", setTimeout);
        state.timeout = timeout;
        if (countdownInterval)
            timers.clearInterval(countdownInterval);
        state.timeoutStartedTime = Date.now();
        countdownInterval = timers.setInterval(() => {
            if (~playerIndex) {
                if (state.waitingOther) {
                    TextShape.getMutable(instructionsTextEntity).text = WAITING_ONE_PLAYER_TEXT + `\n\n${formatTimeout(state.timeout - (Date.now() - state.timeoutStartedTime))}`;
                }
                else {
                    TextShape.getMutable(instructionsTextEntity).text = WAITING_BOTH_PLAYERS_TEXT + `\n\n${formatTimeout(state.timeout - (Date.now() - state.timeoutStartedTime))}`;
                }
            }
            else {
                TextShape.getMutable(instructionsTextEntity).text = WAITING_FROM_NON_PLAYER + `\n\n${formatTimeout(state.timeout - (Date.now() - state.timeoutStartedTime))}`;
            }
        }, 300);
    };
    return {
        destroy: () => {
            engine.removeEntity(instructionsTextEntity);
            engine.removeEntity(screenEntity);
            timers.clearInterval(countdownInterval);
            countdownInterval = 0;
            console.log("video screen destroy");
        },
        getState: () => state,
        showWaitingForOtherPlayer: ({ timeout = 20000 }) => {
            state.waitingOther = true;
            TextShape.getMutable(instructionsTextEntity).text = WAITING_ONE_PLAYER_TEXT;
            if (timeout) {
                setTimeout(timeout);
            }
        },
        setTimeout
    };
};
function formatTimeout(ms) {
    return `<b>${Math.max(0, Math.floor(ms / 1000))}</b>`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdHJ1Y3Rpb25zLXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9kY2wtc3ByaXRlLXNjcmVlbi9pbnN0cnVjdGlvbnMtc2NyZWVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBaUIsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFFOUcsT0FBTyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRXRDLE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFHLENBQ25DLEVBQ0ksU0FBUyxFQUNULFNBQVMsRUFDVCxnQkFBZ0IsRUFDaEIsV0FBVyxFQU1kLEVBQUUsRUFBRTtJQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDbEQsTUFBTSxLQUFLLEdBQUc7UUFDVixrQkFBa0IsRUFBQyxDQUFDO1FBQ3BCLFlBQVksRUFBQyxLQUFLO1FBQ2xCLE9BQU8sRUFBQyxDQUFDO0tBQ1osQ0FBQTtJQUNELE1BQU0sRUFBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUMsR0FBRyxTQUFTLENBQUM7SUFDdEQsSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3RDLE1BQU0seUJBQXlCLEdBQUcseUJBQXlCLGdCQUFnQixrREFBa0QsQ0FBQztJQUM5SCxNQUFNLHVCQUF1QixHQUFHLHlCQUF5QixnQkFBZ0IsaUNBQWlDLENBQUM7SUFDM0csTUFBTSx1QkFBdUIsR0FBRyx5QkFBeUIsZ0JBQWdCLDZCQUE2QixDQUFDO0lBRXZHLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFcEMsU0FB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RSxDQUFDO1lBQ2pLLENBQUM7UUFDTCxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDLENBQUM7SUFDRixPQUFPO1FBQ0gsT0FBTyxFQUFFLEdBQUcsRUFBRTtZQUNWLE1BQU0sQ0FBQyxZQUFZLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUN4QyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFDRCxRQUFRLEVBQUMsR0FBRSxFQUFFLENBQUEsS0FBSztRQUNsQix5QkFBeUIsRUFBQyxDQUFDLEVBQUMsT0FBTyxHQUFHLEtBQUssRUFBQyxFQUFDLEVBQUU7WUFDM0MsS0FBSyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7WUFDMUIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLElBQUksR0FBRyx1QkFBdUIsQ0FBQztZQUM1RSxJQUFHLE9BQU8sRUFBQyxDQUFDO2dCQUNSLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4QixDQUFDO1FBQ0wsQ0FBQztRQUNELFVBQVU7S0FDYixDQUFBO0FBQ0wsQ0FBQyxDQUFBO0FBRUQsU0FBUyxhQUFhLENBQUMsRUFBUztJQUM1QixPQUFPLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ3ZELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2VuZ2luZSwgTWF0ZXJpYWwsIE1lc2hSZW5kZXJlciwgVGV4dEFsaWduTW9kZSwgVGV4dFNoYXBlLCBUcmFuc2Zvcm0sIFZpZGVvUGxheWVyfSBmcm9tIFwiQGRjbC9zZGsvZWNzXCI7XG5pbXBvcnQge1RyYW5zZm9ybVR5cGV9IGZyb20gXCJAZGNsL2Vjcy9kaXN0L2NvbXBvbmVudHMvbWFudWFsL1RyYW5zZm9ybVwiO1xuaW1wb3J0IHtWZWN0b3IzLCBDb2xvcjN9IGZyb20gXCJAZGNsL3Nkay9tYXRoXCI7XG5pbXBvcnQge3RpbWVyc30gZnJvbSBcIkBkY2wtc2RrL3V0aWxzXCI7XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVJbnN0cnVjdGlvblNjcmVlbiA9IChcbiAgICB7XG4gICAgICAgIHRyYW5zZm9ybSxcbiAgICAgICAgZ2FtZUFsaWFzLFxuICAgICAgICBnYW1lSW5zdHJ1Y3Rpb25zLFxuICAgICAgICBwbGF5ZXJJbmRleFxuICAgIH06IHtcbiAgICAgICAgdHJhbnNmb3JtOiBUcmFuc2Zvcm1UeXBlLFxuICAgICAgICBnYW1lQWxpYXM6IHN0cmluZyxcbiAgICAgICAgZ2FtZUluc3RydWN0aW9uczogc3RyaW5nLFxuICAgICAgICBwbGF5ZXJJbmRleDogbnVtYmVyXG4gICAgfSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiY3JlYXRlSW5zdHJ1Y3Rpb25TY3JlZW5cIiwgZ2FtZUFsaWFzKTtcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgICAgdGltZW91dFN0YXJ0ZWRUaW1lOjAsXG4gICAgICAgIHdhaXRpbmdPdGhlcjpmYWxzZSxcbiAgICAgICAgdGltZW91dDowXG4gICAgfVxuICAgIGNvbnN0IHtwYXJlbnQsIHBvc2l0aW9uLCByb3RhdGlvbiwgc2NhbGV9ID0gdHJhbnNmb3JtO1xuICAgIGxldCBzY3JlZW5FbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KCk7XG4gICAgY29uc3QgV0FJVElOR19CT1RIX1BMQVlFUlNfVEVYVCA9IGA8Yj5JTlNUUlVDVElPTlM8L2I+OlxcbiR7Z2FtZUluc3RydWN0aW9uc31cXG5cXG5cXG5cXG5QcmVzcyBhbnkga2V5IHdoZW4geW91IGFyZSByZWFkeSB0byBwbGF5YDtcbiAgICBjb25zdCBXQUlUSU5HX09ORV9QTEFZRVJfVEVYVCA9IGA8Yj5JTlNUUlVDVElPTlM8L2I+OlxcbiR7Z2FtZUluc3RydWN0aW9uc31cXG5cXG5cXG5cXG5XYWl0aW5nIG90aGVyIHBsYXllci4uLmA7XG4gICAgY29uc3QgV0FJVElOR19GUk9NX05PTl9QTEFZRVIgPSBgPGI+SU5TVFJVQ1RJT05TPC9iPjpcXG4ke2dhbWVJbnN0cnVjdGlvbnN9XFxuXFxuXFxuXFxuV2FpdGluZyBwbGF5ZXJzIC4uLmA7XG5cbiAgICBNZXNoUmVuZGVyZXIuc2V0UGxhbmUoc2NyZWVuRW50aXR5KTtcblxuICAgIFRyYW5zZm9ybS5jcmVhdGUoc2NyZWVuRW50aXR5LCB7cGFyZW50LCBwb3NpdGlvbiwgcm90YXRpb24sIHNjYWxlfSk7XG5cbiAgICBWaWRlb1BsYXllci5jcmVhdGUoc2NyZWVuRW50aXR5LCB7XG4gICAgICAgIHNyYzogYGluc3RydWN0aW9uLXZpZGVvcy8ke2dhbWVBbGlhc30ubXA0YCxcbiAgICAgICAgcGxheWluZzogdHJ1ZSxcbiAgICB9KTtcbiAgICBjb25zdCB2aWRlb1RleHR1cmUgPSBNYXRlcmlhbC5UZXh0dXJlLlZpZGVvKHt2aWRlb1BsYXllckVudGl0eTogc2NyZWVuRW50aXR5fSlcbiAgICBNYXRlcmlhbC5zZXRQYnJNYXRlcmlhbChzY3JlZW5FbnRpdHksIHtcbiAgICAgICAgdGV4dHVyZTogdmlkZW9UZXh0dXJlLFxuICAgICAgICByb3VnaG5lc3M6IDEuMCxcbiAgICAgICAgc3BlY3VsYXJJbnRlbnNpdHk6IDAsXG4gICAgICAgIG1ldGFsbGljOiAwLFxuICAgIH0pO1xuXG4gICAgY29uc3QgaW5zdHJ1Y3Rpb25zVGV4dEVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKTtcbiAgICBUZXh0U2hhcGUuY3JlYXRlKGluc3RydWN0aW9uc1RleHRFbnRpdHksIHtcbiAgICAgICAgdGV4dDp+cGxheWVySW5kZXg/V0FJVElOR19CT1RIX1BMQVlFUlNfVEVYVDpXQUlUSU5HX0ZST01fTk9OX1BMQVlFUixcbiAgICAgICAgZm9udFNpemU6MC40LFxuICAgICAgICB0ZXh0QWxpZ246VGV4dEFsaWduTW9kZS5UQU1fVE9QX0NFTlRFUixcbiAgICAgICAgc2hhZG93Q29sb3I6Q29sb3IzLkJsYWNrKCksXG4gICAgICAgIHNoYWRvd09mZnNldFk6MC4xLFxuICAgICAgICBzaGFkb3dPZmZzZXRYOjAuMSxcbiAgICAgICAgc2hhZG93Qmx1cjoxMFxuICAgIH0pO1xuICAgIFRyYW5zZm9ybS5jcmVhdGUoaW5zdHJ1Y3Rpb25zVGV4dEVudGl0eSwge3BhcmVudDpzY3JlZW5FbnRpdHksIHBvc2l0aW9uOlZlY3RvcjMuY3JlYXRlKDAsIDAuNDUsLTAuMDAxKX0pO1xuICAgIGxldCBjb3VudGRvd25JbnRlcnZhbDpudW1iZXIgPSAwO1xuICAgIGNvbnN0IHNldFRpbWVvdXQgPSAodGltZW91dDpudW1iZXIpPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcImNvdW50ZG93blwiLHNldFRpbWVvdXQpXG4gICAgICAgIHN0YXRlLnRpbWVvdXQgPSB0aW1lb3V0O1xuICAgICAgICBpZihjb3VudGRvd25JbnRlcnZhbCkgdGltZXJzLmNsZWFySW50ZXJ2YWwoY291bnRkb3duSW50ZXJ2YWwpO1xuICAgICAgICBzdGF0ZS50aW1lb3V0U3RhcnRlZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICBjb3VudGRvd25JbnRlcnZhbCA9IHRpbWVycy5zZXRJbnRlcnZhbCgoKT0+e1xuICAgICAgICAgICAgaWYofnBsYXllckluZGV4KXtcbiAgICAgICAgICAgICAgICBpZihzdGF0ZS53YWl0aW5nT3RoZXIpe1xuICAgICAgICAgICAgICAgICAgICBUZXh0U2hhcGUuZ2V0TXV0YWJsZShpbnN0cnVjdGlvbnNUZXh0RW50aXR5KS50ZXh0ID0gV0FJVElOR19PTkVfUExBWUVSX1RFWFQgKyBgXFxuXFxuJHtmb3JtYXRUaW1lb3V0KHN0YXRlLnRpbWVvdXQgLSAoRGF0ZS5ub3coKSAtIHN0YXRlLnRpbWVvdXRTdGFydGVkVGltZSkpfWA7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKGluc3RydWN0aW9uc1RleHRFbnRpdHkpLnRleHQgPSBXQUlUSU5HX0JPVEhfUExBWUVSU19URVhUKyBgXFxuXFxuJHtmb3JtYXRUaW1lb3V0KHN0YXRlLnRpbWVvdXQgLSAoRGF0ZS5ub3coKSAtIHN0YXRlLnRpbWVvdXRTdGFydGVkVGltZSkpfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUoaW5zdHJ1Y3Rpb25zVGV4dEVudGl0eSkudGV4dCA9IFdBSVRJTkdfRlJPTV9OT05fUExBWUVSKyBgXFxuXFxuJHtmb3JtYXRUaW1lb3V0KHN0YXRlLnRpbWVvdXQgLSAoRGF0ZS5ub3coKSAtIHN0YXRlLnRpbWVvdXRTdGFydGVkVGltZSkpfWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDMwMCk7XG4gICAgfTtcbiAgICByZXR1cm4ge1xuICAgICAgICBkZXN0cm95OiAoKSA9PiB7XG4gICAgICAgICAgICBlbmdpbmUucmVtb3ZlRW50aXR5KGluc3RydWN0aW9uc1RleHRFbnRpdHkpO1xuICAgICAgICAgICAgZW5naW5lLnJlbW92ZUVudGl0eShzY3JlZW5FbnRpdHkpO1xuICAgICAgICAgICAgdGltZXJzLmNsZWFySW50ZXJ2YWwoY291bnRkb3duSW50ZXJ2YWwpO1xuICAgICAgICAgICAgY291bnRkb3duSW50ZXJ2YWwgPSAwO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ2aWRlbyBzY3JlZW4gZGVzdHJveVwiKVxuICAgICAgICB9LFxuICAgICAgICBnZXRTdGF0ZTooKT0+c3RhdGUsXG4gICAgICAgIHNob3dXYWl0aW5nRm9yT3RoZXJQbGF5ZXI6KHt0aW1lb3V0ID0gMjAwMDB9KT0+e1xuICAgICAgICAgICAgc3RhdGUud2FpdGluZ090aGVyID0gdHJ1ZTtcbiAgICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKGluc3RydWN0aW9uc1RleHRFbnRpdHkpLnRleHQgPSBXQUlUSU5HX09ORV9QTEFZRVJfVEVYVDtcbiAgICAgICAgICAgIGlmKHRpbWVvdXQpe1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHNldFRpbWVvdXRcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFRpbWVvdXQobXM6bnVtYmVyKXtcbiAgICByZXR1cm4gYDxiPiR7TWF0aC5tYXgoMCxNYXRoLmZsb29yKG1zLzEwMDApKX08L2I+YDtcbn0iXX0=
import { SPRITE_SHEET_DIMENSION } from "../lib/sprite-constants";
const PIXELS_MOVEMENT = 8;
const INITIAL_BASE_POSITION_X = (192 / 2) / 2 - (16 / 2);
const INGREDIENT_FRAMES = [1, 2, 3, 5, 6, 7];
const LEVEL_VELOCITY = [30, 60, 70, 80, 90];
const LEVEL_SPAWN_DELAY = [2000, 1000, 600, 400, 300];
export const SammichGame = {
    definition: {
        alias: "sammich-game",
        split: true,
        fps: 60,
        instructions: "Perfect sammich is when ingredients\n are aligned with bread.\nMove to sides with <color=#ffff00><b>E - F</b></color> keys"
    },
    run: ({ game }) => {
        const state = {
            score: 0,
            level: 0,
            ingredientsToFall: 3,
            sammichCompleted: false
        };
        console.log("SammichGame", game.runtime.getPlayerIndex(), game.runtime.getState().lastReproducedFrame);
        game.setScreenSprite({
            spriteDefinition: {
                x: 0,
                y: 128,
                w: 96,
                h: 128,
                ...SPRITE_SHEET_DIMENSION
            }
        });
        const BaseSpriteEntity = game.registerSpriteEntity({
            klass: "SammichBase",
            spriteDefinition: {
                x: 0,
                y: 512,
                w: 16,
                h: 16,
                ...SPRITE_SHEET_DIMENSION,
                columns: 9, frames: 9
            },
            collisionBox: { x: 0, y: 13, w: 16, h: 3 }
        });
        const baseSprite = BaseSpriteEntity.create({
            pixelPosition: [INITIAL_BASE_POSITION_X, 90],
            layer: 2,
            network: true
        });
        const spawner = game.createSpawner(BaseSpriteEntity, {
            pixelPosition: [INITIAL_BASE_POSITION_X, 0],
            pixelsPerSecond: [0, LEVEL_VELOCITY[state.level]],
            layer: 3,
            stopOnCollision: true,
            spawnIntervalMs: LEVEL_SPAWN_DELAY[state.level],
            spawnRandomFrame: INGREDIENT_FRAMES,
            autoStart: false
        });
        const FRAMES_PER_SECOND = game.runtime.getFps();
        game.setWinnerFn((player1Score, player2Score) => {
            console.log("winnerFn", state.level, player1Score, player2Score);
            if (state.level > 0 && player1Score > player2Score)
                return { winnerIndex: 0 };
            if (state.level > 0 && player1Score < player2Score)
                return { winnerIndex: 1 };
        });
        baseSprite.applyFrame(4);
        game.onFinish(() => {
            console.log("listened finished mini-game from mini-game code");
        });
        spawner.onSpawn((spawnedEntity) => {
            const possibleOffsets = [-PIXELS_MOVEMENT, 0, +PIXELS_MOVEMENT];
            const spawnedIngredients = game.getSpriteEntities().filter((i) => spawner.isSpawned(i)).length;
            const spawnRandomFrame = spawnedIngredients > state.ingredientsToFall ? [8] : INGREDIENT_FRAMES;
            const spawnIntervalMs = spawnedIngredients > (state.ingredientsToFall + 1) ? 0 : LEVEL_SPAWN_DELAY[state.level];
            spawner.setOptions({
                pixelPosition: [INITIAL_BASE_POSITION_X + possibleOffsets[Math.floor(game.random() * 2)], 0],
                spawnRandomFrame,
                spawnIntervalMs
            });
        });
        spawner.onStop(async (spriteEntity) => {
            const lockedIngredients = game.getSpriteEntities().filter((i) => spawner.isLocked(i)).length;
            if (baseSprite.getPixelPosition()[0] === spriteEntity.getPixelPosition()[0]) {
                state.score++;
                game.setPlayerScore(state.score);
            }
            if (lockedIngredients > (state.ingredientsToFall + 1)) {
                console.log("SAMMICH COMPLETED");
                await game.waitFrames(FRAMES_PER_SECOND);
                spawner.cleanSprites();
                baseSprite.sprite.hide();
                spawner.stop();
                await game.waitFrames(FRAMES_PER_SECOND);
                baseSprite.sprite.show();
                if (state.level < (LEVEL_VELOCITY.length - 1)) {
                    state.level++;
                }
                state.ingredientsToFall += 2;
                spawner.setOptions({
                    pixelsPerSecond: [0, LEVEL_VELOCITY[state.level]],
                    spawnIntervalMs: LEVEL_SPAWN_DELAY[state.level],
                    spawnRandomFrame: INGREDIENT_FRAMES
                });
                spawner.start();
                game.checkWinners();
            }
        });
        game.onStart(async ({ seed }) => {
            console.log("game.onStart", seed);
        });
        game.onInput(({ inputActionKey, isPressed, time, playerIndex }) => {
            if (!isPressed)
                return;
            const [px, py] = baseSprite.getPixelPosition();
            const lockedIngredients = game.getSpriteEntities().filter((i) => spawner.isLocked(i));
            if (inputActionKey === 1 && px > (INITIAL_BASE_POSITION_X - PIXELS_MOVEMENT)) {
                baseSprite.setPixelPosition(px - PIXELS_MOVEMENT, py);
                lockedIngredients.forEach((spriteEntity) => {
                    const [px, py] = spriteEntity.getPixelPosition();
                    spriteEntity.setPixelPosition(px - PIXELS_MOVEMENT, py);
                });
            }
            else if (inputActionKey === 2 && px < (INITIAL_BASE_POSITION_X + PIXELS_MOVEMENT)) {
                baseSprite.setPixelPosition(px + PIXELS_MOVEMENT, py);
                lockedIngredients.forEach((spriteEntity) => {
                    const [px, py] = spriteEntity.getPixelPosition();
                    spriteEntity.setPixelPosition(px + PIXELS_MOVEMENT, py);
                });
            }
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FtbWljaC1nYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vZ2FtZXMvc2FtbWljaC1nYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBRS9ELE1BQU0sZUFBZSxHQUFHLENBQUMsQ0FBQztBQUMxQixNQUFNLHVCQUF1QixHQUFHLENBQUMsR0FBRyxHQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuRCxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQztBQUN4QyxNQUFNLGNBQWMsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLGlCQUFpQixHQUFHLENBQUMsSUFBSSxFQUFDLElBQUksRUFBQyxHQUFHLEVBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRW5ELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRztJQUN2QixVQUFVLEVBQUM7UUFDUCxLQUFLLEVBQUMsY0FBYztRQUNwQixLQUFLLEVBQUMsSUFBSTtRQUNWLEdBQUcsRUFBQyxFQUFFO1FBQ04sWUFBWSxFQUFDLDRIQUE0SDtLQUM1STtJQUNELEdBQUcsRUFBQyxDQUFDLEVBQUMsSUFBSSxFQUFLLEVBQUMsRUFBRTtRQUNkLE1BQU0sS0FBSyxHQUFHO1lBQ1YsS0FBSyxFQUFDLENBQUM7WUFDUCxLQUFLLEVBQUMsQ0FBQztZQUNQLGlCQUFpQixFQUFDLENBQUM7WUFDbkIsZ0JBQWdCLEVBQUMsS0FBSztTQUN6QixDQUFDO1FBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FB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QUFZLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztvQkFDaEQsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsR0FBQyxlQUFlLEVBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3pELENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0lucHV0QWN0aW9ufSBmcm9tIFwiQGRjbC9zZGsvZWNzXCI7Ly9UT0RPIFJFVklFVyBpZiB0byByZW1vdmUgY291cGxpbmcgdG8gU0RLXG5pbXBvcnQge1Nwcml0ZUVudGl0eX0gZnJvbSBcIi4uL2xpYi9nYW1lLWVudGl0aWVzXCI7XG5pbXBvcnQge2dldEZyYW1lTnVtYmVyfSBmcm9tIFwiLi4vbGliL2ZyYW1lLXV0aWxcIjtcbmltcG9ydCB7Q29sb3IzfSBmcm9tIFwiQGRjbC9zZGsvbWF0aFwiO1xuaW1wb3J0IHtTUFJJVEVfU0hFRVRfRElNRU5TSU9OfSBmcm9tIFwiLi4vbGliL3Nwcml0ZS1jb25zdGFudHNcIjtcblxuY29uc3QgUElYRUxTX01PVkVNRU5UID0gODtcbmNvbnN0IElOSVRJQUxfQkFTRV9QT1NJVElPTl9YID0gKDE5Mi8yKS8yIC0gKDE2LzIpO1xuY29uc3QgSU5HUkVESUVOVF9GUkFNRVMgPSBbMSwyLDMsNSw2LDddO1xuY29uc3QgTEVWRUxfVkVMT0NJVFkgPSBbMzAsIDYwLCA3MCwgODAsIDkwXTtcbmNvbnN0IExFVkVMX1NQQVdOX0RFTEFZID0gWzIwMDAsMTAwMCw2MDAsNDAwLCAzMDBdO1xuXG5leHBvcnQgY29uc3QgU2FtbWljaEdhbWUgPSB7XG4gICAgZGVmaW5pdGlvbjp7XG4gICAgICAgIGFsaWFzOlwic2FtbWljaC1nYW1lXCIsXG4gICAgICAgIHNwbGl0OnRydWUsXG4gICAgICAgIGZwczo2MCxcbiAgICAgICAgaW5zdHJ1Y3Rpb25zOlwiUGVyZmVjdCBzYW1taWNoIGlzIHdoZW4gaW5ncmVkaWVudHNcXG4gYXJlIGFsaWduZWQgd2l0aCBicmVhZC5cXG5Nb3ZlIHRvIHNpZGVzIHdpdGggPGNvbG9yPSNmZmZmMDA+PGI+RSAtIEY8L2I+PC9jb2xvcj4ga2V5c1wiXG4gICAgfSxcbiAgICBydW46KHtnYW1lfTphbnkpPT57XG4gICAgICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICAgICAgc2NvcmU6MCxcbiAgICAgICAgICAgIGxldmVsOjAsXG4gICAgICAgICAgICBpbmdyZWRpZW50c1RvRmFsbDozLFxuICAgICAgICAgICAgc2FtbWljaENvbXBsZXRlZDpmYWxzZVxuICAgICAgICB9O1xuICAgICAgICBjb25zb2xlLmxvZyhcIlNhbW1pY2hHYW1lXCIsIGdhbWUucnVudGltZS5nZXRQbGF5ZXJJbmRleCgpICxnYW1lLnJ1bnRpbWUuZ2V0U3RhdGUoKS5sYXN0UmVwcm9kdWNlZEZyYW1lKTtcbiAgICAgICAgZ2FtZS5zZXRTY3JlZW5TcHJpdGUoe1xuICAgICAgICAgICAgc3ByaXRlRGVmaW5pdGlvbjp7XG4gICAgICAgICAgICAgICAgeDowLFxuICAgICAgICAgICAgICAgIHk6MTI4LFxuICAgICAgICAgICAgICAgIHc6OTYsXG4gICAgICAgICAgICAgICAgaDoxMjgsXG4gICAgICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTlxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IEJhc2VTcHJpdGVFbnRpdHkgPSBnYW1lLnJlZ2lzdGVyU3ByaXRlRW50aXR5KHtcbiAgICAgICAgICAgIGtsYXNzOlwiU2FtbWljaEJhc2VcIixcbiAgICAgICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgICAgIHg6MCxcbiAgICAgICAgICAgICAgICB5OjUxMixcbiAgICAgICAgICAgICAgICB3OjE2LFxuICAgICAgICAgICAgICAgIGg6MTYsXG4gICAgICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTixcbiAgICAgICAgICAgICAgICBjb2x1bW5zOjksIGZyYW1lczo5XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29sbGlzaW9uQm94Ont4OjAsIHk6MTMsIHc6MTYsIGg6MyB9XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBiYXNlU3ByaXRlID0gQmFzZVNwcml0ZUVudGl0eS5jcmVhdGUoe1xuICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbjpbSU5JVElBTF9CQVNFX1BPU0lUSU9OX1gsIDkwXSxcbiAgICAgICAgICAgIGxheWVyOjIsXG4gICAgICAgICAgICBuZXR3b3JrOnRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc3Bhd25lciA9IGdhbWUuY3JlYXRlU3Bhd25lcihcbiAgICAgICAgICAgIEJhc2VTcHJpdGVFbnRpdHksXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbjpbSU5JVElBTF9CQVNFX1BPU0lUSU9OX1gsIDBdLFxuICAgICAgICAgICAgICAgIHBpeGVsc1BlclNlY29uZDpbMCxMRVZFTF9WRUxPQ0lUWVtzdGF0ZS5sZXZlbF1dLFxuICAgICAgICAgICAgICAgIGxheWVyOjMsXG4gICAgICAgICAgICAgICAgc3RvcE9uQ29sbGlzaW9uOnRydWUsXG4gICAgICAgICAgICAgICAgc3Bhd25JbnRlcnZhbE1zOkxFVkVMX1NQQVdOX0RFTEFZW3N0YXRlLmxldmVsXSxcbiAgICAgICAgICAgICAgICBzcGF3blJhbmRvbUZyYW1lOklOR1JFRElFTlRfRlJBTUVTLFxuICAgICAgICAgICAgICAgIGF1dG9TdGFydDpmYWxzZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICBjb25zdCBGUkFNRVNfUEVSX1NFQ09ORCA9IGdhbWUucnVudGltZS5nZXRGcHMoKTtcblxuICAgICAgICBnYW1lLnNldFdpbm5lckZuKChwbGF5ZXIxU2NvcmU6bnVtYmVyLCBwbGF5ZXIyU2NvcmU6bnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIndpbm5lckZuXCIsIHN0YXRlLmxldmVsLCBwbGF5ZXIxU2NvcmUsIHBsYXllcjJTY29yZSk7XG4gICAgICAgICAgICBpZiggc3RhdGUubGV2ZWwgPiAwICYmIHBsYXllcjFTY29yZSA+IHBsYXllcjJTY29yZSkgcmV0dXJuIHt3aW5uZXJJbmRleDowfTtcbiAgICAgICAgICAgIGlmKCBzdGF0ZS5sZXZlbCA+IDAgJiYgcGxheWVyMVNjb3JlIDwgcGxheWVyMlNjb3JlKSByZXR1cm4ge3dpbm5lckluZGV4OjF9O1xuICAgICAgICB9KTtcblxuICAgICAgICBiYXNlU3ByaXRlLmFwcGx5RnJhbWUoNCk7XG4gICAgICAgIGdhbWUub25GaW5pc2goKCk9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibGlzdGVuZWQgZmluaXNoZWQgbWluaS1nYW1lIGZyb20gbWluaS1nYW1lIGNvZGVcIik7XG4gICAgICAgIH0pO1xuICAgICAgICBzcGF3bmVyLm9uU3Bhd24oKHNwYXduZWRFbnRpdHk6U3ByaXRlRW50aXR5KT0+e1xuICAgICAgICAgICAgY29uc3QgcG9zc2libGVPZmZzZXRzID0gWy1QSVhFTFNfTU9WRU1FTlQsIDAsICtQSVhFTFNfTU9WRU1FTlRdO1xuICAgICAgICAgICAgY29uc3Qgc3Bhd25lZEluZ3JlZGllbnRzID0gZ2FtZS5nZXRTcHJpdGVFbnRpdGllcygpLmZpbHRlcigoaTpTcHJpdGVFbnRpdHkpPT5zcGF3bmVyLmlzU3Bhd25lZChpKSkubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3Qgc3Bhd25SYW5kb21GcmFtZSA9IHNwYXduZWRJbmdyZWRpZW50cyA+IHN0YXRlLmluZ3JlZGllbnRzVG9GYWxsID8gWzhdOklOR1JFRElFTlRfRlJBTUVTO1xuICAgICAgICAgICAgY29uc3Qgc3Bhd25JbnRlcnZhbE1zID0gc3Bhd25lZEluZ3JlZGllbnRzID4gKHN0YXRlLmluZ3JlZGllbnRzVG9GYWxsKzEpID8gMCA6IExFVkVMX1NQQVdOX0RFTEFZW3N0YXRlLmxldmVsXTtcblxuICAgICAgICAgICAgc3Bhd25lci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgICAgICBwaXhlbFBvc2l0aW9uOltJTklUSUFMX0JBU0VfUE9TSVRJT05fWCArIHBvc3NpYmxlT2Zmc2V0c1tNYXRoLmZsb29yKGdhbWUucmFuZG9tKCkqMildLCAwXSxcbiAgICAgICAgICAgICAgICBzcGF3blJhbmRvbUZyYW1lLFxuICAgICAgICAgICAgICAgIHNwYXduSW50ZXJ2YWxNc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNwYXduZXIub25TdG9wKGFzeW5jIChzcHJpdGVFbnRpdHk6U3ByaXRlRW50aXR5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsb2NrZWRJbmdyZWRpZW50cyA9IGdhbWUuZ2V0U3ByaXRlRW50aXRpZXMoKS5maWx0ZXIoKGk6U3ByaXRlRW50aXR5KT0+c3Bhd25lci5pc0xvY2tlZChpKSkubGVuZ3RoO1xuXG4gICAgICAgICAgICBpZihiYXNlU3ByaXRlLmdldFBpeGVsUG9zaXRpb24oKVswXSA9PT0gc3ByaXRlRW50aXR5LmdldFBpeGVsUG9zaXRpb24oKVswXSl7XG4gICAgICAgICAgICAgICAgc3RhdGUuc2NvcmUrKztcbiAgICAgICAgICAgICAgICBnYW1lLnNldFBsYXllclNjb3JlKHN0YXRlLnNjb3JlKTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICBpZihsb2NrZWRJbmdyZWRpZW50cyA+IChzdGF0ZS5pbmdyZWRpZW50c1RvRmFsbCArIDEpKXtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlNBTU1JQ0ggQ09NUExFVEVEXCIpO1xuICAgICAgICAgICAgICAgIGF3YWl0IGdhbWUud2FpdEZyYW1lcyhGUkFNRVNfUEVSX1NFQ09ORCApOy8vVE9ETyBkb250IHVzZSBhd2FpdCwgaXQgc2hvdWxkIGJlIHN5bmNocm9ub3VzP1xuICAgICAgICAgICAgICAgIHNwYXduZXIuY2xlYW5TcHJpdGVzKCk7XG4gICAgICAgICAgICAgICAgYmFzZVNwcml0ZS5zcHJpdGUuaGlkZSgpO1xuICAgICAgICAgICAgICAgIHNwYXduZXIuc3RvcCgpO1xuICAgICAgICAgICAgICAgIGF3YWl0IGdhbWUud2FpdEZyYW1lcyggRlJBTUVTX1BFUl9TRUNPTkQgKTtcbiAgICAgICAgICAgICAgICBiYXNlU3ByaXRlLnNwcml0ZS5zaG93KCk7XG4gICAgICAgICAgICAgICAgaWYoc3RhdGUubGV2ZWwgPCAoTEVWRUxfVkVMT0NJVFkubGVuZ3RoLTEpKXtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubGV2ZWwrKztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUuaW5ncmVkaWVudHNUb0ZhbGwrPTI7XG4gICAgICAgICAgICAgICAgc3Bhd25lci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgICAgICAgICAgcGl4ZWxzUGVyU2Vjb25kOlswLExFVkVMX1ZFTE9DSVRZW3N0YXRlLmxldmVsXV0sXG4gICAgICAgICAgICAgICAgICAgIHNwYXduSW50ZXJ2YWxNczpMRVZFTF9TUEFXTl9ERUxBWVtzdGF0ZS5sZXZlbF0sXG4gICAgICAgICAgICAgICAgICAgIHNwYXduUmFuZG9tRnJhbWU6SU5HUkVESUVOVF9GUkFNRVNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBzcGF3bmVyLnN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgZ2FtZS5jaGVja1dpbm5lcnMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZ2FtZS5vblN0YXJ0KGFzeW5jICh7c2VlZH06YW55KT0+e1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJnYW1lLm9uU3RhcnRcIiwgc2VlZCk7XG4gICAgICAgICAgICAvL3NwYXduZXIuc3Bhd24oe2xheWVyOjN9KTtcbiAgICAgICAgICAgIC8vc3Bhd25lci5zdGFydCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgZ2FtZS5vbklucHV0KCh7aW5wdXRBY3Rpb25LZXksIGlzUHJlc3NlZCwgdGltZSwgcGxheWVySW5kZXh9OmFueSkgPT4ge1xuICAgICAgICAgICAgaWYoIWlzUHJlc3NlZCkgcmV0dXJuO1xuXG4gICAgICAgICAgICBjb25zdCBbcHgscHldID0gYmFzZVNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKCk7XG4gICAgICAgICAgICBjb25zdCBsb2NrZWRJbmdyZWRpZW50cyA9IGdhbWUuZ2V0U3ByaXRlRW50aXRpZXMoKS5maWx0ZXIoKGk6U3ByaXRlRW50aXR5KT0+c3Bhd25lci5pc0xvY2tlZChpKSlcbiAgICAgICAgICAgIGlmKGlucHV0QWN0aW9uS2V5ID09PSBJbnB1dEFjdGlvbi5JQV9QUklNQVJZICYmIHB4ID4gKElOSVRJQUxfQkFTRV9QT1NJVElPTl9YLVBJWEVMU19NT1ZFTUVOVCkpe1xuICAgICAgICAgICAgICAgIGJhc2VTcHJpdGUuc2V0UGl4ZWxQb3NpdGlvbihweC1QSVhFTFNfTU9WRU1FTlQsIHB5KTtcblxuICAgICAgICAgICAgICAgIGxvY2tlZEluZ3JlZGllbnRzLmZvckVhY2goKHNwcml0ZUVudGl0eTpTcHJpdGVFbnRpdHkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW3B4LHB5XSA9IHNwcml0ZUVudGl0eS5nZXRQaXhlbFBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZUVudGl0eS5zZXRQaXhlbFBvc2l0aW9uKHB4LVBJWEVMU19NT1ZFTUVOVCxweSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1lbHNlIGlmKGlucHV0QWN0aW9uS2V5ID09PSBJbnB1dEFjdGlvbi5JQV9TRUNPTkRBUlkgJiYgcHggPCAoSU5JVElBTF9CQVNFX1BPU0lUSU9OX1grUElYRUxTX01PVkVNRU5UKSl7XG4gICAgICAgICAgICAgICAgYmFzZVNwcml0ZS5zZXRQaXhlbFBvc2l0aW9uKHB4K1BJWEVMU19NT1ZFTUVOVCwgcHkpO1xuICAgICAgICAgICAgICAgIGxvY2tlZEluZ3JlZGllbnRzLmZvckVhY2goKHNwcml0ZUVudGl0eTpTcHJpdGVFbnRpdHkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW3B4LHB5XSA9IHNwcml0ZUVudGl0eS5nZXRQaXhlbFBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZUVudGl0eS5zZXRQaXhlbFBvc2l0aW9uKHB4K1BJWEVMU19NT1ZFTUVOVCxweSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn0iXX0=
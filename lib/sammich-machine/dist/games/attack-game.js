import { createScoreTextComponent, updateScoreTextComponent } from "./utils/mini-game-score";
const SPRITE_SHEET_SIZE = 1024;
const SPRITE_SHEET_DIMENSION = {
    spriteSheetWidth: SPRITE_SHEET_SIZE,
    spriteSheetHeight: SPRITE_SHEET_SIZE,
};
const WAIT_FOR_OTHER_PLAYER_RESPONSE_FRAMES = 60 * 2;
async function run({ game }) {
    const state = {
        keyAppearTime: 0,
        playerMovedTime: [0, 0],
        playerMovedKey: [0, 0],
        firstMoveReceivedAtFrame: 0,
        resolvingWinner: false,
        keyToPress: -1,
        showingKey: false,
        score: [0, 0]
    };
    game.setWinnerFn((player1Score, player2Score) => {
        if ((player1Score + player2Score) >= 5) {
            if (player1Score > player2Score)
                return { winnerIndex: 0 };
            if (player1Score < player2Score)
                return { winnerIndex: 1 };
        }
    });
    createScoreTextComponent(game);
    game.setScreenSprite({
        spriteDefinition: {
            x: 576,
            y: 0,
            w: 192,
            h: 128,
            ...SPRITE_SHEET_DIMENSION
        }
    });
    const WomanSprite = game.registerSpriteEntity({
        klass: "Woman",
        spriteDefinition: {
            x: 0, y: 640, w: 63, h: 69, columns: 3, frames: 3,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const w1 = WomanSprite.create({
        pixelPosition: [192 / 4 * 1 - Math.floor(WomanSprite.spriteDefinition.w / 2) + 10, 45],
        layer: 1,
        network: true
    });
    const w2 = WomanSprite.create({
        pixelPosition: [192 / 4 * 3 - Math.floor(WomanSprite.spriteDefinition.w / 2) - 10, 45],
        layer: 1,
        network: true
    });
    const womenAttack = game.registerSpriteEntity({
        klass: "Woman",
        spriteDefinition: {
            x: 193, y: 640, w: 96, h: 69,
            ...SPRITE_SHEET_DIMENSION,
        }
    }).create({
        pixelPosition: [192 / 2 - 96 / 2, 45],
        layer: 5,
        network: true
    });
    womenAttack.hide();
    const KeySprite = game.registerSpriteEntity({
        klass: "Key",
        spriteDefinition: {
            x: 96, y: 388,
            w: 18, h: 24, columns: 3, frames: 3,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const CrossSprite = game.registerSpriteEntity({
        klass: "Cross",
        spriteDefinition: {
            x: 176, y: 512,
            w: 16, h: 16,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const c1 = CrossSprite.create({
        pixelPosition: [192 / 4 * 1 - Math.floor(KeySprite.spriteDefinition.w / 2) + 10, 24],
        layer: 5,
        network: true
    });
    const c2 = CrossSprite.create({
        pixelPosition: [192 / 4 * 3 - Math.floor(KeySprite.spriteDefinition.w / 2) - 10, 24],
        layer: 5,
        network: true
    });
    const t1 = game.addText({
        text: ``,
        pixelPosition: [192 / 4 * 1 - Math.floor(KeySprite.spriteDefinition.w / 2) + 10 - 20, 114],
        fontSize: 1,
        textColor: [1, 1, 1, 1]
    });
    const t2 = game.addText({
        text: ``,
        pixelPosition: [192 / 4 * 3 - Math.floor(KeySprite.spriteDefinition.w / 2) - 10 - 20, 114],
        fontSize: 1,
        textColor: [1, 1, 1, 1]
    });
    const timeTexts = [t1, t2];
    c1.hide();
    c2.hide();
    const k1 = KeySprite.create({
        pixelPosition: [192 / 4 * 1 - Math.floor(KeySprite.spriteDefinition.w / 2) + 10, 20],
        layer: 4,
        network: true
    });
    const k2 = KeySprite.create({
        pixelPosition: [192 / 4 * 3 - Math.floor(KeySprite.spriteDefinition.w / 2) - 10, 20],
        layer: 4,
        network: true
    });
    const women = [w1, w2];
    const crosses = [c1, c2];
    const keys = [k1, k2];
    w2.setZoom([-1, 1]);
    game.onInput(async ({ inputActionKey, isPressed, time, playerIndex, frameNumber }) => {
        console.log("onInput frameNumber", frameNumber);
        if (!state.showingKey)
            return;
        if (state.playerMovedTime[playerIndex])
            return;
        state.playerMovedTime[playerIndex] = time;
        state.playerMovedKey[playerIndex] = inputActionKey;
        state.firstMoveReceivedAtFrame = state.firstMoveReceivedAtFrame || game.runtime.getState().lastReproducedFrame;
        if (isPressed) {
            if (inputActionKey !== state.keyToPress) {
                crosses[playerIndex].show();
            }
            women[playerIndex].applyFrame(1);
        }
    });
    game.onFrame(checkAttackMove);
    await setupKey();
    async function checkAttackMove(frameNumber) {
        if (!state.showingKey)
            return;
        if (!state.firstMoveReceivedAtFrame)
            return;
        if (state.resolvingWinner)
            return;
        let winnerIndex = -1;
        if (state.playerMovedTime.every(i => i)) {
            if (state.playerMovedKey.every(i => i === state.keyToPress)) {
                winnerIndex = state.playerMovedTime[0] < state.playerMovedTime[1] ? 0 : 1;
            }
            else if (state.playerMovedKey.some(i => i === state.keyToPress)) {
                winnerIndex = state.playerMovedKey.findIndex(i => i === state.keyToPress);
            }
            else if (state.playerMovedKey.every(i => i !== state.keyToPress)) {
                winnerIndex = state.playerMovedTime[0] > state.playerMovedTime[1] ? 0 : 1;
            }
        }
        else if (state.firstMoveReceivedAtFrame && ((frameNumber - state.firstMoveReceivedAtFrame) > WAIT_FOR_OTHER_PLAYER_RESPONSE_FRAMES)) {
            const playerAnswered = state.playerMovedTime.findIndex(i => i);
            if (playerAnswered >= 0) {
                if (state.playerMovedKey[playerAnswered] === state.keyToPress) {
                    winnerIndex = playerAnswered;
                }
                else {
                    winnerIndex = playerAnswered === 0 ? 1 : 0;
                }
            }
        }
        if (winnerIndex >= 0) {
            state.resolvingWinner = true;
            console.log("setPlayerScore");
            game.players[winnerIndex].setPlayerScore(++state.score[winnerIndex]);
            women.forEach(w => w.hide());
            womenAttack.setZoom([winnerIndex ? -1 : 1, 1]);
            womenAttack.show();
            console.log("times", state.keyAppearTime, state.playerMovedTime[0]);
            timeTexts.forEach((t, index) => state.playerMovedTime[index] && t.setText(formatTime(state.playerMovedTime[index] - state.keyAppearTime)));
            updateScoreTextComponent();
            await game.waitFrames(60);
            setupKey();
            game.checkWinners();
        }
    }
    async function setupKey() {
        state.firstMoveReceivedAtFrame = 0;
        state.playerMovedTime[0] = 0;
        state.playerMovedTime[1] = 0;
        state.showingKey = false;
        state.playerMovedKey[0] = -1;
        state.playerMovedKey[1] = -1;
        state.keyToPress = game.randomInt(0, 2);
        console.log("SETUP_KEY", state.keyToPress, "frame:", game.runtime.getState().lastReproducedFrame);
        state.resolvingWinner = false;
        womenAttack.hide();
        women.forEach(w => w.show(0));
        women.forEach(w => w.applyFrame(0));
        crosses.forEach(c => c.hide());
        keys.forEach(k => k.hide());
        keys.forEach(k => k.applyFrame(state.keyToPress));
        timeTexts.forEach(t => t.setText(formatTime(0)));
        await game.waitFrames(60);
        state.keyAppearTime = Math.floor(game.runtime.getState().lastReproducedFrame * (1000 / 60));
        state.showingKey = true;
        keys.forEach(k => k.show());
    }
}
const definition = {
    alias: "attack-game",
    split: false,
    fps: 60,
    instructions: "attack-game"
};
const AttackGame = { definition, run };
export { AttackGame };
function formatTime(time) {
    if (!time)
        return "";
    return `${Math.floor(time / 1000).toString().padStart(2, "0")}:${(time % 1000).toString().padStart(3, "0")}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNrLWdhbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9nYW1lcy9hdHRhY2stZ2FtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsd0JBQXdCLEVBQUUsd0JBQXdCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUUzRixNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQztBQUMvQixNQUFNLHNCQUFzQixHQUFHO0lBQzNCLGdCQUFnQixFQUFFLGlCQUFpQjtJQUNuQyxpQkFBaUIsRUFBRSxpQkFBaUI7Q0FDdkMsQ0FBQztBQUNGLE1BQU0scUNBQXFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNyRCxLQUFLLFVBQVUsR0FBRyxDQUFDLEVBQUMsSUFBSSxFQUFLO0lBQ3pCLE1BQU0sS0FBSyxHQUFHO1FBQ1YsYUFBYSxFQUFDLENBQUM7UUFDZixlQUFlLEVBQUMsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1FBQ3JCLGNBQWMsRUFBQyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDcEIsd0JBQXdCLEVBQUMsQ0FBQztRQUMxQixlQUFlLEVBQUMsS0FBSztRQUNyQixVQUFVLEVBQUMsQ0FBQyxDQUFDO1FBQ2IsVUFBVSxFQUFDLEtBQUs7UUFDaEIsS0FBSyxFQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztLQUNkLENBQUM7SUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsWUFBbUIsRUFBRSxZQUFtQixFQUFFLEVBQUU7UUFDMUQsSUFBRyxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQztZQUNuQyxJQUFJLFlBQVksR0FBRyxZQUFZO2dCQUFFLE9BQU8sRUFBQyxXQUFXLEVBQUMsQ0FBQyxFQUFDLENBQUM7WUFDeEQsSUFBSSxZQUFZLEdBQUcsWUFBWTtnQkFBRSxPQUFPLEVBQUMsV0FBVyxFQUFDLENBQUMsRUFBQyxDQUFDO1FBQzVELENBQUM7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QUM3QixDQUFDO0FBRUYsTUFBTSxVQUFVLEdBQUcsRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFDLENBQUM7QUFFckMsT0FBTyxFQUFDLFVBQVUsRUFBQyxDQUFBO0FBRW5CLFNBQVMsVUFBVSxDQUFDLElBQVc7SUFDM0IsSUFBRyxDQUFDLElBQUk7UUFBRSxPQUFPLEVBQUUsQ0FBQztJQUNwQixPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7QUFDM0csQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Y3JlYXRlU2NvcmVUZXh0Q29tcG9uZW50LCB1cGRhdGVTY29yZVRleHRDb21wb25lbnR9IGZyb20gXCIuL3V0aWxzL21pbmktZ2FtZS1zY29yZVwiO1xuXG5jb25zdCBTUFJJVEVfU0hFRVRfU0laRSA9IDEwMjQ7XG5jb25zdCBTUFJJVEVfU0hFRVRfRElNRU5TSU9OID0ge1xuICAgIHNwcml0ZVNoZWV0V2lkdGg6IFNQUklURV9TSEVFVF9TSVpFLFxuICAgIHNwcml0ZVNoZWV0SGVpZ2h0OiBTUFJJVEVfU0hFRVRfU0laRSxcbn07XG5jb25zdCBXQUlUX0ZPUl9PVEhFUl9QTEFZRVJfUkVTUE9OU0VfRlJBTUVTID0gNjAgKiAyO1xuYXN5bmMgZnVuY3Rpb24gcnVuKHtnYW1lfTphbnkpe1xuICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICBrZXlBcHBlYXJUaW1lOjAsXG4gICAgICAgIHBsYXllck1vdmVkVGltZTpbMCwwXSxcbiAgICAgICAgcGxheWVyTW92ZWRLZXk6WzAsMF0sXG4gICAgICAgIGZpcnN0TW92ZVJlY2VpdmVkQXRGcmFtZTowLFxuICAgICAgICByZXNvbHZpbmdXaW5uZXI6ZmFsc2UsXG4gICAgICAgIGtleVRvUHJlc3M6LTEsXG4gICAgICAgIHNob3dpbmdLZXk6ZmFsc2UsXG4gICAgICAgIHNjb3JlOlswLDBdXG4gICAgfTtcblxuICAgIGdhbWUuc2V0V2lubmVyRm4oKHBsYXllcjFTY29yZTpudW1iZXIsIHBsYXllcjJTY29yZTpudW1iZXIpID0+IHtcbiAgICAgICAgaWYoKHBsYXllcjFTY29yZSArIHBsYXllcjJTY29yZSkgPj0gNSl7XG4gICAgICAgICAgICBpZiggcGxheWVyMVNjb3JlID4gcGxheWVyMlNjb3JlKSByZXR1cm4ge3dpbm5lckluZGV4OjB9O1xuICAgICAgICAgICAgaWYoIHBsYXllcjFTY29yZSA8IHBsYXllcjJTY29yZSkgcmV0dXJuIHt3aW5uZXJJbmRleDoxfTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgY3JlYXRlU2NvcmVUZXh0Q29tcG9uZW50KGdhbWUpO1xuXG4gICAgZ2FtZS5zZXRTY3JlZW5TcHJpdGUoe1xuICAgICAgICBzcHJpdGVEZWZpbml0aW9uOntcbiAgICAgICAgICAgIHg6NTc2LFxuICAgICAgICAgICAgeTowLFxuICAgICAgICAgICAgdzoxOTIsXG4gICAgICAgICAgICBoOjEyOCxcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT05cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgV29tYW5TcHJpdGUgPSBnYW1lLnJlZ2lzdGVyU3ByaXRlRW50aXR5KHtcbiAgICAgICAga2xhc3M6XCJXb21hblwiLFxuICAgICAgICBzcHJpdGVEZWZpbml0aW9uOntcbiAgICAgICAgICAgIHg6MCx5OjY0MCwgdzo2MywgaDo2OSwgY29sdW1uczozLGZyYW1lczozLFxuICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTixcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHcxID0gV29tYW5TcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgcGl4ZWxQb3NpdGlvbjpbMTkyLzQqMSAtIE1hdGguZmxvb3IoV29tYW5TcHJpdGUuc3ByaXRlRGVmaW5pdGlvbi53LzIpICsgMTAsIDQ1XSxcbiAgICAgICAgbGF5ZXI6MSxcbiAgICAgICAgbmV0d29yazp0cnVlXG4gICAgfSk7XG4gICAgY29uc3QgdzIgPSBXb21hblNwcml0ZS5jcmVhdGUoe1xuICAgICAgICBwaXhlbFBvc2l0aW9uOlsxOTIvNCozIC0gTWF0aC5mbG9vcihXb21hblNwcml0ZS5zcHJpdGVEZWZpbml0aW9uLncvMikgLSAxMCwgNDVdLFxuICAgICAgICBsYXllcjoxLFxuICAgICAgICBuZXR3b3JrOnRydWVcbiAgICB9KTtcbiAgICBjb25zdCB3b21lbkF0dGFjayA9IGdhbWUucmVnaXN0ZXJTcHJpdGVFbnRpdHkoe1xuICAgICAgICBrbGFzczpcIldvbWFuXCIsXG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDoxOTMsIHk6NjQwLCB3Ojk2LCBoOjY5LFxuICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTixcbiAgICAgICAgfVxuICAgIH0pLmNyZWF0ZSh7XG4gICAgICAgIHBpeGVsUG9zaXRpb246WzE5Mi8yIC0gOTYvMiwgNDVdLFxuICAgICAgICBsYXllcjo1LFxuICAgICAgICBuZXR3b3JrOnRydWVcbiAgICB9KTtcbiAgICB3b21lbkF0dGFjay5oaWRlKCk7XG4gICAgY29uc3QgS2V5U3ByaXRlID0gZ2FtZS5yZWdpc3RlclNwcml0ZUVudGl0eSh7XG4gICAgICAgIGtsYXNzOlwiS2V5XCIsXG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDo5NiwgeTozODgsXG4gICAgICAgICAgICB3OjE4LCBoOjI0LGNvbHVtbnM6MyxmcmFtZXM6MyxcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT04sXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBDcm9zc1Nwcml0ZSA9IGdhbWUucmVnaXN0ZXJTcHJpdGVFbnRpdHkoe1xuICAgICAgICBrbGFzczpcIkNyb3NzXCIsXG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDoxNzYsIHk6NTEyLFxuICAgICAgICAgICAgdzoxNiwgaDoxNixcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT04sXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBjMSA9IENyb3NzU3ByaXRlLmNyZWF0ZSh7XG4gICAgICAgICAgICBwaXhlbFBvc2l0aW9uOlsxOTIvNCoxIC0gTWF0aC5mbG9vcihLZXlTcHJpdGUuc3ByaXRlRGVmaW5pdGlvbi53LzIpICsgMTAsIDI0XSxcbiAgICAgICAgICAgIGxheWVyOjUsXG4gICAgICAgICAgICBuZXR3b3JrOnRydWVcbiAgICB9KTtcbiAgICBjb25zdCBjMiA9IENyb3NzU3ByaXRlLmNyZWF0ZSh7XG4gICAgICAgIHBpeGVsUG9zaXRpb246WzE5Mi80KjMgLSBNYXRoLmZsb29yKEtleVNwcml0ZS5zcHJpdGVEZWZpbml0aW9uLncvMikgLSAxMCwgMjRdLFxuICAgICAgICBsYXllcjo1LFxuICAgICAgICBuZXR3b3JrOnRydWVcbiAgICB9KTtcblxuICAgIGNvbnN0IHQxID0gZ2FtZS5hZGRUZXh0KHtcbiAgICAgICAgdGV4dDpgYCxcbiAgICAgICAgcGl4ZWxQb3NpdGlvbjpbMTkyLzQqMSAtIE1hdGguZmxvb3IoS2V5U3ByaXRlLnNwcml0ZURlZmluaXRpb24udy8yKSArIDEwIC0gMjAsIDExNF0sXG4gICAgICAgIGZvbnRTaXplOjEsXG4gICAgICAgIHRleHRDb2xvcjpbMSwxLDEsMV1cbiAgICB9KTtcbiAgICBjb25zdCB0MiA9IGdhbWUuYWRkVGV4dCh7XG4gICAgICAgIHRleHQ6YGAsXG4gICAgICAgIHBpeGVsUG9zaXRpb246WzE5Mi80KjMgLSBNYXRoLmZsb29yKEtleVNwcml0ZS5zcHJpdGVEZWZpbml0aW9uLncvMikgLSAxMCAtIDIwLCAxMTRdLFxuICAgICAgICBmb250U2l6ZToxLFxuICAgICAgICB0ZXh0Q29sb3I6WzEsMSwxLDFdXG4gICAgfSk7XG5cbiAgICBjb25zdCB0aW1lVGV4dHMgPSBbdDEsIHQyXTtcblxuICAgIGMxLmhpZGUoKTtcbiAgICBjMi5oaWRlKCk7XG5cbiAgICBjb25zdCBrMSA9IEtleVNwcml0ZS5jcmVhdGUoe1xuICAgICAgICBwaXhlbFBvc2l0aW9uOlsxOTIvNCoxIC0gTWF0aC5mbG9vcihLZXlTcHJpdGUuc3ByaXRlRGVmaW5pdGlvbi53LzIpICsgMTAsIDIwXSxcbiAgICAgICAgbGF5ZXI6NCxcbiAgICAgICAgbmV0d29yazp0cnVlXG4gICAgfSk7XG5cbiAgICBjb25zdCBrMiA9IEtleVNwcml0ZS5jcmVhdGUoe1xuICAgICAgICBwaXhlbFBvc2l0aW9uOlsxOTIvNCozIC0gTWF0aC5mbG9vcihLZXlTcHJpdGUuc3ByaXRlRGVmaW5pdGlvbi53LzIpIC0gMTAsIDIwXSxcbiAgICAgICAgbGF5ZXI6NCxcbiAgICAgICAgbmV0d29yazp0cnVlXG4gICAgfSk7XG5cblxuXG5cblxuICAgIGNvbnN0IHdvbWVuID0gW3cxLHcyXTtcbiAgICBjb25zdCBjcm9zc2VzID0gW2MxLCBjMl07XG4gICAgY29uc3Qga2V5cyA9IFtrMSxrMl07XG5cbiAgICB3Mi5zZXRab29tKFstMSwxXSk7XG5cbiAgICBnYW1lLm9uSW5wdXQoYXN5bmMgKHtpbnB1dEFjdGlvbktleSwgaXNQcmVzc2VkLCB0aW1lLCBwbGF5ZXJJbmRleCwgZnJhbWVOdW1iZXJ9OmFueSkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIm9uSW5wdXQgZnJhbWVOdW1iZXJcIixmcmFtZU51bWJlcilcbiAgICAgICAgaWYoIXN0YXRlLnNob3dpbmdLZXkpIHJldHVybjtcbiAgICAgICAgaWYoc3RhdGUucGxheWVyTW92ZWRUaW1lW3BsYXllckluZGV4XSkgcmV0dXJuO1xuXG4gICAgICAgIHN0YXRlLnBsYXllck1vdmVkVGltZVtwbGF5ZXJJbmRleF0gPSB0aW1lO1xuICAgICAgICBzdGF0ZS5wbGF5ZXJNb3ZlZEtleVtwbGF5ZXJJbmRleF0gPSBpbnB1dEFjdGlvbktleTtcbiAgICAgICAgc3RhdGUuZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lID0gc3RhdGUuZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lIHx8IGdhbWUucnVudGltZS5nZXRTdGF0ZSgpLmxhc3RSZXByb2R1Y2VkRnJhbWU7XG5cbiAgICAgICAgaWYoaXNQcmVzc2VkKXtcbiAgICAgICAgICAgIGlmKCBpbnB1dEFjdGlvbktleSAhPT0gc3RhdGUua2V5VG9QcmVzcyl7XG4gICAgICAgICAgICAgICAgY3Jvc3Nlc1twbGF5ZXJJbmRleF0uc2hvdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd29tZW5bcGxheWVySW5kZXhdLmFwcGx5RnJhbWUoMSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGdhbWUub25GcmFtZShjaGVja0F0dGFja01vdmUpO1xuXG4gICAgYXdhaXQgc2V0dXBLZXkoKTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIGNoZWNrQXR0YWNrTW92ZShmcmFtZU51bWJlcjpudW1iZXIpe1xuICAgICAgICBpZighc3RhdGUuc2hvd2luZ0tleSkgcmV0dXJuO1xuICAgICAgICBpZighc3RhdGUuZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lKSByZXR1cm47XG4gICAgICAgIGlmKHN0YXRlLnJlc29sdmluZ1dpbm5lcikgcmV0dXJuO1xuXG4gICAgICAgIGxldCB3aW5uZXJJbmRleCA9IC0xO1xuICAgICAgICBpZihzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWUuZXZlcnkoaT0+aSkpe1xuICAgICAgICAgICAgaWYoc3RhdGUucGxheWVyTW92ZWRLZXkuZXZlcnkoaSA9PiBpID09PSBzdGF0ZS5rZXlUb1ByZXNzKSl7Ly9ib3RoIGFyZSBjb3JyZWN0XG4gICAgICAgICAgICAgICAgd2lubmVySW5kZXggPSBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbMF0gPCBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbMV0gPyAwIDogMTtcbiAgICAgICAgICAgIH1lbHNlIGlmKHN0YXRlLnBsYXllck1vdmVkS2V5LnNvbWUoaSA9PiBpID09PSBzdGF0ZS5rZXlUb1ByZXNzKSl7Ly9cbiAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHN0YXRlLnBsYXllck1vdmVkS2V5LmZpbmRJbmRleChpPT5pPT09c3RhdGUua2V5VG9QcmVzcyk7XG4gICAgICAgICAgICB9ZWxzZSBpZihzdGF0ZS5wbGF5ZXJNb3ZlZEtleS5ldmVyeShpID0+IGkgIT09IHN0YXRlLmtleVRvUHJlc3MpKXtcbiAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHN0YXRlLnBsYXllck1vdmVkVGltZVswXSA+IHN0YXRlLnBsYXllck1vdmVkVGltZVsxXSA/IDAgOiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ZWxzZSBpZihzdGF0ZS5maXJzdE1vdmVSZWNlaXZlZEF0RnJhbWUgJiYgKChmcmFtZU51bWJlciAtIHN0YXRlLmZpcnN0TW92ZVJlY2VpdmVkQXRGcmFtZSkgPiBXQUlUX0ZPUl9PVEhFUl9QTEFZRVJfUkVTUE9OU0VfRlJBTUVTICkpe1xuICAgICAgICAgICAgY29uc3QgcGxheWVyQW5zd2VyZWQgPSBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWUuZmluZEluZGV4KGkgPT4gaSk7XG4gICAgICAgICAgICBpZihwbGF5ZXJBbnN3ZXJlZCA+PSAwKXtcbiAgICAgICAgICAgICAgICBpZihzdGF0ZS5wbGF5ZXJNb3ZlZEtleVtwbGF5ZXJBbnN3ZXJlZF0gPT09IHN0YXRlLmtleVRvUHJlc3Mpe1xuICAgICAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHBsYXllckFuc3dlcmVkO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHBsYXllckFuc3dlcmVkID09PSAwID8gMSA6IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmKHdpbm5lckluZGV4ID49IDApe1xuICAgICAgICAgICAgc3RhdGUucmVzb2x2aW5nV2lubmVyID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2V0UGxheWVyU2NvcmVcIilcbiAgICAgICAgICAgIGdhbWUucGxheWVyc1t3aW5uZXJJbmRleF0uc2V0UGxheWVyU2NvcmUoKytzdGF0ZS5zY29yZVt3aW5uZXJJbmRleF0pO1xuICAgICAgICAgICAgd29tZW4uZm9yRWFjaCh3PT53LmhpZGUoKSk7XG4gICAgICAgICAgICB3b21lbkF0dGFjay5zZXRab29tKFt3aW5uZXJJbmRleD8tMToxLDFdKVxuICAgICAgICAgICAgd29tZW5BdHRhY2suc2hvdygpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0aW1lc1wiLCBzdGF0ZS5rZXlBcHBlYXJUaW1lLCBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbMF0pXG4gICAgICAgICAgICB0aW1lVGV4dHMuZm9yRWFjaCgodCxpbmRleCk9PnN0YXRlLnBsYXllck1vdmVkVGltZVtpbmRleF0gJiYgdC5zZXRUZXh0KGZvcm1hdFRpbWUoICBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbaW5kZXhdLXN0YXRlLmtleUFwcGVhclRpbWUpKSk7XG4gICAgICAgICAgICB1cGRhdGVTY29yZVRleHRDb21wb25lbnQoKTtcbiAgICAgICAgICAgIGF3YWl0IGdhbWUud2FpdEZyYW1lcyg2MCk7XG4gICAgICAgICAgICBzZXR1cEtleSgpO1xuICAgICAgICAgICAgZ2FtZS5jaGVja1dpbm5lcnMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGZ1bmN0aW9uIHNldHVwS2V5KCl7XG4gICAgICAgIHN0YXRlLmZpcnN0TW92ZVJlY2VpdmVkQXRGcmFtZSA9IDA7XG4gICAgICAgIHN0YXRlLnBsYXllck1vdmVkVGltZVswXSA9IDA7XG4gICAgICAgIHN0YXRlLnBsYXllck1vdmVkVGltZVsxXSA9IDA7XG4gICAgICAgIHN0YXRlLnNob3dpbmdLZXkgPSBmYWxzZTtcbiAgICAgICAgc3RhdGUucGxheWVyTW92ZWRLZXlbMF0gPSAtMTtcbiAgICAgICAgc3RhdGUucGxheWVyTW92ZWRLZXlbMV0gPSAtMTtcbiAgICAgICAgc3RhdGUua2V5VG9QcmVzcyA9IGdhbWUucmFuZG9tSW50KDAsMik7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiU0VUVVBfS0VZXCIsIHN0YXRlLmtleVRvUHJlc3MsIFwiZnJhbWU6XCIsZ2FtZS5ydW50aW1lLmdldFN0YXRlKCkubGFzdFJlcHJvZHVjZWRGcmFtZSApXG4gICAgICAgIHN0YXRlLnJlc29sdmluZ1dpbm5lciA9IGZhbHNlO1xuICAgICAgICB3b21lbkF0dGFjay5oaWRlKCk7XG4gICAgICAgIHdvbWVuLmZvckVhY2godz0+dy5zaG93KDApKTtcbiAgICAgICAgd29tZW4uZm9yRWFjaCh3PT53LmFwcGx5RnJhbWUoMCkpO1xuICAgICAgICBjcm9zc2VzLmZvckVhY2goYz0+Yy5oaWRlKCkpO1xuICAgICAgICBrZXlzLmZvckVhY2goaz0+ay5oaWRlKCkpO1xuICAgICAgICBrZXlzLmZvckVhY2goaz0+ay5hcHBseUZyYW1lKHN0YXRlLmtleVRvUHJlc3MpKTtcbiAgICAgICAgdGltZVRleHRzLmZvckVhY2godD0+dC5zZXRUZXh0KGZvcm1hdFRpbWUoMCkpKTtcbiAgICAgICAgYXdhaXQgZ2FtZS53YWl0RnJhbWVzKDYwKTtcbiAgICAgICAgc3RhdGUua2V5QXBwZWFyVGltZSA9IE1hdGguZmxvb3IoZ2FtZS5ydW50aW1lLmdldFN0YXRlKCkubGFzdFJlcHJvZHVjZWRGcmFtZSAqICgxMDAwLzYwKSk7XG4gICAgICAgIHN0YXRlLnNob3dpbmdLZXkgPSB0cnVlO1xuICAgICAgICBrZXlzLmZvckVhY2goaz0+ay5zaG93KCkpO1xuICAgIH1cbn1cblxuY29uc3QgZGVmaW5pdGlvbiA9IHtcbiAgICBhbGlhczpcImF0dGFjay1nYW1lXCIsXG4gICAgc3BsaXQ6ZmFsc2UsXG4gICAgZnBzOjYwLFxuICAgIGluc3RydWN0aW9uczpcImF0dGFjay1nYW1lXCJcbn07XG5cbmNvbnN0IEF0dGFja0dhbWUgPSB7ZGVmaW5pdGlvbiwgcnVufTtcblxuZXhwb3J0IHtBdHRhY2tHYW1lfVxuXG5mdW5jdGlvbiBmb3JtYXRUaW1lKHRpbWU6bnVtYmVyKXtcbiAgICBpZighdGltZSkgcmV0dXJuIFwiXCI7XG4gICAgcmV0dXJuIGAke01hdGguZmxvb3IodGltZS8xMDAwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsXCIwXCIpfTokeyh0aW1lJTEwMDApLnRvU3RyaW5nKCkucGFkU3RhcnQoMyxcIjBcIil9YDtcbn0iXX0=
import { createScoreTextComponent, updateScoreTextComponent } from "./utils/mini-game-score";
const SPRITE_SHEET_SIZE = 1024;
const SPRITE_SHEET_DIMENSION = {
    spriteSheetWidth: SPRITE_SHEET_SIZE,
    spriteSheetHeight: SPRITE_SHEET_SIZE,
};
const CURSOR_POSITION_Y = 104;
export const DifferenceGame = {
    definition: {
        alias: "difference-game",
        split: false,
        fps: 60,
        instructions: "Select the correct answer\n use <color=#ffff00><b>E, F, 1, 2, 3</b></color> keys"
    },
    run: function DifferenceGameRun({ game }) {
        const FRAMES_TO_WAIT_A_SECOND = 60;
        const state = {
            scores: [0, 0],
            playersSelectedState: [false, false]
        };
        game.setWinnerFn((player1Score, player2Score) => {
            if (player1Score === 2 && !player2Score)
                return { winnerIndex: 0 };
            if (player2Score === 2 && !player1Score)
                return { winnerIndex: 0 };
            if (Math.max(player1Score, player2Score) >= 2) {
                if (player1Score > player2Score)
                    return { winnerIndex: 0 };
                if (player1Score < player2Score)
                    return { winnerIndex: 1 };
            }
        });
        createScoreTextComponent(game);
        game.setScreenSprite({
            spriteDefinition: {
                x: 576,
                y: 128,
                w: 192,
                h: 128,
                ...SPRITE_SHEET_DIMENSION
            }
        });
        const spriteDefinition = {
            x: 0,
            y: 768,
            w: 64,
            h: 64,
            ...SPRITE_SHEET_DIMENSION,
            columns: 9, frames: 9
        };
        const CursorSprite = game.registerSpriteEntity({
            klass: "Cursor",
            spriteDefinition: {
                x: 0, y: 486, w: 16, h: 18, columns: 2, frames: 2,
                ...SPRITE_SHEET_DIMENSION,
            }
        });
        const PictureSprite = game.registerSpriteEntity({
            klass: "Picture",
            spriteDefinition
        });
        const CURSOR_PICTURE_DISPLACEMENT = 10;
        const PICTURE_WIDTH = 64;
        const PICTURE_CENTER = 64 / 2;
        const player1PixelPositions = [
            PICTURE_WIDTH,
            PICTURE_WIDTH * 2,
            PICTURE_WIDTH * 3
        ].map(i => i - (PICTURE_CENTER + CURSOR_PICTURE_DISPLACEMENT) - 4);
        const player2PixelPositions = [
            PICTURE_WIDTH,
            PICTURE_WIDTH * 2,
            PICTURE_WIDTH * 3
        ].map(i => i - (PICTURE_CENTER - CURSOR_PICTURE_DISPLACEMENT) - 4);
        const cursor1 = CursorSprite.create({
            pixelPosition: [player1PixelPositions[1], CURSOR_POSITION_Y],
            layer: 3,
            network: true
        });
        const cursor2 = CursorSprite.create({
            pixelPosition: [player2PixelPositions[1], CURSOR_POSITION_Y],
            layer: 3,
            network: true
        });
        cursor2.applyFrame(1);
        const answerSprites = new Array(3).fill(null).map((_, index) => PictureSprite.create({
            pixelPosition: [index * 64, 40],
            layer: 2,
            network: true
        }));
        let solutionPosition = -1;
        game.onInput(async ({ inputActionKey, isPressed, time, playerIndex }) => {
            if (!isPressed)
                return;
            console.log("state.playersSelectedState", state.playersSelectedState);
            if (state.playersSelectedState.some(i => i))
                return;
            console.log("selecting ...");
            const cursorSprite = playerIndex ? cursor2 : cursor1;
            const cursorPositions = playerIndex ? player2PixelPositions : player1PixelPositions;
            const currentCursorPosition = cursorPositions.indexOf(cursorSprite.getPixelPosition()[0]);
            if (inputActionKey === 1 && currentCursorPosition > 0) {
                cursorSprite.setPixelPosition(cursorPositions[currentCursorPosition - 1], CURSOR_POSITION_Y);
            }
            else if (inputActionKey === 2 && currentCursorPosition < 2) {
                console.log("CCC");
                cursorSprite.setPixelPosition(cursorPositions[currentCursorPosition + 1], CURSOR_POSITION_Y);
            }
            else if (inputActionKey === 10 && currentCursorPosition !== 0) {
                cursorSprite.setPixelPosition(cursorPositions[0], CURSOR_POSITION_Y);
            }
            else if (inputActionKey === 11 && currentCursorPosition !== 1) {
                cursorSprite.setPixelPosition(cursorPositions[1], CURSOR_POSITION_Y);
            }
            else if (inputActionKey === 12 && currentCursorPosition !== 2) {
                cursorSprite.setPixelPosition(cursorPositions[2], CURSOR_POSITION_Y);
            }
            else if (inputActionKey === 0) {
                const otherPlayerIndex = playerIndex ? 0 : 1;
                state.playersSelectedState[playerIndex] = true;
                cursorSprite.setPixelPosition(cursorPositions[currentCursorPosition], CURSOR_POSITION_Y - 10);
                const isCorrectAnswer = solutionPosition === currentCursorPosition;
                console.log("isCorrectAnswer", isCorrectAnswer);
                if (isCorrectAnswer) {
                    state.scores[playerIndex]++;
                }
                else {
                    state.scores[otherPlayerIndex]++;
                }
                console.log("state.scores", state.scores);
                game.players[0].setPlayerScore(state.scores[0]);
                game.players[1].setPlayerScore(state.scores[1]);
                await updateScoreTextComponent();
                await game.waitFrames(FRAMES_TO_WAIT_A_SECOND);
                game.checkWinners();
                setupGame();
            }
        });
        function setupGame() {
            state.playersSelectedState[0] = state.playersSelectedState[1] = false;
            const solutionFrame = game.randomInt(0, spriteDefinition.frames - 1);
            const mirrorFrame = game.getRandomFromList([0, 1, 2, 3, 4, 5, 6, 7, 8].filter(i => i != solutionFrame));
            solutionPosition = game.randomInt(0, 2);
            cursor1.setPixelPosition(player1PixelPositions[1], CURSOR_POSITION_Y);
            cursor2.setPixelPosition(player2PixelPositions[1], CURSOR_POSITION_Y);
            answerSprites.forEach((answerSprite, index) => {
                const frameToApply = index === solutionPosition ? solutionFrame : mirrorFrame;
                answerSprite.applyFrame(frameToApply);
            });
        }
        game.onStart(({ seed }) => {
            setupGame();
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlmZmVyZW5jZS1nYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vZ2FtZXMvZGlmZmVyZW5jZS1nYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyx3QkFBd0IsRUFBRSx3QkFBd0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBRTNGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDO0FBQy9CLE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsZ0JBQWdCLEVBQUUsaUJBQWlCO0lBQ25DLGlCQUFpQixFQUFFLGlCQUFpQjtDQUN2QyxDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLENBQUM7QUFFOUIsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHO0lBQzFCLFVBQVUsRUFBQztRQUNQLEtBQUssRUFBQyxpQkFBaUI7UUFDdkIsS0FBSyxFQUFDLEtBQUs7UUFDWCxHQUFHLEVBQUMsRUFBRTtRQUNOLFlBQVksRUFBQyxrRkFBa0Y7S0FDbEc7SUFDRCxHQUFHLEVBQUMsU0FBUyxpQkFBaUIsQ0FBQyxFQUFDLElBQUksRUFBSztRQUNyQyxNQUFNLHVCQUF1QixHQUFHLEVBQUUsQ0FBQztRQUVuQyxNQUFNLEtBQUssR0FBRztZQUNWLE1BQU0sRUFBQyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7WUFDWixvQkFBb0IsRUFBQyxDQUFDLEtBQUssRUFBQyxLQUFLLENBQUM7U0FDckMsQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxZQUFtQixFQUFFLFlBQW1CLEVBQUUsRUFBRTtZQUMxRCxJQUFHLFlBQVksS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUFFLE9BQU8sRUFBQyxXQUFXLEVBQUMsQ0FBQyxFQUFDLENBQUM7WUFDL0QsSUFBRyxZQUFZLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWTtnQkFBRSxPQUFPLEVBQUMsV0FBVyxFQUFDLENBQUMsRUFBQyxDQUFDO1lBRS9ELElBQUcs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LEVBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBLEVBQUUsQ0FBQSxDQUFDLElBQUUsYUFBYSxDQUFDLENBQUUsQ0FBQztZQUM5RixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN4QyxPQUFPLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztZQUN0RSxPQUFPLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztZQUN0RSxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBQyxFQUFFO2dCQUN6QyxNQUFNLFlBQVksR0FBRyxLQUFLLEtBQUcsZ0JBQWdCLENBQUEsQ0FBQyxDQUFBLGFBQWEsQ0FBQSxDQUFDLENBQUEsV0FBVyxDQUFDO2dCQUN4RSxZQUFZLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzFDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFDLElBQUksRUFBSyxFQUFDLEVBQUU7WUFDdkIsU0FBUyxFQUFFLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFHUCxDQUFDO0NBQ0osQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5wdXRBY3Rpb259IGZyb20gXCJAZGNsL3Nkay9lY3NcIjtcbmltcG9ydCB7Y3JlYXRlU2NvcmVUZXh0Q29tcG9uZW50LCB1cGRhdGVTY29yZVRleHRDb21wb25lbnR9IGZyb20gXCIuL3V0aWxzL21pbmktZ2FtZS1zY29yZVwiO1xuXG5jb25zdCBTUFJJVEVfU0hFRVRfU0laRSA9IDEwMjQ7XG5jb25zdCBTUFJJVEVfU0hFRVRfRElNRU5TSU9OID0ge1xuICAgIHNwcml0ZVNoZWV0V2lkdGg6IFNQUklURV9TSEVFVF9TSVpFLFxuICAgIHNwcml0ZVNoZWV0SGVpZ2h0OiBTUFJJVEVfU0hFRVRfU0laRSxcbn07XG5jb25zdCBDVVJTT1JfUE9TSVRJT05fWSA9IDEwNDtcblxuZXhwb3J0IGNvbnN0IERpZmZlcmVuY2VHYW1lID0ge1xuICAgIGRlZmluaXRpb246e1xuICAgICAgICBhbGlhczpcImRpZmZlcmVuY2UtZ2FtZVwiLFxuICAgICAgICBzcGxpdDpmYWxzZSxcbiAgICAgICAgZnBzOjYwLFxuICAgICAgICBpbnN0cnVjdGlvbnM6XCJTZWxlY3QgdGhlIGNvcnJlY3QgYW5zd2VyXFxuIHVzZSA8Y29sb3I9I2ZmZmYwMD48Yj5FLCBGLCAxLCAyLCAzPC9iPjwvY29sb3I+IGtleXNcIlxuICAgIH0sXG4gICAgcnVuOmZ1bmN0aW9uIERpZmZlcmVuY2VHYW1lUnVuKHtnYW1lfTphbnkpe1xuICAgICAgICBjb25zdCBGUkFNRVNfVE9fV0FJVF9BX1NFQ09ORCA9IDYwO1xuXG4gICAgICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICAgICAgc2NvcmVzOlswLDBdLFxuICAgICAgICAgICAgcGxheWVyc1NlbGVjdGVkU3RhdGU6W2ZhbHNlLGZhbHNlXVxuICAgICAgICB9O1xuICAgICAgICBnYW1lLnNldFdpbm5lckZuKChwbGF5ZXIxU2NvcmU6bnVtYmVyLCBwbGF5ZXIyU2NvcmU6bnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBpZihwbGF5ZXIxU2NvcmUgPT09IDIgJiYgIXBsYXllcjJTY29yZSkgcmV0dXJuIHt3aW5uZXJJbmRleDowfTsvLzItMCBtYWtlcyBhIHdpbm5lciwgbm8gbmVlZCB0byBwbGF5IGEgM3JkIHRpbWVcbiAgICAgICAgICAgIGlmKHBsYXllcjJTY29yZSA9PT0gMiAmJiAhcGxheWVyMVNjb3JlKSByZXR1cm4ge3dpbm5lckluZGV4OjB9O1xuXG4gICAgICAgICAgICBpZihNYXRoLm1heChwbGF5ZXIxU2NvcmUscGxheWVyMlNjb3JlKSA+PSAyKXsvL3Nob3VsZCBoYXZlIHBsYXllciBhdCBsZWFzdCAyIGdhbWVzXG4gICAgICAgICAgICAgICAgaWYoIHBsYXllcjFTY29yZSA+IHBsYXllcjJTY29yZSkgcmV0dXJuIHt3aW5uZXJJbmRleDowfTtcbiAgICAgICAgICAgICAgICBpZiggcGxheWVyMVNjb3JlIDwgcGxheWVyMlNjb3JlKSByZXR1cm4ge3dpbm5lckluZGV4OjF9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY3JlYXRlU2NvcmVUZXh0Q29tcG9uZW50KGdhbWUpO1xuICAgICAgICBnYW1lLnNldFNjcmVlblNwcml0ZSh7XG4gICAgICAgICAgICBzcHJpdGVEZWZpbml0aW9uOntcbiAgICAgICAgICAgICAgICB4OjU3NixcbiAgICAgICAgICAgICAgICB5OjEyOCxcbiAgICAgICAgICAgICAgICB3OjE5MixcbiAgICAgICAgICAgICAgICBoOjEyOCxcbiAgICAgICAgICAgICAgICAuLi5TUFJJVEVfU0hFRVRfRElNRU5TSU9OXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBzcHJpdGVEZWZpbml0aW9uID0ge1xuICAgICAgICAgICAgeDowLFxuICAgICAgICAgICAgeTo3NjgsXG4gICAgICAgICAgICB3OjY0LFxuICAgICAgICAgICAgaDo2NCxcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT04sXG4gICAgICAgICAgICBjb2x1bW5zOjksIGZyYW1lczo5XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IEN1cnNvclNwcml0ZSA9IGdhbWUucmVnaXN0ZXJTcHJpdGVFbnRpdHkoe1xuICAgICAgICAgICAga2xhc3M6XCJDdXJzb3JcIixcbiAgICAgICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgICAgIHg6MCx5OjQ4NiwgdzoxNiwgaDoxOCwgY29sdW1uczoyLGZyYW1lczoyLFxuICAgICAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT04sXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBQaWN0dXJlU3ByaXRlID0gZ2FtZS5yZWdpc3RlclNwcml0ZUVudGl0eSh7XG4gICAgICAgICAgICBrbGFzczpcIlBpY3R1cmVcIixcbiAgICAgICAgICAgIHNwcml0ZURlZmluaXRpb25cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IENVUlNPUl9QSUNUVVJFX0RJU1BMQUNFTUVOVCA9IDEwO1xuICAgICAgICBjb25zdCBQSUNUVVJFX1dJRFRIID0gNjQ7XG4gICAgICAgIGNvbnN0IFBJQ1RVUkVfQ0VOVEVSID0gNjQvMjtcbiAgICAgICAgY29uc3QgcGxheWVyMVBpeGVsUG9zaXRpb25zID0gW1xuICAgICAgICAgICAgUElDVFVSRV9XSURUSCxcbiAgICAgICAgICAgIFBJQ1RVUkVfV0lEVEgqMixcbiAgICAgICAgICAgIFBJQ1RVUkVfV0lEVEgqM1xuICAgICAgICBdLm1hcChpPT5pLShQSUNUVVJFX0NFTlRFUiArIENVUlNPUl9QSUNUVVJFX0RJU1BMQUNFTUVOVCktNCk7XG4gICAgICAgIGNvbnN0IHBsYXllcjJQaXhlbFBvc2l0aW9ucyA9IFtcbiAgICAgICAgICAgIFBJQ1RVUkVfV0lEVEgsXG4gICAgICAgICAgICBQSUNUVVJFX1dJRFRIKjIsXG4gICAgICAgICAgICBQSUNUVVJFX1dJRFRIKjNcbiAgICAgICAgXS5tYXAoaT0+aS0oUElDVFVSRV9DRU5URVIgLSBDVVJTT1JfUElDVFVSRV9ESVNQTEFDRU1FTlQpLTQpO1xuXG4gICAgICAgIGNvbnN0IGN1cnNvcjEgPSBDdXJzb3JTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgICAgIHBpeGVsUG9zaXRpb246W3BsYXllcjFQaXhlbFBvc2l0aW9uc1sxXSwgQ1VSU09SX1BPU0lUSU9OX1ldLFxuICAgICAgICAgICAgbGF5ZXI6MyxcbiAgICAgICAgICAgIG5ldHdvcms6dHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBjdXJzb3IyID0gQ3Vyc29yU3ByaXRlLmNyZWF0ZSh7XG4gICAgICAgICAgICBwaXhlbFBvc2l0aW9uOltwbGF5ZXIyUGl4ZWxQb3NpdGlvbnNbMV0sIENVUlNPUl9QT1NJVElPTl9ZXSxcbiAgICAgICAgICAgIGxheWVyOjMsXG4gICAgICAgICAgICBuZXR3b3JrOnRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIGN1cnNvcjIuYXBwbHlGcmFtZSgxKTtcblxuICAgICAgICBjb25zdCBhbnN3ZXJTcHJpdGVzID0gbmV3IEFycmF5KDMpLmZpbGwobnVsbCkubWFwKChfLGluZGV4KSA9PiBQaWN0dXJlU3ByaXRlLmNyZWF0ZSh7XG4gICAgICAgICAgICBwaXhlbFBvc2l0aW9uOltpbmRleCo2NCwgNDBdLFxuICAgICAgICAgICAgbGF5ZXI6MixcbiAgICAgICAgICAgIG5ldHdvcms6dHJ1ZVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgbGV0IHNvbHV0aW9uUG9zaXRpb24gPSAtMTtcblxuICAgICAgICBnYW1lLm9uSW5wdXQoYXN5bmMgKHtpbnB1dEFjdGlvbktleSwgaXNQcmVzc2VkLCB0aW1lLCBwbGF5ZXJJbmRleH06YW55KSA9PiB7XG4gICAgICAgICAgICBpZighaXNQcmVzc2VkKSByZXR1cm47XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInN0YXRlLnBsYXllcnNTZWxlY3RlZFN0YXRlXCIsc3RhdGUucGxheWVyc1NlbGVjdGVkU3RhdGUpXG4gICAgICAgICAgICBpZihzdGF0ZS5wbGF5ZXJzU2VsZWN0ZWRTdGF0ZS5zb21lKGk9PmkpKSByZXR1cm47XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInNlbGVjdGluZyAuLi5cIilcbiAgICAgICAgICAgIGNvbnN0IGN1cnNvclNwcml0ZSA9IHBsYXllckluZGV4ID8gY3Vyc29yMiA6IGN1cnNvcjE7XG4gICAgICAgICAgICBjb25zdCBjdXJzb3JQb3NpdGlvbnMgPSBwbGF5ZXJJbmRleD8gcGxheWVyMlBpeGVsUG9zaXRpb25zOnBsYXllcjFQaXhlbFBvc2l0aW9ucztcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDdXJzb3JQb3NpdGlvbiA9IGN1cnNvclBvc2l0aW9ucy5pbmRleE9mKGN1cnNvclNwcml0ZS5nZXRQaXhlbFBvc2l0aW9uKClbMF0pO1xuICAgICAgICAgICAgaWYoaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX1BSSU1BUlkgJiYgY3VycmVudEN1cnNvclBvc2l0aW9uID4gMCl7XG4gICAgICAgICAgICAgICAgY3Vyc29yU3ByaXRlLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgICAgIGN1cnNvclBvc2l0aW9uc1tjdXJyZW50Q3Vyc29yUG9zaXRpb24tMV0sXG4gICAgICAgICAgICAgICAgICAgIENVUlNPUl9QT1NJVElPTl9ZXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfWVsc2UgaWYoaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX1NFQ09OREFSWSAmJiBjdXJyZW50Q3Vyc29yUG9zaXRpb24gPCAyKXtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNDQ1wiKVxuICAgICAgICAgICAgICAgIGN1cnNvclNwcml0ZS5zZXRQaXhlbFBvc2l0aW9uKFxuICAgICAgICAgICAgICAgICAgICBjdXJzb3JQb3NpdGlvbnNbY3VycmVudEN1cnNvclBvc2l0aW9uKzFdLFxuICAgICAgICAgICAgICAgICAgICBDVVJTT1JfUE9TSVRJT05fWVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH1lbHNlIGlmKGlucHV0QWN0aW9uS2V5ID09PSBJbnB1dEFjdGlvbi5JQV9BQ1RJT05fMyAmJiBjdXJyZW50Q3Vyc29yUG9zaXRpb24gIT09IDApe1xuICAgICAgICAgICAgICAgIGN1cnNvclNwcml0ZS5zZXRQaXhlbFBvc2l0aW9uKFxuICAgICAgICAgICAgICAgICAgICBjdXJzb3JQb3NpdGlvbnNbMF0sXG4gICAgICAgICAgICAgICAgICAgIENVUlNPUl9QT1NJVElPTl9ZXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfWVsc2UgaWYoaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX0FDVElPTl80ICYmIGN1cnJlbnRDdXJzb3JQb3NpdGlvbiAhPT0gMSl7XG4gICAgICAgICAgICAgICAgY3Vyc29yU3ByaXRlLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgICAgIGN1cnNvclBvc2l0aW9uc1sxXSxcbiAgICAgICAgICAgICAgICAgICAgQ1VSU09SX1BPU0lUSU9OX1lcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9ZWxzZSBpZihpbnB1dEFjdGlvbktleSA9PT0gSW5wdXRBY3Rpb24uSUFfQUNUSU9OXzUgJiYgY3VycmVudEN1cnNvclBvc2l0aW9uICE9PSAyKXtcbiAgICAgICAgICAgICAgICBjdXJzb3JTcHJpdGUuc2V0UGl4ZWxQb3NpdGlvbihcbiAgICAgICAgICAgICAgICAgICAgY3Vyc29yUG9zaXRpb25zWzJdLFxuICAgICAgICAgICAgICAgICAgICBDVVJTT1JfUE9TSVRJT05fWVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH1lbHNlIGlmKGlucHV0QWN0aW9uS2V5ID09PSBJbnB1dEFjdGlvbi5JQV9QT0lOVEVSKXtcbiAgICAgICAgICAgICAgICBjb25zdCBvdGhlclBsYXllckluZGV4ID0gcGxheWVySW5kZXg/MDoxO1xuICAgICAgICAgICAgICAgIHN0YXRlLnBsYXllcnNTZWxlY3RlZFN0YXRlW3BsYXllckluZGV4XSA9IHRydWU7XG4gICAgICAgICAgICAgICAgY3Vyc29yU3ByaXRlLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgICAgIGN1cnNvclBvc2l0aW9uc1tjdXJyZW50Q3Vyc29yUG9zaXRpb25dLFxuICAgICAgICAgICAgICAgICAgICBDVVJTT1JfUE9TSVRJT05fWS0xMFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgY29uc3QgaXNDb3JyZWN0QW5zd2VyID0gc29sdXRpb25Qb3NpdGlvbiA9PT0gY3VycmVudEN1cnNvclBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiaXNDb3JyZWN0QW5zd2VyXCIsaXNDb3JyZWN0QW5zd2VyKVxuICAgICAgICAgICAgICAgIGlmKGlzQ29ycmVjdEFuc3dlcil7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnNjb3Jlc1twbGF5ZXJJbmRleF0rK1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5zY29yZXNbb3RoZXJQbGF5ZXJJbmRleF0rK1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInN0YXRlLnNjb3Jlc1wiLHN0YXRlLnNjb3JlcylcbiAgICAgICAgICAgICAgICBnYW1lLnBsYXllcnNbMF0uc2V0UGxheWVyU2NvcmUoc3RhdGUuc2NvcmVzWzBdKTtcbiAgICAgICAgICAgICAgICBnYW1lLnBsYXllcnNbMV0uc2V0UGxheWVyU2NvcmUoc3RhdGUuc2NvcmVzWzFdKTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVNjb3JlVGV4dENvbXBvbmVudCgpO1xuXG4gICAgICAgICAgICAgICAgYXdhaXQgZ2FtZS53YWl0RnJhbWVzKEZSQU1FU19UT19XQUlUX0FfU0VDT05EKTtcbiAgICAgICAgICAgICAgICBnYW1lLmNoZWNrV2lubmVycygpO1xuICAgICAgICAgICAgICAgIHNldHVwR2FtZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBmdW5jdGlvbiBzZXR1cEdhbWUoKXtcbiAgICAgICAgICAgIHN0YXRlLnBsYXllcnNTZWxlY3RlZFN0YXRlWzBdID0gc3RhdGUucGxheWVyc1NlbGVjdGVkU3RhdGVbMV0gPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IHNvbHV0aW9uRnJhbWUgPSBnYW1lLnJhbmRvbUludCgwLCBzcHJpdGVEZWZpbml0aW9uLmZyYW1lcyAtIDEpO1xuICAgICAgICAgICAgY29uc3QgbWlycm9yRnJhbWUgPSBnYW1lLmdldFJhbmRvbUZyb21MaXN0KCBbMCwxLDIsMyw0LDUsNiw3LDhdLmZpbHRlcihpPT5pIT1zb2x1dGlvbkZyYW1lKSApO1xuICAgICAgICAgICAgc29sdXRpb25Qb3NpdGlvbiA9IGdhbWUucmFuZG9tSW50KDAsIDIpO1xuICAgICAgICAgICAgY3Vyc29yMS5zZXRQaXhlbFBvc2l0aW9uKHBsYXllcjFQaXhlbFBvc2l0aW9uc1sxXSwgQ1VSU09SX1BPU0lUSU9OX1kpO1xuICAgICAgICAgICAgY3Vyc29yMi5zZXRQaXhlbFBvc2l0aW9uKHBsYXllcjJQaXhlbFBvc2l0aW9uc1sxXSwgQ1VSU09SX1BPU0lUSU9OX1kpO1xuICAgICAgICAgICAgYW5zd2VyU3ByaXRlcy5mb3JFYWNoKChhbnN3ZXJTcHJpdGUsIGluZGV4KT0+e1xuICAgICAgICAgICAgICAgIGNvbnN0IGZyYW1lVG9BcHBseSA9IGluZGV4PT09c29sdXRpb25Qb3NpdGlvbj9zb2x1dGlvbkZyYW1lOm1pcnJvckZyYW1lO1xuICAgICAgICAgICAgICAgIGFuc3dlclNwcml0ZS5hcHBseUZyYW1lKGZyYW1lVG9BcHBseSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGdhbWUub25TdGFydCgoe3NlZWR9OmFueSk9PntcbiAgICAgICAgICAgIHNldHVwR2FtZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvL1RPRE8gc2VsZWN0IDIgc3ByaXRlcyBmcm9tIHRoZSBsaXN0XG4gICAgfVxufSJdfQ==
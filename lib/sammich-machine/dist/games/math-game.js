import { SPRITE_SHEET_DIMENSION } from "../lib/sprite-constants";
import { createScoreTextComponent, updateScoreTextComponent } from "./utils/mini-game-score";
const WAIT_FOR_OTHER_PLAYER_RESPONSE_FRAMES = 60 * 2;
const TEXT_DEFAULTS = { fontSize: 1, textColor: [1, 1, 1, 1], textAlign: 4 };
const TIME_TEXT_DEFAULTS = {
    text: `00:000`,
    fontSize: 0.6,
    textAlign: 4,
    textColor: [0, 0, 0, 1]
};
async function run({ game }) {
    const state = {
        num1: 0,
        num2: 0,
        solution: 0,
        solutionIndex: 0,
        playerCursorIndex: [0, 0],
        playerMovedTime: [0, 0],
        answerValues: [],
        showingQuestion: false,
        resolvingWinner: false,
        firstMoveReceivedAtFrame: 0,
        appearTime: 0,
        score: [0, 0]
    };
    game.setScreenSprite({
        spriteDefinition: {
            x: 384,
            y: 0,
            w: 192,
            h: 128,
            ...SPRITE_SHEET_DIMENSION
        }
    });
    game.setWinnerFn((player1Score, player2Score) => {
        if ((player1Score + player2Score) >= 5) {
            if (player1Score > player2Score)
                return { winnerIndex: 0 };
            if (player1Score < player2Score)
                return { winnerIndex: 1 };
        }
    });
    createScoreTextComponent(game, { pixelPosition: [192 / 2, 2], fontSize: 0.6, textColor: [0, 0, 0, 1] });
    const TeacherSprite = game.registerSpriteEntity({
        klass: "Teacher",
        spriteDefinition: {
            x: 0, y: 573, w: 64, h: 64, columns: 4, frames: 4,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const teachers = [
        TeacherSprite.create({
            pixelPosition: [0, 50],
            layer: 1
        }),
        TeacherSprite.create({
            pixelPosition: [192 - 64, 50],
            layer: 1,
            zoom: [-1, 1]
        }),
    ];
    const timeTexts = [game.addText({
            ...TIME_TEXT_DEFAULTS,
            pixelPosition: [30, 54],
        }), game.addText({
            ...TIME_TEXT_DEFAULTS,
            pixelPosition: [192 - 30, 54],
        })];
    const CursorSprite = game.registerSpriteEntity({
        klass: "Cursor",
        spriteDefinition: {
            x: 0, y: 486, w: 16, h: 18, columns: 2, frames: 2,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const CURSOR_POSITIONS = [
        new Array(6).fill(null).map((_, answerIndex) => [
            192 / 2 + (answerIndex % 3) * 30 - 43,
            55 + Math.floor(answerIndex / 3) * 24
        ]),
        new Array(6).fill(null).map((_, answerIndex) => [
            192 / 2 + (answerIndex % 3) * 30 - 27,
            55 + Math.floor(answerIndex / 3) * 24
        ])
    ];
    const cursors = [
        CursorSprite.create({ pixelPosition: [...CURSOR_POSITIONS[0][state.playerCursorIndex[0]]], layer: 3, network: true }),
        CursorSprite.create({ pixelPosition: [...CURSOR_POSITIONS[1][state.playerCursorIndex[1]]], layer: 3, network: true, frame: 1 })
    ];
    const answerTexts = new Array(6).fill(null).map((_, answerIndex) => game.addText({ ...TEXT_DEFAULTS,
        pixelPosition: [
            192 / 2 + (answerIndex % 3) * 30 - 30,
            55 + Math.floor(answerIndex / 3) * 24
        ],
        fontSize: 0.8,
        text: "XX" }));
    const questionText = game.addText({ ...TEXT_DEFAULTS,
        pixelPosition: [192 / 2, 32],
        text: `${state.num1} + ${state.num2}`
    });
    game.onInput(async ({ inputActionKey, isPressed, time, playerIndex, frameNumber }) => {
        console.log("onInput frameNumber", frameNumber);
        if (!state.showingQuestion)
            return;
        if (state.playerMovedTime[playerIndex])
            return;
        if (!isPressed)
            return;
        if (inputActionKey === 0) {
            state.playerMovedTime[playerIndex] = time;
            state.firstMoveReceivedAtFrame = state.firstMoveReceivedAtFrame || game.runtime.getState().lastReproducedFrame;
            const currentPosition = CURSOR_POSITIONS[playerIndex][state.playerCursorIndex[playerIndex]];
            cursors[playerIndex].setPixelPosition(currentPosition[0], currentPosition[1] - 4);
        }
        else if (inputActionKey === 1 || inputActionKey === 2) {
            console.log("player index", state.playerCursorIndex[playerIndex]);
            if (inputActionKey === 2 && state.playerCursorIndex[playerIndex] === 5) {
                state.playerCursorIndex[playerIndex] = 0;
            }
            else if (inputActionKey === 1 && state.playerCursorIndex[playerIndex] === 0) {
                state.playerCursorIndex[playerIndex] = 5;
            }
            else {
                state.playerCursorIndex[playerIndex] =
                    inputActionKey === 1
                        ? Math.min(state.playerCursorIndex[playerIndex] - 1, 5)
                        : inputActionKey === 2
                            ? Math.max(state.playerCursorIndex[playerIndex] + 1, 0)
                            : state.playerCursorIndex[playerIndex];
            }
            cursors[playerIndex].setPixelPosition(...CURSOR_POSITIONS[playerIndex][state.playerCursorIndex[playerIndex]]);
        }
    });
    game.onFrame(checkSelection);
    generateQuestion();
    async function checkSelection(frameNumber) {
        if (!state.showingQuestion)
            return;
        if (!state.firstMoveReceivedAtFrame)
            return;
        if (state.resolvingWinner)
            return;
        let winnerIndex = -1;
        console.log("winnerIndex1", winnerIndex);
        if (state.playerMovedTime.every((i) => i)) {
            if (state.playerCursorIndex.every((i) => i === state.solutionIndex)) {
                winnerIndex = state.playerMovedTime[0] < state.playerMovedTime[1] ? 0 : 1;
            }
            else if (state.playerCursorIndex.some((i) => i === state.solutionIndex)) {
                winnerIndex = state.playerCursorIndex.findIndex((i) => i === state.solutionIndex);
            }
            else if (state.playerCursorIndex.every((i) => i !== state.solutionIndex)) {
                winnerIndex = state.playerMovedTime[0] > state.playerMovedTime[1] ? 0 : 1;
            }
        }
        else if (state.firstMoveReceivedAtFrame && ((frameNumber - state.firstMoveReceivedAtFrame) > WAIT_FOR_OTHER_PLAYER_RESPONSE_FRAMES)) {
            const playerAnswered = state.playerMovedTime.findIndex((i) => i);
            console.log("playerAnswered", playerAnswered);
            if (playerAnswered >= 0) {
                if (state.playerCursorIndex[playerAnswered] === state.solutionIndex) {
                    winnerIndex = playerAnswered;
                }
                else {
                    winnerIndex = playerAnswered === 0 ? 1 : 0;
                }
            }
        }
        console.log("winnerIndex2", winnerIndex);
        if (winnerIndex >= 0) {
            timeTexts.forEach((t, index) => state.playerMovedTime[index] && t.setText(formatTime(state.playerMovedTime[index] - state.appearTime)));
            state.resolvingWinner = true;
            game.players[winnerIndex].setPlayerScore(++state.score[winnerIndex]);
            teachers[winnerIndex].applyFrame(2);
            teachers[winnerIndex ? 0 : 1].applyFrame(1);
            await game.waitFrames(20);
            teachers[winnerIndex].applyFrame(3);
            updateScoreTextComponent();
            await game.waitFrames(60);
            generateQuestion();
            game.checkWinners();
            cursors.forEach((_, playerIndex) => {
                cursors[playerIndex].setPixelPosition(...CURSOR_POSITIONS[playerIndex][state.playerCursorIndex[playerIndex]]);
            });
        }
    }
    function generateQuestion() {
        console.log("generateQuestion");
        timeTexts.forEach((t, index) => t.setText(formatTime(0)));
        state.firstMoveReceivedAtFrame = 0;
        state.showingQuestion = false;
        state.appearTime = Math.floor(game.runtime.getState().lastReproducedFrame * (1000 / 60));
        state.playerMovedTime[0] = state.playerMovedTime[1] = 0;
        state.num1 = game.randomInt(0, 50);
        state.num2 = game.randomInt(0, 50);
        state.solution = state.num1 + state.num2;
        state.solutionIndex = game.randomInt(0, 5);
        state.resolvingWinner = false;
        const solutionMinus = state.solution - 1;
        const solutionMinusIndex = randomIntExcept(0, 5, [state.solutionIndex]);
        const solutionMinus10 = state.solution - 10;
        const solutionMinus10Index = randomIntExcept(0, 5, [state.solutionIndex, solutionMinusIndex]);
        const solutionPlus10 = state.solution + 10;
        const solutionPlus10Index = randomIntExcept(0, 5, [state.solutionIndex, solutionMinusIndex, solutionMinus10Index]);
        state.showingQuestion = true;
        questionText.setText(`${state.num1} + ${state.num2}`);
        answerTexts.forEach((answerText, index) => {
            if (index === state.solutionIndex) {
                answerText.setText(state.answerValues[index] = state.solution);
            }
            else if (index === solutionMinusIndex) {
                answerText.setText(state.answerValues[index] = Math.max(1, solutionMinus));
            }
            else if (index === solutionMinus10Index) {
                answerText.setText(state.answerValues[index] = Math.max(1, solutionMinus10));
            }
            else if (index === solutionPlus10Index) {
                answerText.setText(state.answerValues[index] = Math.max(1, solutionPlus10));
            }
            else {
                answerText.setText(state.answerValues[index] = randomIntExcept(0, 100, state.answerValues));
            }
        });
        teachers.forEach(t => t.applyFrame(0));
    }
    function randomIntExcept(min, max, exceptions) {
        let result = game.randomInt(min, max);
        while (exceptions.indexOf(result) >= 0) {
            result = game.randomInt(min, max);
        }
        return result;
    }
}
const definition = {
    alias: "math-game",
    split: false,
    fps: 60,
    instructions: "Select correct answer"
};
const MathGame = { definition, run };
export { MathGame };
function formatTime(time) {
    if (!time)
        return "";
    return `${Math.floor(time / 1000).toString().padStart(2, "0")}:${(time % 1000).toString().padStart(3, "0")}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aC1nYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vZ2FtZXMvbWF0aC1nYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBSS9ELE9BQU8sRUFBQyx3QkFBd0IsRUFBRSx3QkFBd0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBRzNGLE1BQU0scUNBQXFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNyRCxNQUFNLGFBQWEsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUcsU0FBUyxHQUFpQyxFQUFHLENBQUM7QUFDN0csTUFBTSxrQkFBa0IsR0FBRztJQUN2QixJQUFJLEVBQUMsUUFBUTtJQUNiLFFBQVEsRUFBQyxHQUFHO0lBQ1osU0FBUyxHQUFnQztJQUN6QyxTQUFTLEVBQUMsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7Q0FDdEIsQ0FBQTtBQUNELEtBQUssVUFBVSxHQUFHLENBQUMsRUFBQyxJQUFJLEVBQUs7SUFFekIsTUFBTSxLQUFLLEdBQU87UUFDZCxJQUFJLEVBQUMsQ0FBQztRQUNOLElBQUksRUFBQyxDQUFDO1FBQ04sUUFBUSxFQUFDLENBQUM7UUFDVixhQUFhLEVBQUMsQ0FBQztRQUNmLGlCQUFpQixFQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztRQUN2QixlQUFlLEVBQUMsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1FBQ3JCLFlBQVksRUFBQyxFQUFFO1FBQ2YsZUFBZSxFQUFDLEtBQUs7UUFDckIsZUFBZSxFQUFDLEtBQUs7UUFDckIsd0JBQXdCLEVBQUMsQ0FBQztRQUMxQixVQUFVLEVBQUMsQ0FBQztRQUNaLEtBQUssRUFBQyxDQUFDLENBQUMsRUFB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Q0FBQztBQUVELE1BQU0sVUFBVSxHQUFHO0lBQ2YsS0FBSyxFQUFDLFdBQVc7SUFDakIsS0FBSyxFQUFDLEtBQUs7SUFDWCxHQUFHLEVBQUMsRUFBRTtJQUNOLFlBQVksRUFBQyx1QkFBdUI7Q0FDdkMsQ0FBQztBQUVGLE1BQU0sUUFBUSxHQUFHLEVBQUMsVUFBVSxFQUFFLEdBQUcsRUFBQyxDQUFDO0FBR25DLE9BQU8sRUFBQyxRQUFRLEVBQUMsQ0FBQTtBQUVqQixTQUFTLFVBQVUsQ0FBQyxJQUFXO0lBQzNCLElBQUcsQ0FBQyxJQUFJO1FBQUUsT0FBTyxFQUFFLENBQUM7SUFDcEIsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0FBQzNHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1NQUklURV9TSEVFVF9ESU1FTlNJT059IGZyb20gXCIuLi9saWIvc3ByaXRlLWNvbnN0YW50c1wiO1xuaW1wb3J0IHtJbnB1dEFjdGlvbiwgVGV4dEFsaWduTW9kZX0gZnJvbSBcIkBkY2wvc2RrL2Vjc1wiO1xuaW1wb3J0IHtDb2xvcjR9IGZyb20gXCJAZGNsL3Nkay9tYXRoXCI7XG5pbXBvcnQge3dhaXRGb3J9IGZyb20gXCIuLi9saWIvbGliLXV0aWxcIjtcbmltcG9ydCB7Y3JlYXRlU2NvcmVUZXh0Q29tcG9uZW50LCB1cGRhdGVTY29yZVRleHRDb21wb25lbnR9IGZyb20gXCIuL3V0aWxzL21pbmktZ2FtZS1zY29yZVwiO1xuXG4vL1RPRE8gQkVTVCBPRiAzXG5jb25zdCBXQUlUX0ZPUl9PVEhFUl9QTEFZRVJfUkVTUE9OU0VfRlJBTUVTID0gNjAgKiAyO1xuY29uc3QgVEVYVF9ERUZBVUxUUyA9IHsgZm9udFNpemU6IDEsIHRleHRDb2xvcjogWzEsIDEsIDEsIDFdLCAgdGV4dEFsaWduOiBUZXh0QWxpZ25Nb2RlLlRBTV9NSURETEVfQ0VOVEVSICB9O1xuY29uc3QgVElNRV9URVhUX0RFRkFVTFRTID0ge1xuICAgIHRleHQ6YDAwOjAwMGAsXG4gICAgZm9udFNpemU6MC42LFxuICAgIHRleHRBbGlnbjpUZXh0QWxpZ25Nb2RlLlRBTV9NSURETEVfQ0VOVEVSLFxuICAgIHRleHRDb2xvcjpbMCwwLDAsMV1cbn1cbmFzeW5jIGZ1bmN0aW9uIHJ1bih7Z2FtZX06YW55KXtcblxuICAgIGNvbnN0IHN0YXRlOmFueSA9IHtcbiAgICAgICAgbnVtMTowLFxuICAgICAgICBudW0yOjAsXG4gICAgICAgIHNvbHV0aW9uOjAsXG4gICAgICAgIHNvbHV0aW9uSW5kZXg6MCxcbiAgICAgICAgcGxheWVyQ3Vyc29ySW5kZXg6WzAsMF0sXG4gICAgICAgIHBsYXllck1vdmVkVGltZTpbMCwwXSxcbiAgICAgICAgYW5zd2VyVmFsdWVzOltdLFxuICAgICAgICBzaG93aW5nUXVlc3Rpb246ZmFsc2UsXG4gICAgICAgIHJlc29sdmluZ1dpbm5lcjpmYWxzZSxcbiAgICAgICAgZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lOjAsXG4gICAgICAgIGFwcGVhclRpbWU6MCxcbiAgICAgICAgc2NvcmU6WzAsMF1cbiAgICB9O1xuICAgIGdhbWUuc2V0U2NyZWVuU3ByaXRlKHtcbiAgICAgICAgc3ByaXRlRGVmaW5pdGlvbjp7XG4gICAgICAgICAgICB4OjM4NCxcbiAgICAgICAgICAgIHk6MCxcbiAgICAgICAgICAgIHc6MTkyLFxuICAgICAgICAgICAgaDoxMjgsXG4gICAgICAgICAgICAuLi5TUFJJVEVfU0hFRVRfRElNRU5TSU9OXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBnYW1lLnNldFdpbm5lckZuKChwbGF5ZXIxU2NvcmU6bnVtYmVyLCBwbGF5ZXIyU2NvcmU6bnVtYmVyKSA9PiB7XG4gICAgICAgIGlmKChwbGF5ZXIxU2NvcmUgKyBwbGF5ZXIyU2NvcmUpID49IDUpe1xuICAgICAgICAgICAgaWYoIHBsYXllcjFTY29yZSA+IHBsYXllcjJTY29yZSkgcmV0dXJuIHt3aW5uZXJJbmRleDowfTtcbiAgICAgICAgICAgIGlmKCBwbGF5ZXIxU2NvcmUgPCBwbGF5ZXIyU2NvcmUpIHJldHVybiB7d2lubmVySW5kZXg6MX07XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBjcmVhdGVTY29yZVRleHRDb21wb25lbnQoZ2FtZSwge3BpeGVsUG9zaXRpb246WzE5Mi8yLCAyXSwgZm9udFNpemU6MC42LCB0ZXh0Q29sb3I6WzAsMCwwLDFdfSk7XG5cbiAgICBjb25zdCBUZWFjaGVyU3ByaXRlID0gZ2FtZS5yZWdpc3RlclNwcml0ZUVudGl0eSh7XG4gICAgICAgIGtsYXNzOlwiVGVhY2hlclwiLFxuICAgICAgICBzcHJpdGVEZWZpbml0aW9uOntcbiAgICAgICAgICAgIHg6MCx5OjU3Mywgdzo2NCwgaDo2NCwgY29sdW1uczo0LGZyYW1lczo0LFxuICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTixcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdGVhY2hlcnMgPSBbXG4gICAgICAgIFRlYWNoZXJTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgICAgIHBpeGVsUG9zaXRpb246WzAsIDUwXSxcbiAgICAgICAgICAgIGxheWVyOjFcbiAgICAgICAgfSksXG4gICAgICAgIFRlYWNoZXJTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgICAgIHBpeGVsUG9zaXRpb246WzE5Mi02NCwgNTBdLFxuICAgICAgICAgICAgbGF5ZXI6MSxcbiAgICAgICAgICAgIHpvb206Wy0xLDFdXG4gICAgICAgIH0pLFxuICAgIF07XG5cbiAgICBjb25zdCB0aW1lVGV4dHMgPSBbZ2FtZS5hZGRUZXh0KHtcbiAgICAgICAgLi4uVElNRV9URVhUX0RFRkFVTFRTLFxuICAgICAgICBwaXhlbFBvc2l0aW9uOlszMCwgNTRdLFxuXG4gICAgfSksIGdhbWUuYWRkVGV4dCh7XG4gICAgICAgIC4uLlRJTUVfVEVYVF9ERUZBVUxUUyxcbiAgICAgICAgcGl4ZWxQb3NpdGlvbjpbMTkyLTMwLCA1NF0sXG4gICAgfSldO1xuXG4gICAgY29uc3QgQ3Vyc29yU3ByaXRlID0gZ2FtZS5yZWdpc3RlclNwcml0ZUVudGl0eSh7XG4gICAgICAgIGtsYXNzOlwiQ3Vyc29yXCIsXG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDowLHk6NDg2LCB3OjE2LCBoOjE4LCBjb2x1bW5zOjIsZnJhbWVzOjIsXG4gICAgICAgICAgICAuLi5TUFJJVEVfU0hFRVRfRElNRU5TSU9OLFxuICAgICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgQ1VSU09SX1BPU0lUSU9OUyA9IFtcbiAgICAgICAgbmV3IEFycmF5KDYpLmZpbGwobnVsbCkubWFwKChfLGFuc3dlckluZGV4KT0+W1xuICAgICAgICAgICAgMTkyLzIgKyAoYW5zd2VySW5kZXglMykqMzAgLSA0MyxcbiAgICAgICAgICAgIDU1ICsgTWF0aC5mbG9vcihhbnN3ZXJJbmRleC8zKSoyNFxuICAgICAgICBdKSwvL3BsYXllcjFcbiAgICAgICAgbmV3IEFycmF5KDYpLmZpbGwobnVsbCkubWFwKChfLGFuc3dlckluZGV4KT0+W1xuICAgICAgICAgICAgMTkyLzIgKyAoYW5zd2VySW5kZXglMykqMzAgLSAyNyxcbiAgICAgICAgICAgIDU1ICsgTWF0aC5mbG9vcihhbnN3ZXJJbmRleC8zKSoyNFxuICAgICAgICBdKS8vcGxheWVyMlxuICAgIF07XG4gICAgY29uc3QgY3Vyc29ycyA9IFtcbiAgICAgICAgQ3Vyc29yU3ByaXRlLmNyZWF0ZSh7cGl4ZWxQb3NpdGlvbjpbLi4uQ1VSU09SX1BPU0lUSU9OU1swXVtzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleFswXV1dLGxheWVyOjMsIG5ldHdvcms6dHJ1ZX0pLFxuICAgICAgICBDdXJzb3JTcHJpdGUuY3JlYXRlKHtwaXhlbFBvc2l0aW9uOlsuLi5DVVJTT1JfUE9TSVRJT05TWzFdW3N0YXRlLnBsYXllckN1cnNvckluZGV4WzFdXV0sbGF5ZXI6MywgbmV0d29yazp0cnVlLCBmcmFtZToxfSlcbiAgICBdXG5cbiAgICBjb25zdCBhbnN3ZXJUZXh0cyA9IG5ldyBBcnJheSg2KS5maWxsKG51bGwpLm1hcCgoXyxhbnN3ZXJJbmRleCk9PlxuICAgICAgICBnYW1lLmFkZFRleHQoeyAuLi5URVhUX0RFRkFVTFRTLFxuICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbjpbXG4gICAgICAgICAgICAgICAgMTkyLzIgKyAoYW5zd2VySW5kZXglMykqMzAgLSAzMCxcbiAgICAgICAgICAgICAgICA1NSArIE1hdGguZmxvb3IoYW5zd2VySW5kZXgvMykqMjRcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBmb250U2l6ZTowLjgsXG4gICAgICAgICAgICB0ZXh0OiBcIlhYXCJ9KVxuICAgICk7XG4gICAgY29uc3QgcXVlc3Rpb25UZXh0ID0gZ2FtZS5hZGRUZXh0KHsgLi4uVEVYVF9ERUZBVUxUUyxcbiAgICAgICAgcGl4ZWxQb3NpdGlvbjogWzE5MiAvIDIsIDMyXSxcbiAgICAgICAgdGV4dDogYCR7c3RhdGUubnVtMX0gKyAke3N0YXRlLm51bTJ9YFxuICAgIH0pO1xuXG4gICAgZ2FtZS5vbklucHV0KGFzeW5jICh7aW5wdXRBY3Rpb25LZXksIGlzUHJlc3NlZCwgdGltZSwgcGxheWVySW5kZXgsIGZyYW1lTnVtYmVyfTphbnkpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJvbklucHV0IGZyYW1lTnVtYmVyXCIsZnJhbWVOdW1iZXIpXG4gICAgICAgIGlmKCFzdGF0ZS5zaG93aW5nUXVlc3Rpb24pIHJldHVybjtcbiAgICAgICAgaWYoc3RhdGUucGxheWVyTW92ZWRUaW1lW3BsYXllckluZGV4XSkgcmV0dXJuO1xuICAgICAgICBpZighaXNQcmVzc2VkKSByZXR1cm47XG5cbiAgICAgICAgaWYoaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX1BPSU5URVIpe1xuICAgICAgICAgICAgc3RhdGUucGxheWVyTW92ZWRUaW1lW3BsYXllckluZGV4XSA9IHRpbWU7XG4gICAgICAgICAgICBzdGF0ZS5maXJzdE1vdmVSZWNlaXZlZEF0RnJhbWUgPSBzdGF0ZS5maXJzdE1vdmVSZWNlaXZlZEF0RnJhbWUgfHwgZ2FtZS5ydW50aW1lLmdldFN0YXRlKCkubGFzdFJlcHJvZHVjZWRGcmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQb3NpdGlvbiA9IENVUlNPUl9QT1NJVElPTlNbcGxheWVySW5kZXhdW3N0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XV1cbiAgICAgICAgICAgIGN1cnNvcnNbcGxheWVySW5kZXhdLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgY3VycmVudFBvc2l0aW9uWzBdLCBjdXJyZW50UG9zaXRpb25bMV0tNFxuICAgICAgICAgICAgKVxuICAgICAgICB9ZWxzZSBpZihpbnB1dEFjdGlvbktleSA9PT0gSW5wdXRBY3Rpb24uSUFfUFJJTUFSWSB8fCBpbnB1dEFjdGlvbktleSA9PT0gSW5wdXRBY3Rpb24uSUFfU0VDT05EQVJZKXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyIGluZGV4XCIsIHN0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XSk7XG4gICAgICAgICAgICBpZihpbnB1dEFjdGlvbktleSA9PT0gSW5wdXRBY3Rpb24uSUFfU0VDT05EQVJZICYmIHN0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XSA9PT0gNSApe1xuICAgICAgICAgICAgICAgIHN0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XSA9IDA7XG4gICAgICAgICAgICB9ZWxzZSBpZihpbnB1dEFjdGlvbktleSA9PT0gSW5wdXRBY3Rpb24uSUFfUFJJTUFSWSAmJiBzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleFtwbGF5ZXJJbmRleF0gPT09IDAgKXtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleFtwbGF5ZXJJbmRleF0gPSA1O1xuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgc3RhdGUucGxheWVyQ3Vyc29ySW5kZXhbcGxheWVySW5kZXhdID1cbiAgICAgICAgICAgICAgICAgICAgaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX1BSSU1BUllcbiAgICAgICAgICAgICAgICAgICAgICAgID8gTWF0aC5taW4oc3RhdGUucGxheWVyQ3Vyc29ySW5kZXhbcGxheWVySW5kZXhdLTEsNSlcbiAgICAgICAgICAgICAgICAgICAgICAgIDogaW5wdXRBY3Rpb25LZXkgPT09IElucHV0QWN0aW9uLklBX1NFQ09OREFSWVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gTWF0aC5tYXgoc3RhdGUucGxheWVyQ3Vyc29ySW5kZXhbcGxheWVySW5kZXhdKzEsMClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHN0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3Vyc29yc1twbGF5ZXJJbmRleF0uc2V0UGl4ZWxQb3NpdGlvbiguLi5DVVJTT1JfUE9TSVRJT05TW3BsYXllckluZGV4XVtzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleFtwbGF5ZXJJbmRleF1dKVxuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBnYW1lLm9uRnJhbWUoY2hlY2tTZWxlY3Rpb24pO1xuICAgIGdlbmVyYXRlUXVlc3Rpb24oKTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIGNoZWNrU2VsZWN0aW9uKGZyYW1lTnVtYmVyOm51bWJlcil7XG4gICAgICAgIGlmKCFzdGF0ZS5zaG93aW5nUXVlc3Rpb24pIHJldHVybjtcbiAgICAgICAgaWYoIXN0YXRlLmZpcnN0TW92ZVJlY2VpdmVkQXRGcmFtZSkgcmV0dXJuO1xuICAgICAgICBpZihzdGF0ZS5yZXNvbHZpbmdXaW5uZXIpIHJldHVybjtcblxuICAgICAgICBsZXQgd2lubmVySW5kZXggPSAtMTtcbiAgICAgICAgY29uc29sZS5sb2coXCJ3aW5uZXJJbmRleDFcIix3aW5uZXJJbmRleClcbiAgICAgICAgaWYoc3RhdGUucGxheWVyTW92ZWRUaW1lLmV2ZXJ5KChpOm51bWJlcik9PmkpKXtcbiAgICAgICAgICAgIGlmKHN0YXRlLnBsYXllckN1cnNvckluZGV4LmV2ZXJ5KChpOm51bWJlcikgPT4gaSA9PT0gc3RhdGUuc29sdXRpb25JbmRleCkpey8vYm90aCBhcmUgY29ycmVjdFxuICAgICAgICAgICAgICAgIHdpbm5lckluZGV4ID0gc3RhdGUucGxheWVyTW92ZWRUaW1lWzBdIDwgc3RhdGUucGxheWVyTW92ZWRUaW1lWzFdID8gMCA6IDE7XG4gICAgICAgICAgICB9ZWxzZSBpZihzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleC5zb21lKChpOm51bWJlcikgPT4gaSA9PT0gc3RhdGUuc29sdXRpb25JbmRleCkpey8vXG4gICAgICAgICAgICAgICAgd2lubmVySW5kZXggPSBzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleC5maW5kSW5kZXgoKGk6bnVtYmVyKT0+aT09PXN0YXRlLnNvbHV0aW9uSW5kZXgpO1xuICAgICAgICAgICAgfWVsc2UgaWYoc3RhdGUucGxheWVyQ3Vyc29ySW5kZXguZXZlcnkoKGk6bnVtYmVyKSA9PiBpICE9PSBzdGF0ZS5zb2x1dGlvbkluZGV4KSl7XG4gICAgICAgICAgICAgICAgd2lubmVySW5kZXggPSBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbMF0gPiBzdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbMV0gPyAwIDogMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2UgaWYoc3RhdGUuZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lICYmICgoZnJhbWVOdW1iZXIgLSBzdGF0ZS5maXJzdE1vdmVSZWNlaXZlZEF0RnJhbWUpID4gV0FJVF9GT1JfT1RIRVJfUExBWUVSX1JFU1BPTlNFX0ZSQU1FUyApKXtcbiAgICAgICAgICAgIGNvbnN0IHBsYXllckFuc3dlcmVkID0gc3RhdGUucGxheWVyTW92ZWRUaW1lLmZpbmRJbmRleCgoaTpudW1iZXIpID0+IGkpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwbGF5ZXJBbnN3ZXJlZFwiLCBwbGF5ZXJBbnN3ZXJlZCk7XG4gICAgICAgICAgICBpZihwbGF5ZXJBbnN3ZXJlZCA+PSAwKXtcbiAgICAgICAgICAgICAgICBpZihzdGF0ZS5wbGF5ZXJDdXJzb3JJbmRleFtwbGF5ZXJBbnN3ZXJlZF0gPT09IHN0YXRlLnNvbHV0aW9uSW5kZXgpe1xuICAgICAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHBsYXllckFuc3dlcmVkO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICB3aW5uZXJJbmRleCA9IHBsYXllckFuc3dlcmVkID09PSAwID8gMSA6IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwid2lubmVySW5kZXgyXCIsd2lubmVySW5kZXgpXG4gICAgICAgIGlmKHdpbm5lckluZGV4ID49IDApe1xuICAgICAgICAgICAgdGltZVRleHRzLmZvckVhY2goKHQsaW5kZXgpPT5zdGF0ZS5wbGF5ZXJNb3ZlZFRpbWVbaW5kZXhdICYmIHQuc2V0VGV4dChmb3JtYXRUaW1lKCAgc3RhdGUucGxheWVyTW92ZWRUaW1lW2luZGV4XSAtIHN0YXRlLmFwcGVhclRpbWUpKSk7XG5cbiAgICAgICAgICAgIHN0YXRlLnJlc29sdmluZ1dpbm5lciA9IHRydWU7XG4gICAgICAgICAgICBnYW1lLnBsYXllcnNbd2lubmVySW5kZXhdLnNldFBsYXllclNjb3JlKCsrc3RhdGUuc2NvcmVbd2lubmVySW5kZXhdKTtcbiAgICAgICAgICAgIHRlYWNoZXJzW3dpbm5lckluZGV4XS5hcHBseUZyYW1lKDIpO1xuICAgICAgICAgICAgdGVhY2hlcnNbd2lubmVySW5kZXg/MDoxXS5hcHBseUZyYW1lKDEpO1xuICAgICAgICAgICAgYXdhaXQgZ2FtZS53YWl0RnJhbWVzKDIwKTtcbiAgICAgICAgICAgIHRlYWNoZXJzW3dpbm5lckluZGV4XS5hcHBseUZyYW1lKDMpO1xuICAgICAgICAgICAgdXBkYXRlU2NvcmVUZXh0Q29tcG9uZW50KCk7XG4gICAgICAgICAgICBhd2FpdCBnYW1lLndhaXRGcmFtZXMoNjApO1xuICAgICAgICAgICAgZ2VuZXJhdGVRdWVzdGlvbigpO1xuICAgICAgICAgICAgZ2FtZS5jaGVja1dpbm5lcnMoKTtcbiAgICAgICAgICAgIGN1cnNvcnMuZm9yRWFjaCgoXywgcGxheWVySW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICBjdXJzb3JzW3BsYXllckluZGV4XS5zZXRQaXhlbFBvc2l0aW9uKC4uLkNVUlNPUl9QT1NJVElPTlNbcGxheWVySW5kZXhdW3N0YXRlLnBsYXllckN1cnNvckluZGV4W3BsYXllckluZGV4XV0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdlbmVyYXRlUXVlc3Rpb24oKXtcbiAgICAgICAgY29uc29sZS5sb2coXCJnZW5lcmF0ZVF1ZXN0aW9uXCIpO1xuICAgICAgICB0aW1lVGV4dHMuZm9yRWFjaCgodCxpbmRleCk9PnQuc2V0VGV4dChmb3JtYXRUaW1lKCAgMCkpKTtcbiAgICAgICAgc3RhdGUuZmlyc3RNb3ZlUmVjZWl2ZWRBdEZyYW1lID0gMDtcbiAgICAgICAgc3RhdGUuc2hvd2luZ1F1ZXN0aW9uID0gZmFsc2U7XG4gICAgICAgIHN0YXRlLmFwcGVhclRpbWUgPSBNYXRoLmZsb29yKGdhbWUucnVudGltZS5nZXRTdGF0ZSgpLmxhc3RSZXByb2R1Y2VkRnJhbWUgKiAoMTAwMC82MCkpOy8vVE9ETyBpbXBsZW1lbnQgZ2FtZS5ub3cgPSAoKSA9PiBnYW1lLnJ1bnRpbWUuZ2V0U3RhdGUoKS5sYXN0UmVwcm9kdWNlZEZyYW1lICogKDEwMDAvNjApXG4gICAgICAgIHN0YXRlLnBsYXllck1vdmVkVGltZVswXSA9IHN0YXRlLnBsYXllck1vdmVkVGltZVsxXSA9IDA7XG4gICAgICAgIHN0YXRlLm51bTEgPSBnYW1lLnJhbmRvbUludCgwLDUwKTtcbiAgICAgICAgc3RhdGUubnVtMiA9IGdhbWUucmFuZG9tSW50KDAsNTApO1xuICAgICAgICBzdGF0ZS5zb2x1dGlvbiA9IHN0YXRlLm51bTEgKyBzdGF0ZS5udW0yO1xuICAgICAgICBzdGF0ZS5zb2x1dGlvbkluZGV4ID0gZ2FtZS5yYW5kb21JbnQoMCw1KTtcbiAgICAgICAgc3RhdGUucmVzb2x2aW5nV2lubmVyID0gZmFsc2U7XG5cbiAgICAgICAgY29uc3Qgc29sdXRpb25NaW51cyA9IHN0YXRlLnNvbHV0aW9uIC0gMTtcbiAgICAgICAgY29uc3Qgc29sdXRpb25NaW51c0luZGV4ID0gcmFuZG9tSW50RXhjZXB0KDAsNSwgW3N0YXRlLnNvbHV0aW9uSW5kZXhdKTtcbiAgICAgICAgY29uc3Qgc29sdXRpb25NaW51czEwID0gc3RhdGUuc29sdXRpb24gLSAxMDtcbiAgICAgICAgY29uc3Qgc29sdXRpb25NaW51czEwSW5kZXggPSByYW5kb21JbnRFeGNlcHQoMCw1LCBbc3RhdGUuc29sdXRpb25JbmRleCwgc29sdXRpb25NaW51c0luZGV4XSk7XG4gICAgICAgIGNvbnN0IHNvbHV0aW9uUGx1czEwID0gc3RhdGUuc29sdXRpb24gKyAxMDtcbiAgICAgICAgY29uc3Qgc29sdXRpb25QbHVzMTBJbmRleCA9IHJhbmRvbUludEV4Y2VwdCgwLDUsIFtzdGF0ZS5zb2x1dGlvbkluZGV4LCBzb2x1dGlvbk1pbnVzSW5kZXgsIHNvbHV0aW9uTWludXMxMEluZGV4XSk7XG4gICAgICAgIHN0YXRlLnNob3dpbmdRdWVzdGlvbiA9IHRydWU7XG4gICAgICAgIHF1ZXN0aW9uVGV4dC5zZXRUZXh0KCBgJHtzdGF0ZS5udW0xfSArICR7c3RhdGUubnVtMn1gICk7XG4gICAgICAgIGFuc3dlclRleHRzLmZvckVhY2goKGFuc3dlclRleHQsIGluZGV4KT0+e1xuICAgICAgICAgICAgaWYoaW5kZXggPT09IHN0YXRlLnNvbHV0aW9uSW5kZXgpIHtcbiAgICAgICAgICAgICAgICBhbnN3ZXJUZXh0LnNldFRleHQoc3RhdGUuYW5zd2VyVmFsdWVzW2luZGV4XSA9IHN0YXRlLnNvbHV0aW9uKTtcbiAgICAgICAgICAgIH1lbHNlIGlmKGluZGV4ID09PSBzb2x1dGlvbk1pbnVzSW5kZXgpe1xuICAgICAgICAgICAgICAgIGFuc3dlclRleHQuc2V0VGV4dChzdGF0ZS5hbnN3ZXJWYWx1ZXNbaW5kZXhdID0gTWF0aC5tYXgoMSwgc29sdXRpb25NaW51cykpO1xuICAgICAgICAgICAgfWVsc2UgaWYoaW5kZXggPT09IHNvbHV0aW9uTWludXMxMEluZGV4KSB7XG4gICAgICAgICAgICAgICAgYW5zd2VyVGV4dC5zZXRUZXh0KHN0YXRlLmFuc3dlclZhbHVlc1tpbmRleF0gPSBNYXRoLm1heCgxLCBzb2x1dGlvbk1pbnVzMTApKTtcbiAgICAgICAgICAgIH1lbHNlIGlmKGluZGV4ID09PSBzb2x1dGlvblBsdXMxMEluZGV4KXtcbiAgICAgICAgICAgICAgICBhbnN3ZXJUZXh0LnNldFRleHQoc3RhdGUuYW5zd2VyVmFsdWVzW2luZGV4XSA9IE1hdGgubWF4KDEsIHNvbHV0aW9uUGx1czEwKSk7XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICBhbnN3ZXJUZXh0LnNldFRleHQoc3RhdGUuYW5zd2VyVmFsdWVzW2luZGV4XSA9IHJhbmRvbUludEV4Y2VwdCgwLDEwMCxzdGF0ZS5hbnN3ZXJWYWx1ZXMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRlYWNoZXJzLmZvckVhY2godD0+dC5hcHBseUZyYW1lKDApKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByYW5kb21JbnRFeGNlcHQobWluOm51bWJlciAsbWF4Om51bWJlciwgZXhjZXB0aW9uczpudW1iZXJbXSl7XG4gICAgICAgIGxldCByZXN1bHQgPSBnYW1lLnJhbmRvbUludChtaW4sIG1heCk7XG5cbiAgICAgICAgd2hpbGUoZXhjZXB0aW9ucy5pbmRleE9mKHJlc3VsdCkgPj0gMCl7XG4gICAgICAgICAgICByZXN1bHQgPSBnYW1lLnJhbmRvbUludChtaW4sIG1heCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbn1cblxuY29uc3QgZGVmaW5pdGlvbiA9IHtcbiAgICBhbGlhczpcIm1hdGgtZ2FtZVwiLFxuICAgIHNwbGl0OmZhbHNlLFxuICAgIGZwczo2MCxcbiAgICBpbnN0cnVjdGlvbnM6XCJTZWxlY3QgY29ycmVjdCBhbnN3ZXJcIlxufTtcblxuY29uc3QgTWF0aEdhbWUgPSB7ZGVmaW5pdGlvbiwgcnVufTtcblxuXG5leHBvcnQge01hdGhHYW1lfVxuXG5mdW5jdGlvbiBmb3JtYXRUaW1lKHRpbWU6bnVtYmVyKXtcbiAgICBpZighdGltZSkgcmV0dXJuIFwiXCI7XG4gICAgcmV0dXJuIGAke01hdGguZmxvb3IodGltZS8xMDAwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsXCIwXCIpfTokeyh0aW1lJTEwMDApLnRvU3RyaW5nKCkucGFkU3RhcnQoMyxcIjBcIil9YDtcbn0iXX0=
import { boxCollision } from "../lib/math-util";
const SPRITE_SIZE = { w: 8, h: 8 };
const SPRITE_SHEET_SIZE = 1024;
const SPRITE_SHEET_DIMENSION = {
    spriteSheetWidth: SPRITE_SHEET_SIZE,
    spriteSheetHeight: SPRITE_SHEET_SIZE,
};
const SAMMICH_POSITIONS = [
    12,
    28,
    44,
    60,
    76,
];
const INPUT_LEFT = 1;
const INPUT_RIGHT = 2;
const INPUT_FORWARD = 0;
const FROG_INITIAL_POSITION = [4 + 8 * 5, 8 + 8 * 11];
const MIN_FROG_POS_X = 4 + 8 * 1;
const MAX_FROG_POS_X = 4 + 8 * 10;
const MIN_CAR_POS_X = MIN_FROG_POS_X - 16;
const MAX_CAR_POS_X = MAX_FROG_POS_X + 8;
async function run({ game }) {
    const state = {
        moving: false,
        takingBurger: false,
        collision: false
    };
    game.setScreenSprite({
        spriteDefinition: {
            x: 768,
            y: 128,
            w: 192 / 2,
            h: 128,
            ...SPRITE_SHEET_DIMENSION
        }
    });
    game.setWinnerFn((player1Score, player2Score) => {
        console.log("FROG_CHECK_WINNER", player1Score, player2Score);
        if (player1Score === player2Score)
            return;
        const msPassed = game.runtime.getState().lastReproducedFrame * (1000 / 60);
        const secondsPassed = Math.floor(msPassed / 1000);
        if ((secondsPassed > 100 && player1Score !== player2Score)
            || Math.max(player1Score, player2Score) === 5) {
            if (player1Score > player2Score)
                return { winnerIndex: 0 };
            if (player1Score < player2Score)
                return { winnerIndex: 1 };
        }
    });
    const CarSprite = game.registerSpriteEntity({
        klass: "Car",
        spriteDefinition: {
            x: 24, y: 528, w: 8, h: 8, columns: 1, frames: 1,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const CursorSprite = game.registerSpriteEntity({
        klass: "Frog",
        spriteDefinition: {
            x: 0, y: 528, w: 8, h: 8, columns: 1, frames: 2,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const BurgerSprite = game.registerSpriteEntity({
        klass: "Burguer",
        spriteDefinition: {
            x: 8, y: 528, w: 8, h: 8,
            ...SPRITE_SHEET_DIMENSION,
        }
    });
    const burgers = SAMMICH_POSITIONS.map(px => {
        return BurgerSprite.create({
            pixelPosition: [px, 5],
            layer: 1
        });
    });
    const frog = CursorSprite.create({
        pixelPosition: [...FROG_INITIAL_POSITION],
        layer: 2,
        network: true,
        frame: 0
    });
    game.onInput(async ({ inputActionKey, isPressed, time, playerIndex }) => {
        if (!isPressed || state.moving || state.collision || state.takingBurger)
            return;
        let [x, y] = frog.getPixelPosition();
        if (inputActionKey === INPUT_LEFT) {
            if (x <= MIN_FROG_POS_X)
                return;
            state.moving = true;
            frog.setPixelPosition(x - 4, y);
            await animateFrog();
            frog.setPixelPosition(x - 8, y);
            state.moving = false;
        }
        else if (inputActionKey === INPUT_RIGHT) {
            state.moving = true;
            if (x >= MAX_FROG_POS_X)
                return;
            frog.setPixelPosition(x + 4, y);
            await animateFrog();
            frog.setPixelPosition(x + 8, y);
            state.moving = false;
        }
        else if (inputActionKey === INPUT_FORWARD) {
            state.moving = true;
            frog.setPixelPosition(x, y - 4);
            await animateFrog();
            frog.setPixelPosition(x, y - 8);
            if (y <= 16) {
                checkBurgers();
                resetFrog();
            }
            state.moving = false;
        }
        game.checkWinners();
        function checkBurgers() {
            [x, y] = frog.getPixelPosition();
            const foundBurger = SAMMICH_POSITIONS.findIndex(i => i === x);
            if (~foundBurger) {
                burgers[foundBurger].sprite.hide();
                game.setPlayerScore(game.getPlayerScore() + 1);
                state.takingBurger = true;
            }
        }
    });
    game.onFrame(async (n) => carTracks.forEach((c) => c.frame(n)));
    const carTracks = [1, 2, 3, 4, 5, 7, 8, 9, 10].map(track => createCarPool(game, track));
    function createCarPool(game, track = 1) {
        const carPoolState = {
            countDt: 0,
            nextCarAt: Number.MAX_VALUE,
            currentPoolIndex: 0
        };
        const NUM_CARS = game.randomInt(1, 3);
        const velocity = game.randomInt(2, 8);
        const CAR_SIZE = 8;
        let cancel, iterations = 0;
        const direction = game.randomInt(0, 1) ? 1 : -1;
        const spawnsX = Array(NUM_CARS).fill(null).reduce((acc, current) => {
            let x = game.randomInt(1, 7) * 10;
            while (!cancel && acc.find((xx) => (xx) - (x) < ((CAR_SIZE) + 1))) {
                x = game.randomInt(1, 7) * 10;
                iterations++;
                if (iterations > 10000) {
                    console.error("Tell the author he did something wrong in the code", iterations);
                    cancel = true;
                }
            }
            acc.push(x);
            return acc;
        }, []);
        const pool = spawnsX.map((v, index) => {
            return CarSprite.create({
                pixelPosition: [v, 8 + 8 * track],
                frame: 1,
                layer: 2,
            });
        });
        return {
            frame: (n) => {
                carPoolState.countDt++;
                if (carPoolState.countDt > velocity) {
                    carPoolState.countDt = 0;
                    pool.forEach((car, index) => {
                        const [x, y] = car.getPixelPosition();
                        if (x > MAX_CAR_POS_X || x < MIN_CAR_POS_X) {
                            car.setPixelPosition(direction > 0 ? MIN_CAR_POS_X : MAX_CAR_POS_X, y);
                        }
                        else {
                            car.setPixelPosition(x + direction, y);
                        }
                        const [fx, fy] = frog.getPixelPosition();
                        const [cx, cy] = car.getPixelPosition();
                        if (!state.collision && boxCollision({ x: fx, y: fy, ...SPRITE_SIZE }, { x: cx, y: cy, ...SPRITE_SIZE })) {
                            console.log("COLLISITON", state.collision);
                            state.collision = true;
                            resetFrog();
                        }
                    });
                }
            }
        };
    }
    async function resetFrog() {
        await game.waitFrames(60);
        frog.setPixelPosition(...FROG_INITIAL_POSITION);
        state.moving = false;
        state.collision = false;
        state.takingBurger = false;
        console.log("COLLISITON reste");
    }
    async function animateFrog() {
        frog.applyFrame(1);
        await game.waitFrames(4);
        frog.applyFrame(0);
    }
}
const definition = {
    alias: "frog-game",
    split: true,
    fps: 60,
    instructions: "play with frog"
};
const FrogGame = { definition, run };
export { FrogGame };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJvZy1nYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vZ2FtZXMvZnJvZy1nYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxNQUFNLFdBQVcsR0FBRyxFQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDO0FBQzlCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDO0FBQy9CLE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsZ0JBQWdCLEVBQUUsaUJBQWlCO0lBQ25DLGlCQUFpQixFQUFFLGlCQUFpQjtDQUN2QyxDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRztJQUN0QixFQUFFO0lBQ0YsRUFBRTtJQUNGLEVBQUU7SUFDRixFQUFFO0lBQ0YsRUFBRTtDQUNMLENBQUM7QUFDRixNQUFNLFVBQVUsSUFBMEIsQ0FBQztBQUMzQyxNQUFNLFdBQVcsSUFBNEIsQ0FBQztBQUM5QyxNQUFNLGFBQWEsSUFBeUIsQ0FBQztBQUM3QyxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUNwRCxNQUFNLGNBQWMsR0FBRSxDQUFDLEdBQUcsQ0FBQyxHQUFDLENBQUMsQ0FBQztBQUM5QixNQUFNLGNBQWMsR0FBRSxDQUFDLEdBQUcsQ0FBQyxHQUFDLEVBQUUsQ0FBQztBQUMvQixNQUFNLGFBQWEsR0FBRyxjQUFjLEdBQUcsRUFBRSxDQUFDO0FBQzFDLE1BQU0sYUFBYSxHQUFHLGNBQWMsR0FBRyxDQUFDLENBQUM7QUFFekMsS0FBSyxVQUFVLEdBQUcsQ0FBQyxFQUFDLElBQUksRUFBSztJQUN6QixNQUFNLEtBQUssR0FBRztRQUNWLE1BQU0sRUFBQyxLQUFLO1FBQ1osWUFBWSxFQUFDLEtBQUs7UUFDbEIsU0FB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Q0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLHFCQUFxQixDQUFDLENBQUM7UUFDaEQsS0FBSyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDckIsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDeEIsS0FBSyxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFFRCxLQUFLLFVBQVUsV0FBVztRQUN0QixJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7QUFDTCxDQUFDO0FBR0QsTUFBTSxVQUFVLEdBQUc7SUFDZixLQUFLLEVBQUMsV0FBVztJQUNqQixLQUFLLEVBQUMsSUFBSTtJQUNWLEdBQUcsRUFBQyxFQUFFO0lBQ04sWUFBWSxFQUFDLGdCQUFnQjtDQUNoQyxDQUFDO0FBRUYsTUFBTSxRQUFRLEdBQUcsRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFDLENBQUM7QUFHbkMsT0FBTyxFQUFDLFFBQVEsRUFBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbnB1dEFjdGlvbn0gZnJvbSBcIkBkY2wvc2RrL2Vjc1wiO1xuaW1wb3J0IHtTcHJpdGVFbnRpdHl9IGZyb20gXCIuLi9saWIvZ2FtZS1lbnRpdGllc1wiO1xuaW1wb3J0IHtib3hDb2xsaXNpb259IGZyb20gXCIuLi9saWIvbWF0aC11dGlsXCI7XG5jb25zdCBTUFJJVEVfU0laRSA9IHt3OjgsaDo4fTtcbmNvbnN0IFNQUklURV9TSEVFVF9TSVpFID0gMTAyNDtcbmNvbnN0IFNQUklURV9TSEVFVF9ESU1FTlNJT04gPSB7XG4gICAgc3ByaXRlU2hlZXRXaWR0aDogU1BSSVRFX1NIRUVUX1NJWkUsXG4gICAgc3ByaXRlU2hlZXRIZWlnaHQ6IFNQUklURV9TSEVFVF9TSVpFLFxufTtcbmNvbnN0IFNBTU1JQ0hfUE9TSVRJT05TID0gW1xuICAgIDEyLFxuICAgIDI4LFxuICAgIDQ0LFxuICAgIDYwLFxuICAgIDc2LFxuXTtcbmNvbnN0IElOUFVUX0xFRlQgPSAgSW5wdXRBY3Rpb24uSUFfUFJJTUFSWTtcbmNvbnN0IElOUFVUX1JJR0hUID0gIElucHV0QWN0aW9uLklBX1NFQ09OREFSWTtcbmNvbnN0IElOUFVUX0ZPUldBUkQgPSBJbnB1dEFjdGlvbi5JQV9QT0lOVEVSO1xuY29uc3QgRlJPR19JTklUSUFMX1BPU0lUSU9OID0gWzQgKyA4KjUsIDggKyA4ICogMTFdO1xuY29uc3QgTUlOX0ZST0dfUE9TX1ggPTQgKyA4KjE7XG5jb25zdCBNQVhfRlJPR19QT1NfWCA9NCArIDgqMTA7XG5jb25zdCBNSU5fQ0FSX1BPU19YID0gTUlOX0ZST0dfUE9TX1ggLSAxNjtcbmNvbnN0IE1BWF9DQVJfUE9TX1ggPSBNQVhfRlJPR19QT1NfWCArIDg7XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1bih7Z2FtZX06YW55KXtcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgICAgbW92aW5nOmZhbHNlLFxuICAgICAgICB0YWtpbmdCdXJnZXI6ZmFsc2UsXG4gICAgICAgIGNvbGxpc2lvbjpmYWxzZVxuICAgIH1cbiAgICBnYW1lLnNldFNjcmVlblNwcml0ZSh7XG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDo3NjgsXG4gICAgICAgICAgICB5OjEyOCxcbiAgICAgICAgICAgIHc6MTkyLzIsXG4gICAgICAgICAgICBoOjEyOCxcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT05cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgZ2FtZS5zZXRXaW5uZXJGbigocGxheWVyMVNjb3JlOm51bWJlciwgcGxheWVyMlNjb3JlOm51bWJlcikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkZST0dfQ0hFQ0tfV0lOTkVSXCIsIHBsYXllcjFTY29yZSwgcGxheWVyMlNjb3JlKTtcblxuICAgICAgICBpZihwbGF5ZXIxU2NvcmUgPT09IHBsYXllcjJTY29yZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG1zUGFzc2VkID0gZ2FtZS5ydW50aW1lLmdldFN0YXRlKCkubGFzdFJlcHJvZHVjZWRGcmFtZSAqICgxMDAwLzYwKTtcbiAgICAgICAgY29uc3Qgc2Vjb25kc1Bhc3NlZCA9IE1hdGguZmxvb3IobXNQYXNzZWQvMTAwMCk7XG5cbiAgICAgICAgaWYoXG4gICAgICAgICAgICAoc2Vjb25kc1Bhc3NlZCA+IDEwMCAmJiBwbGF5ZXIxU2NvcmUgIT09IHBsYXllcjJTY29yZSlcbiAgICAgICAgICAgIHx8IE1hdGgubWF4KHBsYXllcjFTY29yZSxwbGF5ZXIyU2NvcmUpID09PSA1XG4gICAgICAgICl7XG4gICAgICAgICAgICBpZihwbGF5ZXIxU2NvcmUgPiBwbGF5ZXIyU2NvcmUpIHJldHVybiB7d2lubmVySW5kZXg6MH07XG4gICAgICAgICAgICBpZihwbGF5ZXIxU2NvcmUgPCBwbGF5ZXIyU2NvcmUpIHJldHVybiB7d2lubmVySW5kZXg6MX07XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBDYXJTcHJpdGUgPSBnYW1lLnJlZ2lzdGVyU3ByaXRlRW50aXR5KHtcbiAgICAgICAga2xhc3M6XCJDYXJcIixcbiAgICAgICAgc3ByaXRlRGVmaW5pdGlvbjp7XG4gICAgICAgICAgICB4OjI0LHk6NTI4LCB3OjgsIGg6OCwgY29sdW1uczoxLCBmcmFtZXM6MSxcbiAgICAgICAgICAgIC4uLlNQUklURV9TSEVFVF9ESU1FTlNJT04sXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBDdXJzb3JTcHJpdGUgPSBnYW1lLnJlZ2lzdGVyU3ByaXRlRW50aXR5KHtcbiAgICAgICAga2xhc3M6XCJGcm9nXCIsXG4gICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICAgeDowLHk6NTI4LCB3OjgsIGg6OCwgY29sdW1uczoxLGZyYW1lczoyLFxuICAgICAgICAgICAgLi4uU1BSSVRFX1NIRUVUX0RJTUVOU0lPTixcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IEJ1cmdlclNwcml0ZSA9IGdhbWUucmVnaXN0ZXJTcHJpdGVFbnRpdHkoe1xuICAgICAgIGtsYXNzOlwiQnVyZ3VlclwiLFxuICAgICAgIHNwcml0ZURlZmluaXRpb246e1xuICAgICAgICAgICB4OjgseTo1MjgsIHc6OCwgaDo4LFxuICAgICAgICAgICAuLi5TUFJJVEVfU0hFRVRfRElNRU5TSU9OLFxuICAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBidXJnZXJzID0gU0FNTUlDSF9QT1NJVElPTlMubWFwKHB4PT57XG4gICAgICAgIHJldHVybiBCdXJnZXJTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgICAgIHBpeGVsUG9zaXRpb246W3B4LDVdLFxuICAgICAgICAgICAgbGF5ZXI6MVxuICAgICAgICB9KVxuICAgIH0pO1xuICAgIGNvbnN0IGZyb2cgPSBDdXJzb3JTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgcGl4ZWxQb3NpdGlvbjpbLi4uRlJPR19JTklUSUFMX1BPU0lUSU9OXSxcbiAgICAgICAgbGF5ZXI6MixcbiAgICAgICAgbmV0d29yazp0cnVlLFxuICAgICAgICBmcmFtZTowXG4gICAgfSk7XG5cbiAgICBnYW1lLm9uSW5wdXQoYXN5bmMgKHtpbnB1dEFjdGlvbktleSwgaXNQcmVzc2VkLCB0aW1lLCBwbGF5ZXJJbmRleH06YW55KT0+e1xuICAgICAgICBpZighaXNQcmVzc2VkIHx8IHN0YXRlLm1vdmluZyB8fCBzdGF0ZS5jb2xsaXNpb24gfHwgc3RhdGUudGFraW5nQnVyZ2VyKSByZXR1cm47XG4gICAgICAgIGxldCBbeCx5XSA9IGZyb2cuZ2V0UGl4ZWxQb3NpdGlvbigpO1xuICAgICAgICBpZihpbnB1dEFjdGlvbktleSA9PT0gSU5QVVRfTEVGVCl7XG4gICAgICAgICAgICBpZih4IDw9IE1JTl9GUk9HX1BPU19YKSByZXR1cm47XG4gICAgICAgICAgICBzdGF0ZS5tb3ZpbmcgPSB0cnVlO1xuICAgICAgICAgICAgZnJvZy5zZXRQaXhlbFBvc2l0aW9uKFxuICAgICAgICAgICAgICAgIHgtNCxcbiAgICAgICAgICAgICAgICB5XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYXdhaXQgYW5pbWF0ZUZyb2coKTtcbiAgICAgICAgICAgIGZyb2cuc2V0UGl4ZWxQb3NpdGlvbihcbiAgICAgICAgICAgICAgICB4LTgsXG4gICAgICAgICAgICAgICAgeVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHN0YXRlLm1vdmluZyA9IGZhbHNlO1xuICAgICAgICB9ZWxzZSBpZihpbnB1dEFjdGlvbktleSA9PT0gSU5QVVRfUklHSFQpe1xuICAgICAgICAgICAgc3RhdGUubW92aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmKHggPj0gTUFYX0ZST0dfUE9TX1gpIHJldHVybjtcbiAgICAgICAgICAgIGZyb2cuc2V0UGl4ZWxQb3NpdGlvbihcbiAgICAgICAgICAgICAgICB4KzQsXG4gICAgICAgICAgICAgICAgeVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGF3YWl0IGFuaW1hdGVGcm9nKCk7XG4gICAgICAgICAgICBmcm9nLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgeCs4LFxuICAgICAgICAgICAgICAgIHlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBzdGF0ZS5tb3ZpbmcgPSBmYWxzZTtcbiAgICAgICAgfWVsc2UgaWYoaW5wdXRBY3Rpb25LZXkgPT09IElOUFVUX0ZPUldBUkQpe1xuICAgICAgICAgICAgc3RhdGUubW92aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIGZyb2cuc2V0UGl4ZWxQb3NpdGlvbihcbiAgICAgICAgICAgICAgICB4LFxuICAgICAgICAgICAgICAgIHktNFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGF3YWl0IGFuaW1hdGVGcm9nKCk7XG4gICAgICAgICAgICBmcm9nLnNldFBpeGVsUG9zaXRpb24oXG4gICAgICAgICAgICAgICAgeCxcbiAgICAgICAgICAgICAgICB5LThcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZih5IDw9IDE2KXtcbiAgICAgICAgICAgICAgICBjaGVja0J1cmdlcnMoKTtcbiAgICAgICAgICAgICAgICByZXNldEZyb2coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLm1vdmluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGdhbWUuY2hlY2tXaW5uZXJzKCk7XG5cbiAgICAgICAgZnVuY3Rpb24gY2hlY2tCdXJnZXJzKCl7XG4gICAgICAgICAgICBbeCx5XSA9IGZyb2cuZ2V0UGl4ZWxQb3NpdGlvbigpO1xuICAgICAgICAgICAgY29uc3QgZm91bmRCdXJnZXIgPSBTQU1NSUNIX1BPU0lUSU9OUy5maW5kSW5kZXgoaT0+aT09PXgpO1xuICAgICAgICAgICAgaWYofmZvdW5kQnVyZ2VyKXtcbiAgICAgICAgICAgICAgICBidXJnZXJzW2ZvdW5kQnVyZ2VyXS5zcHJpdGUuaGlkZSgpO1xuICAgICAgICAgICAgICAgIGdhbWUuc2V0UGxheWVyU2NvcmUoZ2FtZS5nZXRQbGF5ZXJTY29yZSgpKzEpO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRha2luZ0J1cmdlciA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGdhbWUub25GcmFtZShhc3luYyAobjpudW1iZXIpPT5cbiAgICAgICAgY2FyVHJhY2tzLmZvckVhY2goKGM6YW55KT0+XG4gICAgICAgICAgICBjLmZyYW1lKG4pKSk7XG5cbiAgICBjb25zdCBjYXJUcmFja3MgPSBbMSwyLDMsNCw1LDcsOCw5LDEwXS5tYXAodHJhY2sgPT4gY3JlYXRlQ2FyUG9vbChnYW1lLCB0cmFjaykpO1xuXG4gICAgZnVuY3Rpb24gY3JlYXRlQ2FyUG9vbChnYW1lOmFueSx0cmFjazpudW1iZXIgPSAxKXtcbiAgICAgICAgY29uc3QgY2FyUG9vbFN0YXRlID0ge1xuICAgICAgICAgICAgY291bnREdDowLFxuICAgICAgICAgICAgbmV4dENhckF0Ok51bWJlci5NQVhfVkFMVUUsXG4gICAgICAgICAgICBjdXJyZW50UG9vbEluZGV4OjBcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgTlVNX0NBUlMgPSBnYW1lLnJhbmRvbUludCgxLDMpO1xuXG4gICAgICAgIGNvbnN0IHZlbG9jaXR5ID0gZ2FtZS5yYW5kb21JbnQoMiw4KTtcbiAgICAgICAgY29uc3QgQ0FSX1NJWkUgPSA4O1xuICAgICAgICBsZXQgY2FuY2VsOmFueSwgaXRlcmF0aW9ucyA9IDA7XG4gICAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IGdhbWUucmFuZG9tSW50KDAsMSkgPyAxIDogLTE7XG4gICAgICAgIGNvbnN0IHNwYXduc1ggPSBBcnJheShOVU1fQ0FSUykuZmlsbChudWxsKS5yZWR1Y2UoKGFjYywgY3VycmVudCk9PntcbiAgICAgICAgICAgIGxldCB4ID0gZ2FtZS5yYW5kb21JbnQoMSwgNykqMTA7XG4gICAgICAgICAgICB3aGlsZSghY2FuY2VsICYmIGFjYy5maW5kKCh4eDpudW1iZXIpPT4oeHgpIC0gKHgpIDwgKChDQVJfU0laRSkrMSkpKXtcbiAgICAgICAgICAgICAgICB4ID0gZ2FtZS5yYW5kb21JbnQoMSwgNykqMTA7XG5cbiAgICAgICAgICAgICAgICBpdGVyYXRpb25zKys7XG4gICAgICAgICAgICAgICAgaWYoaXRlcmF0aW9ucyA+IDEwMDAwKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlRlbGwgdGhlIGF1dGhvciBoZSBkaWQgc29tZXRoaW5nIHdyb25nIGluIHRoZSBjb2RlXCIsIGl0ZXJhdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFjYy5wdXNoKHgpO1xuXG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LFtdKTtcblxuICAgICAgICBjb25zdCBwb29sID0gc3Bhd25zWC5tYXAoKHY6bnVtYmVyLGluZGV4Om51bWJlcik9PntcbiAgICAgICAgICAgIHJldHVybiBDYXJTcHJpdGUuY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBwaXhlbFBvc2l0aW9uOlt2LCA4ICsgOCAqIHRyYWNrXSxcbiAgICAgICAgICAgICAgICBmcmFtZToxLFxuICAgICAgICAgICAgICAgIGxheWVyOjIsXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZnJhbWU6KG46bnVtYmVyKT0+e1xuICAgICAgICAgICAgICAgIGNhclBvb2xTdGF0ZS5jb3VudER0Kys7XG4gICAgICAgICAgICAgICAgaWYoY2FyUG9vbFN0YXRlLmNvdW50RHQgPiB2ZWxvY2l0eSl7XG4gICAgICAgICAgICAgICAgICAgIGNhclBvb2xTdGF0ZS5jb3VudER0ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgcG9vbC5mb3JFYWNoKChjYXI6U3ByaXRlRW50aXR5LCBpbmRleDpudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFt4LHldID0gY2FyLmdldFBpeGVsUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHggPiBNQVhfQ0FSX1BPU19YIHx8IHggPCBNSU5fQ0FSX1BPU19YKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXIuc2V0UGl4ZWxQb3NpdGlvbihkaXJlY3Rpb24gPiAwID8gTUlOX0NBUl9QT1NfWCA6IE1BWF9DQVJfUE9TX1gsIHkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXIuc2V0UGl4ZWxQb3NpdGlvbih4K2RpcmVjdGlvbiwgeSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFtmeCxmeV0gPSBmcm9nLmdldFBpeGVsUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFtjeCAsY3ldID0gY2FyLmdldFBpeGVsUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFzdGF0ZS5jb2xsaXNpb24gJiYgYm94Q29sbGlzaW9uKHt4OmZ4LCB5OmZ5LC4uLlNQUklURV9TSVpFfSx7eDpjeCwgeTpjeSwuLi5TUFJJVEVfU0laRX0pKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNPTExJU0lUT05cIixzdGF0ZS5jb2xsaXNpb24pXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jb2xsaXNpb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0RnJvZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgZnVuY3Rpb24gcmVzZXRGcm9nKCl7XG4gICAgICAgIGF3YWl0IGdhbWUud2FpdEZyYW1lcyg2MCk7XG4gICAgICAgIGZyb2cuc2V0UGl4ZWxQb3NpdGlvbiguLi5GUk9HX0lOSVRJQUxfUE9TSVRJT04pO1xuICAgICAgICBzdGF0ZS5tb3ZpbmcgPSBmYWxzZTtcbiAgICAgICAgc3RhdGUuY29sbGlzaW9uID0gZmFsc2U7XG4gICAgICAgIHN0YXRlLnRha2luZ0J1cmdlciA9IGZhbHNlO1xuICAgICAgICBjb25zb2xlLmxvZyhcIkNPTExJU0lUT04gcmVzdGVcIilcbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBhbmltYXRlRnJvZygpe1xuICAgICAgICBmcm9nLmFwcGx5RnJhbWUoMSk7XG4gICAgICAgIGF3YWl0IGdhbWUud2FpdEZyYW1lcyg0KTtcbiAgICAgICAgZnJvZy5hcHBseUZyYW1lKDApO1xuICAgIH1cbn1cblxuXG5jb25zdCBkZWZpbml0aW9uID0ge1xuICAgIGFsaWFzOlwiZnJvZy1nYW1lXCIsXG4gICAgc3BsaXQ6dHJ1ZSxcbiAgICBmcHM6NjAsXG4gICAgaW5zdHJ1Y3Rpb25zOlwicGxheSB3aXRoIGZyb2dcIlxufTtcblxuY29uc3QgRnJvZ0dhbWUgPSB7ZGVmaW5pdGlvbiwgcnVufTtcblxuXG5leHBvcnQge0Zyb2dHYW1lfVxuIl19